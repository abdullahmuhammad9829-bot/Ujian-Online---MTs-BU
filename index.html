<!DOCTYPE html>
<html lang="id">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ujian Online V.3 | Ujian Online</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      svg: {
        fontCache: 'global'
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" id="MathJax-script"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCYUnvmqybf2mnj7z1emLjWh8WzoMV7XbQ",
      authDomain: "ppdb-online-mts.firebaseapp.com",
      databaseURL: "https://ppdb-online-mts-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ppdb-online-mts",
      storageBucket: "ppdb-online-mts.firebasestorage.app",
      messagingSenderId: "1001311249780",
      appId: "1:1001311249780:web:b1f0e1aeb12abd01e4f821"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
  </script>

  
<style>
  /* --- FONTS & GLOBAL --- */
  body {
    font-family: 'Inter', sans-serif;
    background-color: #f8fafc; /* Slate 50 */
    color: #334155; /* Slate 700 */
    user-select: none;
    overflow-x: hidden;
  }

  h1, h2, h3, h4, h5, h6, .font-heading {
    font-family: 'Poppins', sans-serif;
  }

  /* --- UTILITIES --- */
  .glass {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
  }

  .fade-in {
    animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Custom Scrollbar */
  ::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }
  
  ::-webkit-scrollbar-track {
    background: transparent;
  }
  
  ::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  /* --- SIDEBAR STYLES --- */
  .sidebar-bg {
    background: #2b369e; /* Warna baru sesuai permintaan */
    border-right: 1px solid rgba(0, 0, 0, 0.1);
    color: #e0e7ff; /* Indigo-50 */
  }

  .sidebar-item {
    position: relative;
    display: flex;
    align-items: center;
    padding: 12px 16px;
    margin-bottom: 4px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    overflow: hidden;
    white-space: nowrap;
    font-weight: 500;
    font-size: 0.9rem;
  }

  .sidebar-item:hover {
    background: rgba(255, 255, 255, 0.08);
    color: #f1f5f9;
  }

  .sidebar-item.active {
    background: #2563eb; /* Blue 600 */
    color: #fff;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
  }

  .sidebar-item i {
    width: 24px;
    text-align: center;
    margin-right: 12px;
    font-size: 1.1rem;
    flex-shrink: 0;
    transition: transform 0.2s;
  }

  .sidebar-item:hover i {
    transform: scale(1.1);
  }

  /* Logika Collapse Sidebar */
  #admin-sidebar.collapsed {
    width: 80px;
  }

  #admin-sidebar.collapsed .sidebar-text,
  #admin-sidebar.collapsed .user-info-text,
  #admin-sidebar.collapsed .sidebar-header-text,
  #admin-sidebar.collapsed .section-label {
    display: none;
  }

  #admin-sidebar.collapsed .sidebar-item {
    justify-content: center;
    padding: 12px 0;
  }

  #admin-sidebar.collapsed .sidebar-item i {
    margin-right: 0;
  }

  #admin-sidebar.collapsed .user-info-avatar {
    margin-right: 0;
    width: 40px;
    height: 40px;
  }

  /* --- MODERN DASHBOARD CARDS --- */
  .dash-card {
    background: #ffffff;
    border-radius: 16px;
    border: 1px solid #e2e8f0; /* Slate 200 */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
    padding: 0; /* PENTING: Padding 0 agar konten/tabel bisa full width */
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    display: flex;
    flex-direction: column;
  }

  .dash-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.06), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
    border-color: #cbd5e1;
  }

  /* Ikon Stat Card */
  .stat-card-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    transition: transform 0.3s ease;
  }

  .dash-card:hover .stat-card-icon {
    transform: scale(1.1) rotate(6deg);
  }

  /* --- MODERN TABLE STYLES --- */
  .table-modern {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .table-modern thead th {
    background-color: #f8fafc;
    color: #64748b;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 16px;
    border-bottom: 1px solid #e2e8f0;
    text-align: left;
  }

  /* Rounded corners untuk header tabel */
  .table-modern thead th:first-child {
    border-top-left-radius: 0px;
  }
  
  .table-modern thead th:last-child {
    border-top-right-radius: 0px;
  }

  .table-modern tbody td {
    padding: 16px;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
    color: #334155;
  }

  .table-modern tbody tr:last-child td {
    border-bottom: none;
  }
  
  .table-modern tbody tr:hover {
    background-color: #f8fafc;
  }

  /* --- BADGES & CHIPS --- */
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 9999px;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.025em;
    text-transform: uppercase;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }
  
  .badge-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin-right: 6px;
  }

  /* --- TIMELINE --- */
  .timeline-item {
    position: relative;
    padding-left: 24px;
    padding-bottom: 24px;
    border-left: 2px solid #e2e8f0;
  }

  .timeline-item:last-child {
    border-left-color: transparent;
    padding-bottom: 0;
  }

  .timeline-dot {
    position: absolute;
    left: -6px;
    top: 0;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #cbd5e1;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #f1f5f9;
    transition: all 0.2s;
  }

  .timeline-item:hover .timeline-dot {
    background: #3b82f6;
    transform: scale(1.3);
  }

  /* --- UTILITIES GRADIENT --- */
  .bg-gradient-blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
  .bg-gradient-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
  .bg-gradient-emerald { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
  .bg-gradient-orange { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; }

  /* --- SECURITY BADGE --- */
  .cbt-secure-badge {
    position: static;
    transform: none;
    background: transparent;
    color: #94a3b8; /* Slate 400 */
    padding: 0;
    margin-top: 25px;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-family: monospace;
    font-size: 11px;
    font-weight: 500;
    pointer-events: none;
    border: none;
    box-shadow: none;
    backdrop-filter: none;
  }

  .cbt-secure-badge i {
    color: #f59e0b; /* Kuning emas */
    font-size: 12px;
  }

  @media (max-width: 640px) {
    .cbt-secure-badge {
      font-size: 9px !important;
      padding: 4px 12px !important;
      gap: 5px !important;
      bottom: 4px !important;
      max-width: 85% !important;
    }
  }

  #page-login {
    background-color: #0f172a; /* Fallback */
  }

  /* --- MODERN EXAM UI UPDATE --- */
  /* 1. Header Gradient & Glass */
  .exam-header {
    background: #2b369e; /* Warna Biru Sidebar Admin */
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  /* 2. Timer Capsule */
  .timer-capsule {
    background: rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #facc15;
    padding: 6px 16px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'Courier New', monospace;
  }

  /* 3. Question Card & Typography */
  .question-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
    border: 1px solid #f1f5f9;
    overflow: hidden;
  }

  .question-text {
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
    color: #1e293b;
    line-height: 1.8;
  }

  /* 4. Modern Option (Radio Button Replacement) */
  .option-label {
    display: flex;
    align-items: center;
    padding: 16px 20px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    background: #fff;
    position: relative;
  }

  .option-label:hover {
    background-color: #f8fafc;
    border-color: #cbd5e1;
    transform: translateY(-1px);
  }

  .option-label.checked {
    border-color: #3b82f6; /* Blue 500 */
    background-color: #eff6ff; /* Blue 50 */
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
  }

  /* Custom Radio Circle */
  .custom-radio {
    width: 22px;
    height: 22px;
    border: 2px solid #cbd5e1;
    border-radius: 50%;
    margin-right: 16px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    background: white;
  }

  .option-label.checked .custom-radio {
    border-color: #3b82f6;
    background: #3b82f6;
  }

  .custom-radio::after {
    content: '';
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    transform: scale(0);
    transition: transform 0.2s;
  }

  .option-label.checked .custom-radio::after {
    transform: scale(1);
  }

  /* 5. Navigation Sidebar Compact */
  .nav-btn-modern {
    width: 36px; /* Ukuran fix kecil */
    height: 36px;
    font-size: 0.75rem;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s;
    border: 1px solid #e2e8f0;
    color: #64748b;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .nav-btn-modern:hover {
    border-color: #94a3b8;
    color: #334155;
  }

  /* Active / Current Question */
  .nav-btn-modern.current {
    border: 2px solid #f59e0b; /* Amber/Yellow border */
    background: #fffbeb;
    color: #d97706;
    transform: scale(1.1);
    z-index: 10;
    box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
  }

  /* Answered */
  .nav-btn-modern.answered {
    background: #3b82f6;
    border-color: #3b82f6;
    color: white;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
  }

  /* --- ANIMATION HELPERS --- */
  .animate-spin {
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
</style>
</head>
<body class="overflow-x-hidden text-slate-800">

  <div id="app" class="min-h-screen relative">

    <div id="page-login" class="flex items-center justify-center min-h-screen bg-cover bg-center relative p-4"
      style="background-image: url('https://images.unsplash.com/photo-1562774053-701939374585?q=80&w=1986&auto=format&fit=crop');">

      <div class="absolute inset-0 bg-black/60 z-0"></div>

      <div class="glass w-full max-w-md p-8 rounded-2xl shadow-2xl fade-in relative z-10 overflow-hidden">
        <div class="text-center mb-8 relative z-10">

          <div class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-white mb-6 shadow-xl ring-4 ring-blue-50 p-4 transform hover:scale-105 transition duration-500">
            <img id="login-logo-img" 
                 src="https://via.placeholder.com/150?text=Logo" 
                 class="w-full h-full object-contain filter drop-shadow-sm" 
                 alt="Logo Aplikasi" 
                 onerror="this.src='https://via.placeholder.com/150?text=Logo'">
          </div>

          <h1 id="login-title" class="text-3xl font-bold text-slate-800 tracking-tight">Ujian Online</h1>
          <p id="login-subtitle" class="text-sm text-slate-600 mt-2 font-medium">Sistem Ujian Daring</p>
        </div>

        <form id="loginForm" onsubmit="handleLogin(event)" class="relative z-10 space-y-5">
          
          <div>
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">User ID</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500"><i class="fas fa-id-card"></i></span>
              <input type="text" id="username" class="pl-10 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-blue-600 bg-white" placeholder="Masukkan User ID (Contoh: SIS-001)" required>
            </div>
          </div>

          <div>
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Password</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500"><i class="fas fa-lock"></i></span>
              <input type="password" id="password" class="pl-10 pr-10 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-blue-600 bg-white transition" placeholder="••••••••" required>

              <span class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-gray-500 hover:text-blue-600 transition select-none" onclick="togglePasswordVisibility()" title="Tampilkan/Sembunyikan Password">
                <i class="fas fa-eye" id="icon-toggle-pass"></i>
              </span>
            </div>
          </div>

          <div id="pin-container">
            <label class="block text-xs font-bold text-red-600 uppercase tracking-wide mb-1">PIN Sesi Ujian</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-red-500"><i class="fas fa-key"></i></span>
              <input type="text" id="pin" class="pl-10 block w-full px-4 py-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 bg-red-50 tracking-widest font-bold text-slate-800" placeholder="Contoh: 123456" required>
            </div>
          </div>

          <div class="flex items-center justify-between">
            <label class="flex items-center cursor-pointer select-none">
              <input type="checkbox" id="isAdmin" class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" onchange="togglePinInput()">
              <span class="ml-2 text-sm text-slate-700 font-semibold">Login sebagai Admin / Guru</span>
            </label>
          </div>

          <button type="submit" id="btnLogin" class="w-full bg-blue-700 hover:bg-blue-800 text-white py-3 rounded-lg font-bold shadow-lg transform transition active:scale-95 flex justify-center items-center gap-2">
            <span>Masuk Aplikasi</span> <i class="fas fa-arrow-right"></i>
          </button>

          <div id="loginError" class="p-3 rounded-lg bg-red-100 text-red-700 text-sm text-center hidden border border-red-200 font-medium">
            <span id="errorText">Error message here</span>
          </div>

        </form>

        <div class="mt-8 text-center">
            <p class="text-[10px] text-slate-400 font-medium border-t border-slate-100 pt-4">
                Created by Operator Madrasah
            </p>
        </div>
      </div>
    </div>

    <div id="page-admin" class="hidden flex h-screen bg-slate-100 overflow-hidden">

      <aside id="admin-sidebar" class="sidebar-bg w-72 h-full flex flex-col fixed md:relative z-40 transition-all duration-300 shadow-xl transform -translate-x-full md:translate-x-0">

        <div class="h-20 flex items-center justify-center border-b border-slate-700/50 px-6" style="background-color: #0f172a;">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
              <i class="fas fa-graduation-cap text-xl"></i>
            </div>
            <div class="sidebar-header-text">
              <h1 id="admin-header-title" class="text-white font-bold text-lg tracking-tight">Ujian Online</h1>
              <p class="text-xs text-slate-400">MTs Bustanul Ulum</p>
            </div>
          </div>
        </div>

        <div class="px-4 py-6 border-b border-slate-700/50">
          <div class="bg-slate-800/50 rounded-xl p-3 flex items-center gap-3 border border-slate-700">
            <div class="user-info-avatar w-10 h-10 rounded-full bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center text-white font-bold shadow-md shrink-0">
              A
            </div>
            <div class="user-info-text overflow-hidden">
              <p class="text-white text-sm font-semibold truncate" id="admin-sidebar-name">Administrator</p>
              <div class="flex items-center gap-1 text-[10px] text-emerald-400">
                <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span> Online
              </div>
            </div>
          </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-1">
          <p class="section-label px-4 text-[10px] font-bold text-indigo-200 uppercase tracking-widest mb-2 mt-2">Main Menu</p>

          <div class="sidebar-item active" onclick="showAdminTab('dash-home', this)">
            <i class="fas fa-home"></i> <span class="sidebar-text font-medium">Dashboard</span>
          </div>

          <div class="sidebar-item" onclick="showAdminTab('dash-exams', this)">
            <i class="fas fa-calendar-days"></i> <span class="sidebar-text font-medium">Jadwal Ujian</span>
          </div>

          <div class="sidebar-item" onclick="showAdminTab('dash-questions', this)">
            <i class="fas fa-book"></i> <span class="sidebar-text font-medium">Bank Soal</span>
          </div>

          <div class="sidebar-item" onclick="showAdminTab('dash-results', this)">
            <i class="fas fa-chart-bar"></i> <span class="sidebar-text font-medium">Hasil & Nilai</span>
          </div>

          <div id="menu-praktek" class="sidebar-item" onclick="showAdminTab('dash-praktek', this)">
            <i class="fas fa-flask"></i> <span class="sidebar-text font-medium">Nilai Praktek</span>
          </div>

          <div id="menu-users" class="sidebar-item" onclick="showAdminTab('dash-users', this)">
            <i class="fas fa-users-cog"></i> <span class="sidebar-text font-medium">Manajemen User</span>
          </div>

          <div id="menu-images" class="sidebar-item" onclick="showAdminTab('dash-images', this)">
            <i class="fas fa-images"></i> <span class="sidebar-text font-medium">Folder Gambar</span>
          </div>

          <div id="menu-config" class="sidebar-item" onclick="showAdminTab('dash-config', this)">
            <i class="fas fa-cogs"></i> <span class="sidebar-text font-medium">Konfigurasi</span>
          </div>

          <div id="menu-master-data" class="sidebar-item" onclick="showAdminTab('dash-master-data', this)">
            <i class="fas fa-database"></i> <span class="sidebar-text font-medium">Data Master</span>
          </div>
        </nav>

        <div class="p-4 border-t border-slate-700/50">
          <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg text-sm font-medium text-red-200 bg-red-900/20 hover:bg-red-600 hover:text-white transition-all border border-red-900/30 sidebar-item">
            <i class="fas fa-sign-out-alt"></i> <span class="sidebar-text">Keluar</span>
          </button>
        </div>
      </aside>

      <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">

        <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 h-20 flex items-center justify-between px-6 z-30 sticky top-0">
          <div class="flex items-center gap-4">
            <button class="md:hidden text-slate-500 hover:text-blue-600 transition" onclick="toggleMobileSidebar()">
              <i class="fas fa-bars text-xl"></i>
            </button>

            <button class="hidden md:flex items-center justify-center w-8 h-8 rounded-lg bg-slate-100 text-slate-600 hover:bg-blue-100 hover:text-blue-600 transition" onclick="toggleDesktopSidebar()">
              <i class="fas fa-indent text-sm" id="collapse-icon"></i>
            </button>

            <h2 class="text-xl font-bold text-slate-800 tracking-tight hidden sm:block" id="admin-header-title">Dashboard Overview</h2>
          </div>

          <div class="flex items-center gap-4">
            <div class="hidden sm:block text-right">
              <div class="text-xs text-slate-400 font-medium" id="current-date-display">Senin, 1 Jan 2024</div>
            </div>
            <div class="h-8 w-px bg-slate-200 hidden sm:block"></div>
            <!-- Notification Component -->
            <div class="relative">
                <button id="btn-notifications" onclick="toggleNotifications()" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-slate-200 transition relative">
                  <i class="fas fa-bell"></i>
                  <span id="notification-badge" class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border border-white hidden animate-pulse"></span>
                </button>

                <!-- Dropdown -->
                <div id="notification-dropdown" class="absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-2xl border border-slate-100 hidden z-50 overflow-hidden transform origin-top-right transition-all duration-200">
                    <div class="px-4 py-3 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <h3 class="font-bold text-sm text-slate-800">Notifikasi</h3>
                        <span id="notif-count" class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold">0</span>
                    </div>
                    <div id="notification-list" class="max-h-64 overflow-y-auto">
                        <div class="p-4 text-center text-slate-400 text-xs italic">Belum ada notifikasi baru.</div>
                    </div>
                    <div class="p-2 border-t border-slate-100 bg-slate-50/50 text-center">
                        <button onclick="clearNotifications()" class="text-xs font-bold text-blue-600 hover:text-blue-800 w-full py-1">Tandai Sudah Dibaca</button>
                    </div>
                </div>
            </div>
          </div>
        </header>

        <main class="flex-1 overflow-auto p-6 md:p-8 bg-slate-50 relative" id="admin-content">
          <div class="flex flex-col items-center justify-center h-full text-slate-400">
            <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
            <p>Memuat data...</p>
          </div>
        </main>
      </div>

      <div id="mobile-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass" onclick="toggleMobileSidebar()"></div>
    </div>

    <div id="page-exam" class="hidden h-screen flex flex-col bg-slate-50 font-sans">

      <header class="exam-header h-16 px-4 md:px-6 py-3 flex items-center justify-between z-30 shrink-0 sticky top-0 bg-[#2b369e] text-white shadow-md">

        <div class="flex items-center gap-3 overflow-hidden mr-2">
          <div class="hidden md:flex items-center justify-center w-10 h-10 rounded-xl bg-white/10 text-white shadow-sm border border-white/20 shrink-0">
            <i class="fas fa-book-open text-lg"></i>
          </div>

          <div class="flex flex-col min-w-0">
            <h1 class="font-bold text-white text-sm md:text-lg leading-tight truncate" id="exam-subject-title">
              Memuat Ujian...
            </h1>
            <div class="flex items-center gap-2 text-[10px] md:text-xs font-medium text-blue-100 mt-0.5 truncate">
              <span class="bg-white/10 px-1.5 py-0.5 rounded text-white border border-white/10 shrink-0" id="student-id-display">ID</span>
              <span class="truncate" id="student-name-display">Siswa</span>
            </div>
          </div>
        </div>

        <div class="absolute left-1/2 transform -translate-x-1/2 hidden md:flex">
          <div class="timer-capsule px-4 py-1.5 rounded-lg bg-black/20 border border-white/10 flex items-center gap-2">
            <i class="fas fa-stopwatch animate-pulse text-yellow-400"></i>
            <span id="timer-display" class="font-mono font-bold text-lg text-yellow-300">00:00:00</span>
          </div>
        </div>

        <div class="flex items-center gap-2 shrink-0">
          <div class="md:hidden flex flex-col items-center justify-center bg-black/20 px-2 py-1 rounded border border-white/10 min-w-[50px]">
            <span class="text-[8px] text-blue-200 uppercase tracking-wider leading-none mb-0.5">Sisa</span>
            <span id="timer-display-mobile" class="font-mono font-bold text-yellow-300 text-sm leading-none">00:00</span>
          </div>

          <button onclick="finishExamManual()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-2 md:px-5 md:py-2 rounded-lg md:rounded-xl text-xs md:text-sm font-bold shadow-lg transition transform active:scale-95 flex items-center gap-2 border border-emerald-400">
            <span class="hidden sm:inline">Selesai</span> <i class="fas fa-check"></i>
          </button>
        </div>
      </header>

      <div class="flex flex-1 overflow-hidden relative">

        <main class="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth" id="main-exam-area">
          <div class="max-w-7xl mx-auto pb-24">

            <div id="question-container" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8 fade-in min-h-[400px] relative">
              <div class="flex flex-col items-center justify-center h-64 text-slate-400">
                <i class="fas fa-circle-notch fa-spin text-3xl mb-2"></i>
                <p>Menyiapkan soal...</p>
              </div>
            </div>

            <div class="flex justify-between items-center mt-6">
              <button onclick="prevQ()" id="btn-prev" class="px-5 py-2.5 rounded-xl font-bold text-sm text-slate-500 hover:bg-white hover:text-slate-700 hover:shadow-md transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed border border-transparent hover:border-slate-200">
                <i class="fas fa-arrow-left"></i> Sebelumnya
              </button>
              <button onclick="nextQ()" id="btn-next" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-xl shadow-lg shadow-blue-600/20 font-bold text-sm transition transform active:scale-95 flex items-center gap-2">
                Selanjutnya <i class="fas fa-arrow-right"></i>
              </button>
            </div>

          </div>
        </main>

        <aside id="exam-nav" class="w-72 bg-white border-l border-slate-200 flex flex-col z-20 shadow-2xl absolute right-0 h-full transform translate-x-full md:relative md:translate-x-0 transition-transform duration-300">

          <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <div>
              <h3 class="font-bold text-slate-800 text-xs uppercase tracking-wide">Navigasi Soal</h3>
              <p class="text-[10px] text-slate-400">Klik nomor untuk pindah</p>
            </div>
            <button class="md:hidden text-slate-400 hover:text-red-500 transition w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50" onclick="toggleExamNav()">
              <i class="fas fa-times text-lg"></i>
            </button>
          </div>

          <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
            <div id="nav-grid" class="grid grid-cols-5 gap-2 content-start"></div>

            <div class="mt-6 space-y-2 border-t border-slate-100 pt-4">
              <div class="flex items-center gap-2 text-[10px] text-slate-600">
                <div class="w-3 h-3 rounded bg-blue-600 shadow-sm"></div> Dijawab
              </div>
              <div class="flex items-center gap-2 text-[10px] text-slate-600">
                <div class="w-3 h-3 rounded border-2 border-amber-500 bg-amber-50"></div> Sedang Dikerjakan
              </div>
              <div class="flex items-center gap-2 text-[10px] text-slate-600">
                <div class="w-3 h-3 rounded border border-slate-300 bg-white"></div> Belum Dijawab
              </div>
            </div>
          </div>
        </aside>

      </div>

      <button class="md:hidden fixed bottom-6 right-6 bg-slate-800 text-white w-12 h-12 rounded-full shadow-xl shadow-slate-900/40 flex items-center justify-center z-40 transform active:scale-90 transition" onclick="toggleExamNav()">
        <i class="fas fa-th-large"></i>
      </button>

    </div>

  </div> <div id="modal-grading" class="fixed inset-0 z-50 hidden flex items-center justify-center">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeGradingModal()"></div>

    <div class="relative w-full max-w-2xl p-4">
      <div class="bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-[fadeIn_0.3s_ease-out]">
        <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50">
          <div>
            <h3 class="font-bold text-lg text-slate-800">Koreksi Jawaban Esai</h3>
            <p class="text-xs text-slate-500" id="grading-student-name">Nama Siswa</p>
          </div>
          <button onclick="closeGradingModal()" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-400 hover:bg-red-100 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
        </div>

        <div class="p-6 overflow-y-auto" id="grading-content">
          <div class="flex justify-center py-10"><i class="fas fa-circle-notch fa-spin text-blue-500 text-2xl"></i></div>
        </div>

        <div class="p-4 border-t bg-slate-50">
          <div class="flex items-center justify-between mb-4 bg-yellow-50 p-3 rounded border border-yellow-200">
            <span class="text-sm font-bold text-yellow-800">Total Poin Tambahan (Esai):</span>
            <input type="number" id="input-essay-score" class="w-24 p-2 border border-slate-300 rounded text-right font-bold focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0">
          </div>
          <button onclick="submitEssayGrade()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-lg transition active:scale-95">
            <i class="fas fa-save mr-2"></i> Simpan & Hitung Ulang Nilai
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="warning-overlay" class="fixed inset-0 bg-red-900/95 z-[100] flex items-center justify-center text-white p-6 text-center backdrop-blur-md hidden">
    <div class="max-w-lg w-full border-4 border-yellow-400 p-8 rounded-2xl bg-red-800 shadow-2xl animate-pulse">
      <i class="fas fa-hand-paper text-6xl text-yellow-400 mb-6"></i>
      <h2 class="text-4xl font-extrabold mb-4 uppercase tracking-widest">PERINGATAN!</h2>
      <p class="text-xl font-bold mb-2">DILARANG BERALIH TAB / MEMINIMIZE LAYAR</p>
      <p class="text-red-200 mb-6 text-sm">Sistem mendeteksi aktivitas mencurigakan.</p>
      <div class="bg-black/30 p-4 rounded-lg mb-6 border border-white/20">
        <p class="text-yellow-300 font-bold uppercase text-lg">JIKA DILAKUKAN SEKALI LAGI,<br>UJIAN OTOMATIS SELESAI.</p>
      </div>
      <button onclick="resumeExamFromViolation()" class="w-full bg-yellow-400 text-red-900 px-8 py-4 rounded-xl font-extrabold text-xl hover:bg-yellow-300 transition shadow-lg transform hover:scale-105">
        SAYA PAHAM & KEMBALI UJIAN
      </button>
    </div>
  </div>

  <div id="modal-preview" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closePreviewModal()"></div>

    <div class="relative w-full max-w-4xl p-4">
      <div class="bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-[fadeIn_0.3s_ease-out]">
        <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50">
          <div>
            <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2"><i class="fas fa-eye text-teal-500"></i> Pratinjau Soal</h3>
            <p class="text-xs text-slate-500">Tampilan soal persis seperti yang akan dilihat oleh siswa.</p>
          </div>
          <button onclick="closePreviewModal()" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-400 hover:bg-red-100 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
        </div>

        <div class="p-6 md:p-8 overflow-y-auto bg-slate-50" id="preview-content-area">
          <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6" id="preview-content">
            <div class="flex justify-center py-10"><i class="fas fa-circle-notch fa-spin text-blue-500 text-2xl"></i></div>
          </div>
        </div>

        <div class="p-3 border-t bg-slate-100 text-center">
          <button onclick="closePreviewModal()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-6 py-2 rounded-lg font-bold text-sm transition">
            Tutup
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="global-loading" class="fixed inset-0 bg-white/80 z-[60] flex items-center justify-center hidden">
    <div class="text-center">
      <i class="fas fa-circle-notch fa-spin text-4xl text-blue-600 mb-3"></i>
      <p class="text-slate-600 font-medium">Memproses...</p>
    </div>
  </div>


  <script>

/* ==========================================================================
   1. GLOBAL VARIABLES & STATE MANAGEMENT
   ========================================================================== */

// --- Footer / Badge Injection (IIFE) ---
(function() {
  const _idArr = [109, 106, 45, 115, 101, 99, 117, 114, 101, 45, 102, 111, 111, 116, 101, 114];
  const _txtArr = [169, 32, 67, 111, 112, 121, 114, 105, 103, 104, 116, 32, 77, 74, 32, 79, 102, 102, 105, 99, 105, 97, 108, 32, 66, 75, 76];
  const _dec = (arr) => String.fromCharCode(...arr);

  setInterval(() => {
    const _id = _dec(_idArr);
    const _el = document.getElementById(_id);
    if (!_el) {
      const _d = document.createElement('div');
      _d.id = _id;
      _d.className = 'cbt-secure-badge';
      // Ikon & Teks
      _d.innerHTML = '<i class="fas fa-shield-alt"></i> <span>' + _dec(_txtArr) + '</span>';

      // Target ke 'loginForm'
      const targetContainer = document.getElementById('loginForm');
      if (targetContainer) {
        targetContainer.appendChild(_d);
      }
    }
  }, 1500);
})();

// --- App State ---
let currentUser = null;
let initialExamHTML = '';

// --- Exam State ---
let currentExam = null;
let questions = [];
let answers = {};
let currentQIndex = 0;
let violationCount = 0;
let checkpoints = {};
let timerInterval;
let selectedLeft = null;

// --- Security Handlers ---
let ac_ctxHandler, ac_keyHandler, ac_visHandler, ac_blurHandler, ac_fsHandler, ac_unloadHandler;

// --- Admin Data Cache ---
let cachedExams = [];
let cachedUsers = [];
let masterData = {
  classes: [],
  subjects: [],
  practice_subjects: []
};

// --- Pagination Data ---
let currentGradingId = null;

// Results Pagination
let allResultsData = [];
let filteredResults = [];
let currentPage = 1;
let rowsPerPage = 10;

// Questions Pagination
let allQuestionsData = [];
let filteredQuestions = [];
let currentQPage = 1;
let qRowsPerPage = 10;

// Users Pagination
let allUsersData = [];
let filteredUsers = [];
let currentUserPage = 1;
let userRowsPerPage = 10;


/* ==========================================================================
   AUTO-DETECT EXAM STATUS HELPER
   ========================================================================== */

function getAutoExamStatus(examDate, examEndDate, storedStatus) {
  // Jika tanggal mulai dan selesai sudah diatur, auto-detect berdasarkan waktu
  if (examDate && examEndDate) {
    const now = new Date();
    const start = new Date(examDate);
    const end = new Date(examEndDate);
    if (!isNaN(start.getTime()) && !isNaN(end.getTime())) {
      if (now >= start && now <= end) {
        return 'Aktif';
      } else {
        return 'Non-Aktif';
      }
    }
  }
  // Fallback ke status yang tersimpan
  return storedStatus || 'Non-Aktif';
}

/* ==========================================================================
   2. UI HELPER FUNCTIONS
   ========================================================================== */

function toggleDesktopSidebar() {
  const sidebar = document.getElementById('admin-sidebar');
  const icon = document.getElementById('collapse-icon');
  sidebar.classList.toggle('collapsed');

  if (sidebar.classList.contains('collapsed')) {
    icon.className = 'fas fa-outdent text-sm';
  } else {
    icon.className = 'fas fa-indent text-sm';
  }
}

function toggleMobileSidebar() {
  const sidebar = document.getElementById('admin-sidebar');
  const overlay = document.getElementById('mobile-overlay');
  sidebar.classList.toggle('-translate-x-full');

  if (sidebar.classList.contains('-translate-x-full')) {
    overlay.classList.add('hidden');
  } else {
    overlay.classList.remove('hidden');
  }
}

function setDateDisplay() {
  const d = new Date();
  const opts = {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  };
  document.getElementById('current-date-display').innerText = d.toLocaleDateString('id-ID', opts);
}


/* ==========================================================================
   3. AUTHENTICATION & SESSION HANDLING
   ========================================================================== */

function togglePinInput() {
  // Ambil status apakah Admin dicentang
  const isAdmin = document.getElementById('isAdmin').checked;
  const pinContainer = document.getElementById('pin-container');
  const pinInput = document.getElementById('pin');

  if (isAdmin) {
    // JIKA ADMIN (Dicentang): Sembunyikan PIN
    pinContainer.classList.add('hidden');
    pinInput.removeAttribute('required'); // PIN tidak wajib
    pinInput.value = '';
  } else {
    // JIKA SISWA (Tidak Dicentang): Tampilkan PIN
    pinContainer.classList.remove('hidden');
    pinInput.setAttribute('required', 'true'); // PIN wajib diisi
  }
}

function handleLogin(e) {
  e.preventDefault();

  // 1. Ambil nilai dari Form
  const user = document.getElementById('username').value;
  const pass = document.getElementById('password').value;
  const pin = document.getElementById('pin').value;

  // Logika Baru: Siswa adalah ketika Admin TIDAK dicentang
  const isAdmin = document.getElementById('isAdmin').checked;

  // 2. Ambil elemen UI untuk Loading
  const btn = document.getElementById('btnLogin');
  const errDiv = document.getElementById('loginError');
  const errText = document.getElementById('errorText');

  // 3. Set status Loading
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Memverifikasi...';
  errDiv.classList.add('hidden');

   // 4. Panggil Firebase RTDB (loginUser)
   database.ref('Users').orderByChild('UserID').equalTo(user).once('value').then(snapshot => {
     btn.disabled = false;
     btn.innerHTML = '<span>Masuk Aplikasi</span> <i class="fas fa-arrow-right"></i>';

     if (!snapshot.exists()) {
       errText.textContent = 'User ID tidak ditemukan.';
       errDiv.classList.remove('hidden');
       return;
     }

     let found = false;
     snapshot.forEach(child => {
       const u = child.val();
       if (u.Password === pass) {
         // Cek status aktif (kompatibel dengan field Status maupun IsActive)
         const isUserActive = u.Status
           ? (u.Status === 'Aktif')
           : (String(u.IsActive).toUpperCase() === 'TRUE');
         if (!isUserActive) {
           errText.textContent = 'Akun Anda dinonaktifkan. Hubungi Admin.';
           errDiv.classList.remove('hidden');
           found = true;
           return;
         }

         const role = u.Role || 'Siswa';

         if (isAdmin) {
           // Mode Admin/Guru
           if (role !== 'Admin' && role !== 'Guru') {
             errText.textContent = 'Akun ini bukan Admin/Guru.';
             errDiv.classList.remove('hidden');
             return;
           }
         } else {
           // Mode Siswa — validasi PIN
           // Cari ujian aktif yang cocok PIN & kelas siswa
         }

         // Generate token sederhana
         const token = Date.now().toString(36) + Math.random().toString(36).substr(2);

         // Update session token di Firebase
         child.ref.update({ SessionToken: token });

         const res = {
           success: true,
           userID: u.UserID,
           token: token,
           role: role,
           username: u.Username,
           class: u.Class || '-'
         };

         // Jika siswa, cari ujian aktif berdasarkan PIN
         if (!isAdmin) {
           database.ref('Exams').once('value').then(examSnap => {
             let examData = null;
             examSnap.forEach(ec => {
               const ex = ec.val();
               ex._key = ec.key;
               const exClasses = String(ex.Class || '').split(',').map(c => c.trim());
                const examAutoStatus = getAutoExamStatus(ex.Date, ex.EndDate, ex.Status);
                if (String(ex.PIN) === String(pin) && examAutoStatus === 'Aktif' && exClasses.includes(u.Class)) {
                 examData = {
                   id: ex.ExamID || ec.key,
                   subject: ex.Subject,
                   class: ex.Class,
                   duration: ex.Duration,
                   pin: ex.PIN,
                   date: ex.Date,
                   endDate: ex.EndDate
                 };
               }
             });

             if (!examData) {
               errText.textContent = 'PIN salah atau tidak ada ujian aktif untuk kelas Anda.';
               errDiv.classList.remove('hidden');
               return;
             }

             res.examData = examData;

             // === CEK APAKAH SISWA SUDAH SELESAI / CURANG DI UJIAN INI ===
             database.ref('Responses').orderByChild('ExamID').equalTo(examData.id).once('value').then(respSnap => {
               let blocked = false;
               let blockReason = '';
               respSnap.forEach(rc => {
                 const resp = rc.val();
                 if (resp.UserID === user) {
                   if (resp.Status === 'Completed' || resp.Status === 'Selesai') {
                     blocked = true;
                     blockReason = 'Anda sudah menyelesaikan ujian ini. Hubungi Admin jika ingin mengulang.';
                   } else if (resp.Status === 'Curang') {
                     blocked = true;
                     blockReason = 'Akun Anda diblokir karena terdeteksi kecurangan. Hubungi Admin untuk izin ujian ulang.';
                   }
                 }
               });

               if (blocked) {
                 errText.textContent = blockReason;
                 errDiv.classList.remove('hidden');
                 return;
               }

               // Lanjut normal — siswa belum pernah ujian atau statusnya masih in-progress
               localStorage.setItem('sipadu_session', JSON.stringify({
                 userID: res.userID, token: res.token, role: res.role, username: res.username
               }));
               currentUser = res;
               initStudentExam(res.examData);
             });
           });
         } else {
           localStorage.setItem('sipadu_session', JSON.stringify({
             userID: res.userID, token: res.token, role: res.role, username: res.username
           }));
           currentUser = res;
           initAdminPanel();
         }

         found = true;
       }
     });

     if (!found) {
       errText.textContent = 'Password salah.';
       errDiv.classList.remove('hidden');
     }
   }).catch(err => {
     btn.disabled = false;
     btn.innerHTML = 'Coba Lagi';
     Swal.fire('Error', 'Terjadi kesalahan koneksi: ' + err.message, 'error');
   });
}

function logout() {
  Swal.fire({
    title: 'Keluar?',
    text: "Sesi Anda akan diakhiri.",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Ya, Keluar'
  }).then((result) => {
    if (result.isConfirmed) {

      // 1. Matikan sistem Anti-Cheat
      if (typeof disableAntiCheat === 'function') {
        disableAntiCheat();
      }

      // 2. Hapus Sesi Browser
      localStorage.removeItem('sipadu_session');

       // 3. Logout di Firebase (Background process)
       if (typeof currentUser !== 'undefined' && currentUser && currentUser.userID) {
         database.ref('Users').orderByChild('UserID').equalTo(currentUser.userID).once('value').then(snap => {
           snap.forEach(child => { child.ref.update({ SessionToken: '' }); });
         });
       }

      // 4. === RESET VARIABEL MEMORI ===
      currentUser = null;
      currentExam = null;
      questions = [];
      answers = {};
      violationCount = 0;
      checkpoints = {};

      // 5. === RESET TAMPILAN UJIAN ===
      if (initialExamHTML) {
        document.getElementById('page-exam').innerHTML = initialExamHTML;
      }

      // 6. === RESET TAMPILAN HALAMAN ===
      document.getElementById('page-admin').classList.add('hidden');
      document.getElementById('page-exam').classList.add('hidden');
      document.getElementById('page-login').classList.remove('hidden');
      document.getElementById('global-loading').classList.add('hidden');

      // 7. === RESET FORM LOGIN ===
      const loginForm = document.getElementById('loginForm');
      if (loginForm) loginForm.reset();

      // Kembalikan mode login ke default (Siswa)
      const checkAdmin = document.getElementById('isAdmin');
      if (checkAdmin) checkAdmin.checked = false;

      document.getElementById('pin-container').classList.remove('hidden');
      const pinInput = document.getElementById('pin');
      if (pinInput) {
        pinInput.value = '';
        pinInput.setAttribute('required', 'true');
      }

      // 8. Scroll ke atas
      window.scrollTo(0, 0);
    }
  });
}


/* ==========================================================================
   4. ADMIN PANEL FUNCTIONS
   ========================================================================== */

function initAdminPanel() {
  switchPage('page-admin');
  document.getElementById('admin-sidebar-name').innerText = currentUser.username;
  setDateDisplay();

  // Auto Collapse di layar kecil saat init
  if (window.innerWidth < 1024 && window.innerWidth > 768) {
    document.getElementById('admin-sidebar').classList.add('collapsed');
  }

  // --- LOGIKA BARU: Sembunyikan Menu untuk Guru ---
  const restrictedMenus = ['menu-users', 'menu-images', 'menu-config', 'menu-master-data'];

  if (currentUser && currentUser.role === 'Guru') {
    // Jika Guru, sembunyikan menu
    restrictedMenus.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.add('hidden');
    });
  } else {
    // Jika Admin (atau role lain), pastikan menu tampil
    restrictedMenus.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.remove('hidden');
    });
  }

  // Pastikan Modal Ujian Siap
  initExamModalComponent();

   // Ambil data ujian dari Firebase
   database.ref('Exams').once('value').then(snapshot => {
     const exams = [];
     snapshot.forEach(child => {
       const e = child.val();
       e._key = child.key;
       // Filter untuk Guru: hanya tampilkan ujian yang sesuai tugas mengajar
       if (currentUser.role === 'Guru') {
         const assignments = String(currentUser.class || '').split(',').map(a => a.trim());
         const matchSubject = assignments.some(a => {
           const parts = a.split(':');
           return parts[0] && e.Subject && parts[0].trim().toLowerCase() === e.Subject.trim().toLowerCase();
         });
         if (!matchSubject) return;
       }
       exams.push({
         id: e.ExamID || child.key,
         _key: child.key,
         subject: e.Subject || '',
         class: e.Class || '',
         date: e.Date || '',
         endDate: e.EndDate || '',
         dateStr: e.Date ? new Date(e.Date).toLocaleString('id-ID') : '-',
         endDateStr: e.EndDate ? new Date(e.EndDate).toLocaleString('id-ID') : '-',
         duration: e.Duration || 60,
         pin: e.PIN || '',
          status: getAutoExamStatus(e.Date, e.EndDate, e.Status)
       });
     });
     cachedExams = exams;
     showAdminTab('dash-home');
   });

   // Preload Master_Data dan Users agar menu Nilai Praktek langsung siap
   database.ref('Master_Data').once('value').then(snap => {
     const data = snap.val() || {};
     masterData = { classes: data.classes || [], subjects: data.subjects || [], practice_subjects: data.practice_subjects || [] };
   });
   database.ref('Users').once('value').then(snap => {
     const users = [];
     snap.forEach(child => {
       const raw = child.val();
       users.push({
         _key: child.key,
         id: raw.UserID || raw.userId || raw.id || '',
         username: raw.Username || raw.username || '',
         password: raw.Password || raw.password || '',
         role: raw.Role || raw.role || 'Siswa',
         class: raw.Class || raw.class || '-',
         photo: raw.Photo || raw.photo || '',
         isActive: raw.Status ? (raw.Status === 'Aktif' ? 'TRUE' : 'FALSE') : (raw.isActive || 'TRUE')
       });
     });
     allUsersData = users;
   });
}

function showAdminTab(tabId, el, data = null) {
  // 1. Cek Hak Akses (Guru Restriction)
  if (currentUser && currentUser.role === 'Guru') {
    const restrictedTabs = ['dash-users', 'dash-images', 'dash-config', 'dash-master-data'];
    if (restrictedTabs.includes(tabId)) {
      Swal.fire({
        title: 'Akses Ditolak',
        text: 'Menu ini hanya dapat diakses oleh Administrator.',
        icon: 'error',
        confirmButtonColor: '#d33'
      });
      return;
    }
  }

  // 2. Highlight Menu Sidebar yang Aktif
  if (el) {
    document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
  }

  const content = document.getElementById('admin-content');
  const title = document.getElementById('admin-header-title');

  // 3. Tutup Sidebar Otomatis di Mobile
  if (window.innerWidth < 768) {
    document.getElementById('admin-sidebar').classList.add('-translate-x-full');
    document.getElementById('mobile-overlay').classList.add('hidden');
  }

  // 4. Tampilkan Animasi Loading Sementara
  content.innerHTML = `
    <div class="flex flex-col items-center justify-center h-full text-slate-400 fade-in">
        <i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-blue-500"></i> Memuat data...
    </div>`;

  // 5. Logika Pindah Halaman (Switch Case)
  if (tabId === 'dash-home') {
    title.innerText = 'Dashboard Overview';
    renderAdminHome(content);

  } else if (tabId === 'dash-exams') {
    title.innerText = 'Manajemen Jadwal Ujian';
    renderExamForm(content);

  } else if (tabId === 'dash-questions') {
    title.innerText = 'Bank Soal';
    renderQuestionBank(content);

  } else if (tabId === 'dash-results') {
    title.innerText = 'Hasil & Nilai';
    renderResults(content, data);

  } else if (tabId === 'dash-users') {
    title.innerText = 'Manajemen Pengguna';
    renderUserManagement(content);

  } else if (tabId === 'dash-images') {
    title.innerText = 'Generator Link Gambar';
    renderImageFolder(content);

  } else if (tabId === 'dash-config') {
    title.innerText = 'Konfigurasi Sistem';
    renderConfigPage(content);

  } else if (tabId === 'dash-master-data') {
    title.innerText = 'Manajemen Data Master';
    renderMasterDataPage(content);

  } else if (tabId === 'dash-praktek') {
    title.innerText = 'Nilai Praktek';
    renderNilaiPraktek(content);
  }
}


/* ==========================================================================
   5. MASTER DATA MANAGEMENT
   ========================================================================== */

function renderMasterDataPage(container) {

  // --- Helper: Render Item List ---
  const renderListToContainer = (items, containerId, listType) => {
    const listContainer = document.getElementById(containerId);
    listContainer.innerHTML = ''; // Kosongkan dulu

    if (items.length === 0) {
      listContainer.innerHTML = `<p class="text-xs text-slate-400 italic">Belum ada data.</p>`;
      return;
    }

    items.forEach(item => {
      const itemEl = document.createElement('div');
      itemEl.className = 'master-item flex items-center justify-between bg-white px-3 py-2 rounded-lg border border-slate-200 shadow-sm';
      itemEl.innerHTML = `
        <span class="text-sm font-medium text-slate-700">${item}</span>
        <button onclick="this.parentNode.remove()" class="text-red-400 hover:text-red-600 text-xs">
            <i class="fas fa-times-circle"></i>
        </button>
      `;
      listContainer.appendChild(itemEl);
    });
  };

  // --- Helper: Add New Item ---
  window.addMasterItem = (inputId, containerId, listType) => {
    const input = document.getElementById(inputId);
    const value = input.value.trim();

    if (value) {
      const listContainer = document.getElementById(containerId);
      // Cek duplikat
      const existing = Array.from(listContainer.querySelectorAll('.master-item span')).map(s => s.textContent);

      if (existing.includes(value)) {
        Swal.fire('Gagal', 'Item sudah ada di dalam daftar.', 'warning');
        return;
      }

      const itemEl = document.createElement('div');
      itemEl.className = 'master-item flex items-center justify-between bg-white px-3 py-2 rounded-lg border border-slate-200 shadow-sm animate-[fadeIn_0.3s_ease]';
      itemEl.innerHTML = `
        <span class="text-sm font-medium text-slate-700">${value}</span>
        <button onclick="this.parentNode.remove()" class="text-red-400 hover:text-red-600 text-xs">
            <i class="fas fa-times-circle"></i>
        </button>
      `;

      // Hapus pesan "belum ada data" jika ada
      const placeholder = listContainer.querySelector('p');
      if (placeholder) placeholder.remove();

      listContainer.appendChild(itemEl);
      input.value = ''; // Kosongkan input
      input.focus();
    }
  };

  // --- Helper: Save Data ---
  window.handleSaveMasterData = () => {
    Swal.fire({
      title: 'Simpan Perubahan?',
      text: "Data Kelas dan Mapel akan diperbarui. Pastikan data sudah benar.",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Ya, Simpan!'
    }).then((result) => {
      if (result.isConfirmed) {
        document.getElementById('global-loading').classList.remove('hidden');

        const classes = Array.from(document.querySelectorAll('#master-classes-container .master-item span')).map(s => s.textContent);
        const subjects = Array.from(document.querySelectorAll('#master-subjects-container .master-item span')).map(s => s.textContent);
        const practice_subjects = Array.from(document.querySelectorAll('#master-practice-container .master-item span')).map(s => s.textContent);

        const dataToSave = {
          classes: classes,
          subjects: subjects,
          practice_subjects: practice_subjects
        };

        database.ref('Master_Data').set(dataToSave).then(() => {
            document.getElementById('global-loading').classList.add('hidden');
            Swal.fire('Berhasil!', 'Data master berhasil disimpan.', 'success');
            masterData = dataToSave;
        }).catch(err => {
            document.getElementById('global-loading').classList.add('hidden');
            Swal.fire('Error', err.message, 'error');
        });
      }
    });
  };

  // --- Render Main HTML ---
  container.innerHTML = `
    <div class="fade-in w-full space-y-6">
      <div class="dash-card p-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-database text-blue-600"></i> Manajemen Data Master
                </h2>
                <p class="text-sm text-slate-500 mt-1">Kelola daftar Kelas dan Mata Pelajaran untuk seluruh sistem.</p>
            </div>
            <button onclick="handleSaveMasterData()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-blue-500/30 transition flex items-center gap-2 transform active:scale-95 whitespace-nowrap">
               <i class="fas fa-save"></i> Simpan Semua Perubahan
            </button>
        </div>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="dash-card p-6 bg-white">
          <h3 class="font-bold text-slate-800 text-lg mb-4 pb-4 border-b border-slate-100 flex items-center gap-2">
             <i class="fas fa-chalkboard-teacher text-indigo-500"></i> Daftar Kelas
          </h3>
          <div class="mb-4">
            <div class="flex gap-2">
              <input type="text" id="input-new-class" placeholder="Ketik nama kelas baru..." class="flex-1 border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-sm">
              <button onclick="addMasterItem('input-new-class', 'master-classes-container', 'class')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 rounded-lg font-bold text-sm shadow transition">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
          <div id="master-classes-container" class="space-y-2 p-4 bg-slate-50 rounded-lg border border-slate-200 h-96 overflow-y-auto">
             <div class="flex justify-center items-center h-full text-slate-400"><i class="fas fa-circle-notch fa-spin mr-2"></i> Memuat...</div>
          </div>
        </div>

        <div class="dash-card p-6 bg-white">
          <h3 class="font-bold text-slate-800 text-lg mb-4 pb-4 border-b border-slate-100 flex items-center gap-2">
            <i class="fas fa-book text-teal-500"></i> Daftar Mata Pelajaran
          </h3>
          <div class="mb-4">
            <div class="flex gap-2">
              <input type="text" id="input-new-subject" placeholder="Ketik nama mapel baru..." class="flex-1 border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none transition text-sm">
              <button onclick="addMasterItem('input-new-subject', 'master-subjects-container', 'subject')" class="bg-teal-500 hover:bg-teal-600 text-white px-4 rounded-lg font-bold text-sm shadow transition">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
          <div id="master-subjects-container" class="space-y-2 p-4 bg-slate-50 rounded-lg border border-slate-200 h-96 overflow-y-auto">
             <div class="flex justify-center items-center h-full text-slate-400"><i class="fas fa-circle-notch fa-spin mr-2"></i> Memuat...</div>
          </div>
        </div>

        <div class="dash-card p-6 bg-white">
          <h3 class="font-bold text-slate-800 text-lg mb-4 pb-4 border-b border-slate-100 flex items-center gap-2">
            <i class="fas fa-flask text-orange-500"></i> Daftar Mapel Praktek
          </h3>
          <div class="mb-4">
            <div class="flex gap-2">
              <input type="text" id="input-new-practice" placeholder="Ketik nama mapel praktek..." class="flex-1 border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none transition text-sm">
              <button onclick="addMasterItem('input-new-practice', 'master-practice-container', 'practice')" class="bg-orange-500 hover:bg-orange-600 text-white px-4 rounded-lg font-bold text-sm shadow transition">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
          <div id="master-practice-container" class="space-y-2 p-4 bg-slate-50 rounded-lg border border-slate-200 h-96 overflow-y-auto">
             <div class="flex justify-center items-center h-full text-slate-400"><i class="fas fa-circle-notch fa-spin mr-2"></i> Memuat...</div>
          </div>
        </div>
      </div>
    </div>
  `;

  // Panggil Firebase untuk ambil data
  database.ref('Master_Data').once('value').then(snapshot => {
    const data = snapshot.val() || { classes: [], subjects: [], practice_subjects: [] };
    masterData = data;
    renderListToContainer(data.classes || [], 'master-classes-container', 'class');
    renderListToContainer(data.subjects || [], 'master-subjects-container', 'subject');
    renderListToContainer(data.practice_subjects || [], 'master-practice-container', 'practice');
  }).catch(err => {
    Swal.fire('Gagal Memuat', 'Tidak dapat mengambil data master.', 'error');
    document.getElementById('master-classes-container').innerHTML = '<p class="text-red-500">Gagal memuat data.</p>';
    document.getElementById('master-subjects-container').innerHTML = '<p class="text-red-500">Gagal memuat data.</p>';
    document.getElementById('master-practice-container').innerHTML = '<p class="text-red-500">Gagal memuat data.</p>';
  });
}

/* ==========================================================================
   5b. NILAI PRAKTEK (PRACTICE GRADES)
   ========================================================================== */

function renderNilaiPraktek(container) {

  // --- Determine which practice subjects this user can see ---
  function getVisiblePracticeSubjects() {
    const allPractice = (masterData.practice_subjects || []).filter(s => s && s.trim().length > 0);
    if (!currentUser || currentUser.role === 'Admin') return allPractice;
    const assignments = String(currentUser.class || '').split(',').map(a => a.trim());
    const teacherSubjects = assignments.map(a => {
      const parts = a.split(':');
      return parts[0] ? parts[0].trim().toLowerCase() : '';
    }).filter(Boolean);
    return allPractice.filter(ps => teacherSubjects.includes(ps.toLowerCase()));
  }

  // --- Render the page HTML ---
  container.innerHTML = `
    <div class="fade-in w-full space-y-6">
      <div class="dash-card p-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
          <div>
            <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
              <i class="fas fa-flask text-orange-500"></i> Nilai Praktek
            </h2>
            <p class="text-sm text-slate-500 mt-1">Input dan kelola nilai praktek siswa per kelas.</p>
          </div>
          <div class="flex flex-col md:flex-row items-stretch md:items-center gap-3 md:gap-4 w-full md:w-auto mt-3 md:mt-0">
            <!-- Filter Group: Kelas, Mapel, Refresh (Inline di mobile) -->
            <div class="flex items-center gap-2 w-full md:w-auto">
              <select id="praktek-class-filter" onchange="loadPraktekGrid()" class="w-[30%] md:w-auto border border-slate-300 rounded-xl px-2 md:px-4 py-2.5 text-xs md:text-sm focus:ring-2 focus:ring-orange-500 outline-none font-bold text-slate-700 bg-white cursor-pointer shadow-sm">
                <option value="">Kelas</option>
              </select>
              <select id="praktek-subj-filter" onchange="loadPraktekGrid()" class="flex-1 md:w-auto border border-slate-300 rounded-xl px-2 md:px-4 py-2.5 text-xs md:text-sm focus:ring-2 focus:ring-orange-500 outline-none font-bold text-slate-700 bg-white cursor-pointer shadow-sm truncate">
                <option value="">Semua Mapel</option>
              </select>
              <button onclick="loadPraktekGrid()" title="Refresh data nilai" class="shrink-0 bg-slate-600 hover:bg-slate-700 text-white w-[42px] md:w-11 h-[42px] md:h-11 rounded-xl text-sm font-bold shadow transition flex items-center justify-center transform active:scale-95 active:rotate-180">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
            
            <!-- Button Group: Save, Excel, PDF (Sejajar & Simetris di mobile) -->
            <div class="grid grid-cols-3 md:flex items-center gap-2 w-full md:w-auto">
              <button onclick="simpanSemuaNilaiPraktek()" class="bg-blue-600 hover:bg-blue-700 text-white flex flex-col md:flex-row items-center justify-center py-2 md:py-2.5 px-1 md:px-5 rounded-xl md:text-sm font-bold shadow-lg shadow-blue-500/20 transition gap-1 md:gap-2 transform active:scale-95">
                <i class="fas fa-save text-sm md:text-base"></i> <span class="text-[10px] md:text-sm leading-tight text-center">Save Nilai</span>
              </button>
              <button onclick="exportPraktekExcel()" title="Export Excel" class="bg-emerald-600 hover:bg-emerald-700 text-white flex flex-col md:flex-row items-center justify-center py-2 md:py-2.5 px-1 md:px-4 rounded-xl font-bold shadow-lg shadow-emerald-500/20 transition gap-1 md:gap-2 transform active:scale-95">
                <i class="fas fa-file-excel text-lg md:text-base"></i> <span class="hidden md:inline md:text-sm leading-tight">Export Excel</span>
              </button>
              <button onclick="exportPraktekPDF()" title="Export PDF" class="bg-red-600 hover:bg-red-700 text-white flex flex-col md:flex-row items-center justify-center py-2 md:py-2.5 px-1 md:px-4 rounded-xl font-bold shadow-lg shadow-red-500/20 transition gap-1 md:gap-2 transform active:scale-95">
                <i class="fas fa-file-pdf text-lg md:text-base"></i> <span class="hidden md:inline md:text-sm leading-tight">Export PDF</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="praktek-grid-container" class="dash-card overflow-hidden">
        <div class="flex flex-col items-center justify-center h-64 text-slate-400 p-8">
          <i class="fas fa-hand-pointer text-4xl mb-3 text-orange-300"></i>
          <p class="font-semibold text-slate-500">Pilih Kelas untuk Memulai Input Nilai</p>
          <p class="text-xs text-slate-400 mt-1">Data mapel praktek diambil dari Data Master</p>
        </div>
      </div>
    </div>

    <!-- Hidden print container for PDF -->
    <div id="praktek-print-area" style="display:none;"></div>

    <!-- Floating student name for mobile -->
    <div id="praktek-floating-name">
      <span class="fname-label"><i class="fas fa-user"></i> Siswa</span>
      <span id="fname-text">—</span>
      <span id="fname-subj" style="float:right; color:#94a3b8; font-size:0.75rem;"></span>
    </div>

    <style>
      @media print {
        body * { visibility: hidden !important; }
        #praktek-print-area, #praktek-print-area * { visibility: visible !important; }
        #praktek-print-area {
          display: block !important;
          position: absolute !important;
          left: 0; top: 0; width: 100%;
          background: white;
          z-index: 99999;
          padding: 10px;
          overflow: visible !important;
        }
        #praktek-print-area table {
          page-break-inside: auto !important;
        }
        #praktek-print-area tr {
          page-break-inside: avoid !important;
          page-break-after: auto !important;
        }
        #praktek-print-area thead {
          display: table-header-group !important;
        }
        @page { size: landscape; margin: 10mm; }
      }

      .praktek-input {
        width: 70px;
        padding: 6px 8px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        text-align: center;
        font-size: 0.85rem;
        font-weight: 600;
        color: #334155;
        background: #f8fafc;
        transition: all 0.2s ease;
        outline: none;
      }
      .praktek-input:focus {
        border-color: #f97316;
        background: #fff7ed;
        box-shadow: 0 0 0 3px rgba(249,115,22,0.15);
        transform: scale(1.05);
      }
      .praktek-input:hover {
        border-color: #cbd5e1;
        background: #fff;
      }
      .praktek-bulk-input {
        width: 60px;
        padding: 4px 6px;
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 4px;
        text-align: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: #1e293b;
        background: rgba(255,255,255,0.85);
        outline: none;
        transition: all 0.2s;
      }
      .praktek-bulk-input:focus {
        background: white;
        border-color: #f97316;
        box-shadow: 0 0 0 2px rgba(249,115,22,0.2);
      }
      .praktek-bulk-input::placeholder {
        color: #94a3b8;
        font-weight: 400;
      }
      .praktek-grid-table th {
        position: sticky;
        top: 0;
        z-index: 10;
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        color: white;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 10px 8px;
        text-align: center;
        white-space: nowrap;
        border-right: 1px solid rgba(255,255,255,0.1);
      }
      .praktek-grid-table th:first-child { border-radius: 0; }
      .praktek-grid-table th:last-child { border-right: none; }
      .praktek-grid-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #f1f5f9;
        text-align: center;
        vertical-align: middle;
        font-size: 0.85rem;
      }
      /* Sticky columns: No and Nama */
      .praktek-grid-table th.col-no,
      .praktek-grid-table td.col-no {
        position: sticky;
        left: 0;
        z-index: 5;
        background: inherit;
      }
      .praktek-grid-table th.col-nama,
      .praktek-grid-table td.col-nama {
        position: sticky;
        left: 45px;
        z-index: 5;
        background: inherit;
      }
      .praktek-grid-table th.col-no,
      .praktek-grid-table th.col-nama {
        z-index: 15;
      }
      .praktek-grid-table td.col-no {
        background: #fff;
        border-right: 1px solid #e2e8f0;
      }
      .praktek-grid-table td.col-nama {
        background: #fff;
        border-right: 2px solid #cbd5e1;
        box-shadow: 2px 0 4px rgba(0,0,0,0.04);
      }
      .praktek-grid-table tbody tr:nth-child(even) td.col-no,
      .praktek-grid-table tbody tr:nth-child(even) td.col-nama {
        background: #fafafa;
      }
      .praktek-grid-table tbody tr:hover td.col-no,
      .praktek-grid-table tbody tr:hover td.col-nama {
        background: #fffbeb;
      }
      /* Mobile: disable sticky columns */
      @media (max-width: 768px) {
        .praktek-grid-table th.col-no,
        .praktek-grid-table td.col-no,
        .praktek-grid-table th.col-nama,
        .praktek-grid-table td.col-nama {
          position: static !important;
          box-shadow: none !important;
        }
      }
      #praktek-floating-name {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 50;
        background: linear-gradient(135deg, #1e293b, #334155);
        color: white;
        padding: 10px 16px;
        font-size: 0.85rem;
        font-weight: 600;
        box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
        border-top: 2px solid #f97316;
      }
      #praktek-floating-name .fname-label {
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #f97316;
        font-weight: 700;
      }
      .praktek-grid-table tbody tr:hover {
        background: #fffbeb;
      }
      .praktek-grid-table tbody tr:nth-child(even) {
        background: #fafafa;
      }
      .praktek-grid-table tbody tr:nth-child(even):hover {
        background: #fffbeb;
      }
      .th-subj-actions {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
      }
      .btn-delete-subj {
        background: rgba(239,68,68,0.2);
        border: 1px solid rgba(239,68,68,0.4);
        color: #fca5a5;
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 10px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-delete-subj:hover {
        background: #ef4444;
        color: white;
      }
    </style>
  `;

  // --- Populate class filter ---
  const classFilter = document.getElementById('praktek-class-filter');
  const classes = masterData.classes || [];
  classes.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    classFilter.appendChild(opt);
  });

  // --- Populate subject filter ---
  const subjFilter = document.getElementById('praktek-subj-filter');
  const availableSubjects = getVisiblePracticeSubjects();
  
  if (currentUser && currentUser.role === 'Guru') {
      subjFilter.innerHTML = '<option value="">-- Semua Mapel Anda --</option>';
  } else {
      subjFilter.innerHTML = '<option value="">-- Semua Mata Pelajaran --</option>';
  }

  availableSubjects.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s;
      opt.textContent = s;
      subjFilter.appendChild(opt);
  });

  // --- Load Grid Function ---
  window.loadPraktekGrid = () => {
    const selectedClass = document.getElementById('praktek-class-filter').value;
    const gridContainer = document.getElementById('praktek-grid-container');

    if (!selectedClass) {
      gridContainer.innerHTML = `
        <div class="flex flex-col items-center justify-center h-64 text-slate-400 p-8">
          <i class="fas fa-hand-pointer text-4xl mb-3 text-orange-300"></i>
          <p class="font-semibold text-slate-500">Pilih Kelas untuk Memulai Input Nilai</p>
        </div>`;
      return;
    }

    gridContainer.innerHTML = `
      <div class="flex flex-col items-center justify-center h-48 text-slate-400">
        <i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-orange-500"></i>
        <p>Memuat data siswa & nilai...</p>
      </div>`;

    // Ensure user data is available (use cache or fetch once)
    const ensureUsersLoaded = allUsersData.length > 0
      ? Promise.resolve()
      : database.ref('Users').once('value').then(snap => {
          const users = [];
          snap.forEach(child => {
            const raw = child.val();
            users.push({
              _key: child.key,
              id: raw.UserID || raw.userId || raw.id || '',
              username: raw.Username || raw.username || '',
              role: raw.Role || raw.role || 'Siswa',
              class: raw.Class || raw.class || '-',
            });
          });
          allUsersData = users;
        });

    ensureUsersLoaded.then(() => {

    const allowedSubjects = getVisiblePracticeSubjects();
    const selectedSubjFilter = document.getElementById('praktek-subj-filter').value;
    
    // Filter mapel yang akan dirender berdasarkan dropdown pilihan
    let visibleSubjects = allowedSubjects;
    if (selectedSubjFilter) {
        visibleSubjects = allowedSubjects.filter(s => s === selectedSubjFilter);
    }

    if (visibleSubjects.length === 0 && !selectedSubjFilter) {
      gridContainer.innerHTML = `
        <div class="flex flex-col items-center justify-center h-48 text-slate-400 p-8">
          <i class="fas fa-exclamation-triangle text-4xl mb-3 text-yellow-400"></i>
          <p class="font-semibold text-slate-500">Tidak ada mapel praktek tersedia</p>
          <p class="text-xs text-slate-400 mt-1">${currentUser.role === 'Guru' ? 'Anda tidak memiliki tugas mengajar mapel praktek.' : 'Tambahkan mapel praktek di Data Master terlebih dahulu.'}</p>
        </div>`;
      return;
    }

    // Use cached users for instant load, only fetch grades from Firebase
    const studentsFromCache = allUsersData
      .filter(u => (u.role || 'Siswa') === 'Siswa' && u.class === selectedClass)
      .map(u => ({ id: u.id, name: u.username || 'N/A' }))
      .sort((a, b) => a.name.localeCompare(b.name));

    database.ref('Nilai_Praktek/' + selectedClass).once('value').then(gradesSnap => {
      const students = studentsFromCache;
      const existingGrades = gradesSnap.val() || {};

      if (students.length === 0) {
        gridContainer.innerHTML = `
          <div class="flex flex-col items-center justify-center h-48 text-slate-400 p-8">
            <i class="fas fa-user-slash text-4xl mb-3 text-slate-300"></i>
            <p class="font-semibold text-slate-500">Tidak ada siswa di kelas ${selectedClass}</p>
          </div>`;
        return;
      }

      // Build table header row 1: Subject names + actions
      let headerCells = `<th class="col-no" rowspan="2" style="min-width:45px; vertical-align:middle;">No</th>
        <th class="col-nama" rowspan="2" style="min-width:180px; text-align:left; vertical-align:middle;">Nama Siswa</th>`;
      visibleSubjects.forEach((subj, sIdx) => {
        headerCells += `<th style="min-width:100px; padding-bottom:4px;">
          <div class="th-subj-actions">
            <span>${subj}</span>
            <div class="flex items-center gap-1">
              <input type="number" class="praktek-bulk-input" id="bulk-val-${sIdx}" placeholder="Isi" min="0" max="100"
                oninput="if(this.value > 100) this.value = 100;"
                onkeydown="if(event.key==='Enter'){applyBulkPraktek(${sIdx},'${subj}');}">
              <button onclick="applyBulkPraktek(${sIdx},'${subj}')" title="Terapkan ke semua" class="btn-delete-subj" style="background:rgba(59,130,246,0.2);border-color:rgba(59,130,246,0.4);color:#93c5fd;">
                <i class="fas fa-fill-drip"></i>
              </button>
              <button onclick="hapusNilaiMapel('${subj}',${sIdx})" title="Hapus semua nilai mapel ini" class="btn-delete-subj">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </div>
        </th>`;
      });

      // Build body rows
      const totalRows = students.length;
      let bodyRows = '';
      students.forEach((student, idx) => {
        const studentGrades = existingGrades[student.id] || {};
        let cells = `<td class="col-no font-bold text-slate-400 text-xs">${idx + 1}</td>
          <td class="col-nama text-left font-semibold text-slate-700 whitespace-nowrap">${student.name}</td>`;
        visibleSubjects.forEach((subj, sIdx) => {
          const safeSubject = subj.replace(/[.#$\[\]]/g, '');
          const val = studentGrades[safeSubject] !== undefined ? studentGrades[safeSubject] : (studentGrades[subj] !== undefined ? studentGrades[subj] : '');
          // tabindex goes down each column first: col0(row0,row1,...), col1(row0,row1,...), ...
          const tabIdx = (sIdx * totalRows) + idx + 1;
          cells += `<td>
            <input type="text" inputmode="numeric" pattern="[0-9]*" class="praktek-input"
              data-student-id="${student.id}"
              data-subject="${subj}"
              data-row="${idx}"
              data-col="${sIdx}"
              value="${val}"
              enterkeyhint="enter"
              tabindex="${tabIdx}"
              onkeydown="handlePraktekKeydown(event, this)"
              oninput="if(this.value > 100) this.value = 100;"
              placeholder="—"
            >
          </td>`;
        });
        bodyRows += `<tr>${cells}</tr>`;
      });

      gridContainer.innerHTML = `
        <div class="p-4 bg-orange-50 border-b border-orange-200 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <i class="fas fa-table text-orange-500"></i>
            <span class="font-bold text-slate-700 text-sm">Kelas: ${selectedClass}</span>
            <span class="text-xs text-slate-400">|</span>
            <span class="text-xs text-slate-500">${students.length} siswa • ${visibleSubjects.length} mapel</span>
          </div>
          <div class="text-xs text-orange-600 font-semibold flex items-center gap-1">
            <i class="fas fa-info-circle"></i> Klik "Simpan Semua Nilai" untuk menyimpan
          </div>
        </div>
        <div class="overflow-auto" style="max-height: 70vh;">
          <table class="praktek-grid-table w-full border-collapse">
            <thead><tr>${headerCells}</tr></thead>
            <tbody>${bodyRows}</tbody>
          </table>
        </div>`;
    }).catch(err => {
      console.error('Gagal memuat data praktek:', err);
      gridContainer.innerHTML = `
        <div class="flex flex-col items-center justify-center h-48 text-red-400 p-8">
          <i class="fas fa-times-circle text-4xl mb-3"></i>
          <p class="font-semibold">Gagal memuat data</p>
          <p class="text-xs mt-1">${err.message}</p>
        </div>`;
    });
    }); // end ensureUsersLoaded.then
  };

  // --- SIMPAN SEMUA NILAI (Manual Save) ---
  window.simpanSemuaNilaiPraktek = () => {
    const selectedClass = document.getElementById('praktek-class-filter').value;
    if (!selectedClass) {
      Swal.fire('Peringatan', 'Pilih kelas terlebih dahulu.', 'warning');
      return;
    }

    const inputs = document.querySelectorAll('.praktek-input');
    if (inputs.length === 0) {
      Swal.fire('Peringatan', 'Tidak ada data untuk disimpan.', 'warning');
      return;
    }

    Swal.fire({
      title: 'Simpan Semua Nilai?',
      text: 'Semua nilai yang sudah diinput akan disimpan ke database.',
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#2563eb',
      cancelButtonColor: '#64748b',
      confirmButtonText: 'Ya, Simpan!',
      cancelButtonText: 'Batal'
    }).then(result => {
      if (!result.isConfirmed) return;

      Swal.fire({
        title: 'Menyimpan...',
        text: 'Harap tunggu, sedang menyimpan semua nilai.',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => { Swal.showLoading(); }
      });

      try {
        // Build update object
        const updates = {};
        inputs.forEach(input => {
          const studentId = input.dataset.studentId;
          const subject = input.dataset.subject;
          const safeSubject = subject.replace(/[.#$\[\]]/g, '');
          const value = input.value.trim();
          const path = 'Nilai_Praktek/' + selectedClass + '/' + studentId + '/' + safeSubject;
          if (value !== '' && !isNaN(value)) {
            updates[path] = Math.min(100, Number(value));
          } else {
            updates[path] = null; // remove empty
          }
        });

        database.ref().update(updates).then(() => {
          Swal.fire({
            icon: 'success',
            title: 'Berhasil Disimpan!',
            text: `Semua nilai kelas ${selectedClass} telah tersimpan.`,
            confirmButtonColor: '#2563eb'
          });
          // Visual feedback on all inputs
          inputs.forEach(inp => {
            inp.style.borderColor = '#22c55e';
            setTimeout(() => { inp.style.borderColor = '#e2e8f0'; }, 2000);
          });
        }).catch(err => {
          Swal.fire('Error', 'Gagal menyimpan: ' + err.message, 'error');
        });
      } catch (err) {
        Swal.fire('Error Validasi', 'Data mapel mengandung karakter tidak valid (seperti titik atau #). Silakan perbaiki di menu Data Master. Detail: ' + err.message, 'error');
      }
    });
  };

  // --- Apply Bulk Value to all rows for one subject column ---
  window.applyBulkPraktek = (colIdx, subjName) => {
    const bulkInput = document.getElementById('bulk-val-' + colIdx);
    const bulkVal = bulkInput ? bulkInput.value.trim() : '';
    if (bulkVal === '' || isNaN(bulkVal) || Number(bulkVal) < 0 || Number(bulkVal) > 100) {
      Swal.fire('Peringatan', 'Masukkan nilai yang valid (0-100).', 'warning');
      return;
    }
    const inputs = document.querySelectorAll(`.praktek-input[data-col="${colIdx}"]`);
    inputs.forEach(inp => {
      inp.value = bulkVal;
      inp.style.borderColor = '#3b82f6';
      setTimeout(() => { inp.style.borderColor = '#e2e8f0'; }, 1000);
    });
    Swal.fire({
      toast: true, position: 'top-end', icon: 'success',
      title: `Nilai ${bulkVal} diterapkan ke semua siswa untuk ${subjName}`,
      showConfirmButton: false, timer: 2000
    });
    bulkInput.value = '';
  };

  // --- Delete all grades for one subject ---
  window.hapusNilaiMapel = (subjName, colIdx) => {
    Swal.fire({
      title: `Hapus Semua Nilai ${subjName}?`,
      text: 'Nilai di kolom ini akan dikosongkan. Klik "Simpan Semua Nilai" untuk mengkonfirmasi penghapusan di database.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#ef4444',
      cancelButtonColor: '#64748b',
      confirmButtonText: 'Ya, Hapus!',
      cancelButtonText: 'Batal'
    }).then(result => {
      if (!result.isConfirmed) return;
      const inputs = document.querySelectorAll(`.praktek-input[data-col="${colIdx}"]`);
      inputs.forEach(inp => {
        inp.value = '';
        inp.style.borderColor = '#ef4444';
        setTimeout(() => { inp.style.borderColor = '#e2e8f0'; }, 1000);
      });
      Swal.fire({
      toast: true, position: 'top-end', icon: 'info',
        title: `Nilai ${subjName} dikosongkan. Jangan lupa klik Simpan!`,
        showConfirmButton: false, timer: 3000
      });
    });
  };

  // --- Handle Enter key to go to next row, same column ---
  window.handlePraktekKeydown = (e, input) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const row = parseInt(input.dataset.row);
      const col = parseInt(input.dataset.col);
      const nextRow = row + 1;
      const nextInput = document.querySelector(
        `.praktek-input[data-row="${nextRow}"][data-col="${col}"]`
      );
      if (nextInput) {
        nextInput.focus();
        nextInput.select();
      } else {
        Swal.fire({
          toast: true, position: 'bottom-end', icon: 'info',
          title: 'Sudah di baris terakhir', showConfirmButton: false, timer: 1500
        });
      }
    }
  };

  // --- Floating student name for mobile ---
  document.addEventListener('focusin', (e) => {
    if (!e.target.classList.contains('praktek-input')) return;
    if (window.innerWidth > 768) return; // only on mobile
    const row = e.target.closest('tr');
    if (!row) return;
    const nameCell = row.querySelector('.col-nama');
    const noCell = row.querySelector('.col-no');
    const floater = document.getElementById('praktek-floating-name');
    if (floater && nameCell) {
      document.getElementById('fname-text').textContent = (noCell ? noCell.textContent.trim() + '. ' : '') + nameCell.textContent.trim();
      document.getElementById('fname-subj').textContent = e.target.dataset.subject || '';
      floater.style.display = 'block';
    }
  });
  document.addEventListener('focusout', (e) => {
    if (!e.target.classList.contains('praktek-input')) return;
    setTimeout(() => {
      const active = document.activeElement;
      if (!active || !active.classList.contains('praktek-input')) {
        const floater = document.getElementById('praktek-floating-name');
        if (floater) floater.style.display = 'none';
      }
    }, 100);
  });

  // --- Export Excel ---
  window.exportPraktekExcel = () => {
    const selectedClass = document.getElementById('praktek-class-filter').value;
    if (!selectedClass) {
      Swal.fire('Peringatan', 'Pilih kelas terlebih dahulu.', 'warning');
      return;
    }

    const table = document.querySelector('.praktek-grid-table');
    if (!table) {
      Swal.fire('Peringatan', 'Tidak ada data untuk diexport.', 'warning');
      return;
    }

    const visibleSubjects = getVisiblePracticeSubjects();
    const rows = table.querySelectorAll('tbody tr');
    const data = [];

    const header = ['No', 'Nama Siswa', ...visibleSubjects];
    data.push(header);

    rows.forEach(row => {
      const cells = row.querySelectorAll('td');
      const rowData = [];
      rowData.push(cells[0].textContent.trim());
      rowData.push(cells[1].textContent.trim());
      for (let i = 2; i < cells.length; i++) {
        const inp = cells[i].querySelector('input');
        rowData.push(inp && inp.value ? Number(inp.value) : '');
      }
      data.push(rowData);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(data);
    ws['!cols'] = [
      { wch: 5 },
      { wch: 30 },
      ...visibleSubjects.map(() => ({ wch: 14 }))
    ];

    XLSX.utils.book_append_sheet(wb, ws, selectedClass);
    XLSX.writeFile(wb, 'Nilai_Praktek_' + selectedClass + '.xlsx');

    Swal.fire({
      toast: true, position: 'top-end', icon: 'success',
      title: 'Excel berhasil didownload!', showConfirmButton: false, timer: 2000
    });
  };

  // --- Export PDF (Landscape) - uses new window for full content ---
  window.exportPraktekPDF = () => {
    const selectedClass = document.getElementById('praktek-class-filter').value;
    if (!selectedClass) {
      Swal.fire('Peringatan', 'Pilih kelas terlebih dahulu.', 'warning');
      return;
    }

    const table = document.querySelector('.praktek-grid-table');
    if (!table) {
      Swal.fire('Peringatan', 'Tidak ada data untuk diexport.', 'warning');
      return;
    }

    const visibleSubjects = getVisiblePracticeSubjects();
    const rows = table.querySelectorAll('tbody tr');
    
    // Attempt to grab logo from login or dashboard images, fallback if none
    const logoImg = document.getElementById('login-logo-img') || document.querySelector('.sidebar-logo') || document.querySelector('img[src*="logo"]');
    const logoUrl = logoImg ? logoImg.src : 'https://via.placeholder.com/150';

    let tableHtml = `<!DOCTYPE html><html><head><meta charset="utf-8">
      <title>Nilai Praktek ${selectedClass}</title>
      <style>
        @page { size: landscape; margin: 10mm; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 11px; color: #1e293b; padding: 5mm; }
        .header { text-align: center; margin-bottom: 25px; position: relative; }
        .header .logo { position: absolute; left: 15px; top: 0; width: 85px; height: auto; }
        .header h1 { font-size: 16px; font-weight: bold; margin-bottom: 3px; font-family: 'Times New Roman', Times, serif; }
        .header h2 { font-size: 20px; font-weight: bold; margin-bottom: 3px; font-family: 'Times New Roman', Times, serif; }
        .header p { font-size: 10px; color: #1e293b; margin-top: 2px; }
        .header .small-text { font-size: 9px; font-weight: bold; }
        .header-line { margin-top: 10px; margin-bottom: 2px; border: 0; border-top: 3px solid #000; display: block; }
        .header-line-thin { border: 0; border-top: 1px solid #000; margin-bottom: 20px; display: block; }
        .doc-title { text-align: center; margin-bottom: 15px; }
        .doc-title h3 { font-size: 14px; text-decoration: underline; font-weight: bold; }
        .doc-title p { font-size: 11px; margin-top: 3px; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        thead { display: table-header-group; }
        tr { page-break-inside: avoid; }
        th { background: #1e293b; color: white; border: 1px solid #475569; padding: 6px 5px; text-align: center; font-size: 9px; text-transform: uppercase; letter-spacing: 0.03em; }
        td { border: 1px solid #cbd5e1; padding: 5px 6px; text-align: center; }
        td.nama { text-align: left; font-weight: 500; }
        tr:nth-child(even) { background: #f8fafc; }
        .footer { margin-top: 25px; display: flex; justify-content: flex-end; page-break-inside: avoid; }
        .ttd { text-align: center; min-width: 180px; font-size: 10px; color: #475569; }
        .ttd .line { border-top: 1px solid #1e293b; margin-top: 60px; padding-top: 3px; }
      </style>
    </head><body>
      <div class="header">
        <img src="${logoUrl}" class="logo" alt="Logo KOP Surat" crossorigin="anonymous">
        <h1>YAYASAN BUSTANUL ULUM ROKAN HILIR</h1>
        <h2>MADRASAH TSANAWIYAH BUSTANUL ULUM</h2>
        <p class="small-text">KEC. BAGAN SINEMBAH RAYA KAB. ROKAN HILIR PROV. RIAU</p>
        <p>Terakreditasi B</p>
        <p class="small-text">AKTA NOTARIS 37/2016 &nbsp;&nbsp;|&nbsp;&nbsp; PIAGAM NO. Kd.04.8/3/pp.00.4/MTs/1225/2010</p>
        <p class="small-text">IJOP : 59 Tahun 2010 &nbsp;&nbsp;|&nbsp;&nbsp; NSM : 121214070048 &nbsp;&nbsp;|&nbsp;&nbsp; NPSN : 10499236</p>
        <p style="font-style: italic;">Alamat : Panca Mukti Kec. Bagan Sinembah Raya Kab. Rokan Hilir Kode Pos. 28992</p>
      </div>
      <hr class="header-line"><hr class="header-line-thin">
      <div class="doc-title">
        <h3>DAFTAR NILAI PRAKTEK</h3>
        <p>Kelas: <strong>${selectedClass}</strong> &nbsp;|&nbsp; Dicetak: ${new Date().toLocaleDateString('id-ID', {day:'2-digit',month:'long',year:'numeric'})}</p>
      </div>
      <table>
        <thead><tr>
          <th style="width:30px;">No</th>
          <th style="text-align:left; min-width:150px;">Nama Siswa</th>`;

    visibleSubjects.forEach(subj => {
      tableHtml += `<th style="min-width:55px;">${subj}</th>`;
    });

    tableHtml += `</tr></thead><tbody>`;

    rows.forEach((row, idx) => {
      const cells = row.querySelectorAll('td');
      tableHtml += `<tr>`;
      tableHtml += `<td style="font-weight:600; color:#94a3b8;">${cells[0].textContent.trim()}</td>`;
      tableHtml += `<td class="nama">${cells[1].textContent.trim()}</td>`;
      for (let i = 2; i < cells.length; i++) {
        const inp = cells[i].querySelector('input');
        const val = inp && inp.value ? inp.value : '-';
        tableHtml += `<td style="font-weight:600;">${val}</td>`;
      }
      tableHtml += `</tr>`;
    });

    tableHtml += `</tbody></table>
      <div class="footer">
        <div class="ttd">
          <p>Mengetahui,</p>
          <p>Guru Mata Pelajaran</p>
          <div class="line">( _________________________ )</div>
          <p style="font-size:9px; color:#94a3b8; margin-top:2px;">NIP.</p>
        </div>
      </div>
    </body></html>`;

    // Open in new window for proper multi-page printing
    const printWin = window.open('', '_blank', 'width=1100,height=700');
    printWin.document.write(tableHtml);
    printWin.document.close();
    printWin.onload = () => {
      printWin.focus();
      printWin.print();
      printWin.onafterprint = () => printWin.close();
    };
  };

  // --- Auto load Master Data if not loaded yet ---
  if (!masterData.practice_subjects || masterData.practice_subjects.length === 0) {
    database.ref('Master_Data').once('value').then(snap => {
      const data = snap.val() || {};
      masterData = { ...masterData, ...data };
    });
  }
}

/* ==========================================================================
   1. DASHBOARD OVERVIEW
   ========================================================================== */

function renderAdminHome(container) {
  const totalExams = cachedExams.length;
  const activeExams = cachedExams.filter(e => e.status === 'Aktif' || e.status === 'Open').length;
  const draftExams = totalExams - activeExams;

  // --- LOGIKA BARU: MENGHITUNG JUMLAH MATA PELAJARAN (UNIK) ---
  const uniqueSubjects = [...new Set(cachedExams.map(e => e.subject.trim()))].length;

  container.innerHTML = `
    <div class="fade-in w-full space-y-6">
       
       <div class="dash-card p-6 flex flex-col md:flex-row md:items-center justify-between gap-6">
           <div>
               <div class="flex items-center gap-3 mb-1">
                  <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center text-white shadow-md">
                      <i class="fas fa-home"></i>
                  </div>
                  <h2 class="text-xl font-bold text-slate-800 tracking-tight">Dashboard Overview</h2>
               </div>
               <p class="text-slate-500 text-sm ml-14">Selamat datang kembali, pantau aktivitas ujian hari ini.</p>
           </div>
           <div class="flex flex-col sm:flex-row items-center gap-4 w-full md:w-auto">
               <div class="hidden lg:block text-right pr-4 border-r border-slate-200">
                  <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Hari Ini</p>
                  <p class="text-sm font-bold text-slate-700">
                      ${new Date().toLocaleDateString('id-ID', {weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'})}
                  </p>
               </div>
               <div class="flex gap-3 w-full sm:w-auto">
                <button onclick="refreshDashboard()" class="flex-1 sm:flex-none bg-white border border-slate-200 text-slate-600 px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-slate-50 hover:text-blue-600 shadow-sm transition flex items-center justify-center gap-2">
                  <i class="fas fa-sync-alt"></i> <span>Refresh</span>
                </button>
                   <button onclick="openExamModal()" class="flex-1 sm:flex-none bg-blue-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition flex items-center justify-center gap-2 transform active:scale-95">
                      <i class="fas fa-plus"></i> <span>Buat Ujian</span>
                   </button>
               </div>
           </div>
       </div>

       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          
          <div class="dash-card p-6 relative group overflow-hidden">
             <div class="flex justify-between items-start z-10 relative">
                 <div>
                     <p class="text-slate-500 text-[10px] font-extrabold uppercase tracking-widest mb-2">Total Jadwal</p>
                     <h3 class="text-3xl font-black text-slate-800">${totalExams}</h3>
                 </div>
                 <div class="stat-card-icon bg-blue-50 text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                     <i class="fas fa-book"></i>
                 </div>
             </div>
             <div class="mt-4 flex items-center text-xs font-medium">
                 <span class="text-blue-600 bg-blue-50 px-2 py-1 rounded-md border border-blue-100 mr-2">
                    <i class="fas fa-check-circle mr-1"></i>${activeExams} Aktif
                 </span>
                 <span class="text-slate-400">${draftExams} Non-Aktif</span>
             </div>
          </div>

          <div class="dash-card p-6 relative group overflow-hidden">
             <div class="flex justify-between items-start z-10 relative">
                 <div>
                     <p class="text-slate-500 text-[10px] font-extrabold uppercase tracking-widest mb-2">Status Peserta</p>
                      <h3 class="text-3xl font-black text-slate-800">Online</h3>
                 </div>
                 <div class="stat-card-icon bg-emerald-50 text-emerald-600 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                     <i class="fas fa-users"></i>
                 </div>
             </div>
             <div class="mt-4 flex items-center text-xs font-medium">
                 <span class="text-emerald-600 bg-emerald-50 px-2 py-1 rounded-md border border-emerald-100 mr-2">
                     <i class="fas fa-wifi mr-1"></i>Sistem Stabil
                 </span>
             </div>
          </div>

          <div class="dash-card p-6 relative group overflow-hidden">
             <div class="flex justify-between items-start z-10 relative">
                 <div>
                     <p class="text-slate-500 text-[10px] font-extrabold uppercase tracking-widest mb-2">Bank Soal</p>
                     <h3 class="text-3xl font-black text-slate-800">${uniqueSubjects}</h3>
                 </div>
                 <div class="stat-card-icon bg-purple-50 text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                     <i class="fas fa-database"></i>
                 </div>
             </div>
             <div class="mt-4 text-xs font-medium text-slate-500">
                 <span class="text-purple-600 bg-purple-50 px-2 py-1 rounded-md border border-purple-100 mr-2">
                    <i class="fas fa-layer-group mr-1"></i>Mapel
                 </span>
                 Terdaftar di sistem
             </div>
          </div>

          <div class="dash-card p-6 relative group overflow-hidden">
             <div class="flex justify-between items-start z-10 relative">
                 <div>
                     <p class="text-slate-500 text-[10px] font-extrabold uppercase tracking-widest mb-2">Mode Akses</p>
                     <h3 class="text-2xl font-black text-slate-800 truncate">${currentUser ? currentUser.role : 'Admin'}</h3>
                 </div>
                 <div class="stat-card-icon bg-orange-50 text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition-colors">
                     <i class="fas fa-user-shield"></i>
                 </div>
             </div>
             <div class="mt-4 text-xs font-medium text-slate-500 flex items-center gap-1">
                 <i class="far fa-clock"></i> ${new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})} WIB
             </div>
          </div>
       </div>

       <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 dash-card p-6">
              <div class="flex items-center justify-between mb-6 pb-4 border-b border-slate-100">
                  <h3 class="font-bold text-slate-800 text-lg">Aktivitas Terkini</h3>
                  <button class="text-xs text-blue-600 font-bold hover:bg-blue-50 px-3 py-1 rounded-lg transition">Lihat Log Lengkap</button>
              </div>
              <div class="pl-2 space-y-1">
                  <div class="timeline-item">
                      <div class="timeline-dot bg-emerald-500 ring-4 ring-emerald-50"></div>
                      <p class="text-sm font-bold text-slate-700">Login Berhasil</p>
                      <p class="text-xs text-slate-500 mt-1">Anda masuk sebagai Administrator.</p>
                      <span class="text-[10px] font-bold text-slate-400 mt-1 block bg-slate-100 w-fit px-2 rounded">Baru saja</span>
                  </div>
                  <div class="timeline-item">
                      <div class="timeline-dot bg-blue-500"></div>
                      <p class="text-sm font-bold text-slate-700">Sinkronisasi Data</p>
                      <p class="text-xs text-slate-500 mt-1">Mengambil data ujian terbaru dari database.</p>
                      <span class="text-[10px] font-bold text-slate-400 mt-1 block">1 menit yang lalu</span>
                  </div>
                  <div class="timeline-item">
                      <div class="timeline-dot bg-slate-300"></div>
                      <p class="text-sm font-bold text-slate-700">Sistem Siap</p>
                      <p class="text-xs text-slate-500 mt-1">Menunggu interaksi pengguna.</p>
                  </div>
             </div>
          </div>

          <div class="dash-card bg-slate-900 border-slate-800 text-white flex flex-col overflow-hidden">
              <div class="p-6 bg-gradient-to-br from-slate-800 to-slate-900 flex-1">
                  <h3 class="font-bold text-lg mb-2 flex items-center gap-2">
                   <i class="fas fa-info-circle text-blue-400"></i> Informasi Penting
                  </h3>
                  <p class="text-slate-400 text-xs mb-6 leading-relaxed border-b border-slate-700 pb-4">
                      Refresh Data setelah melakukan perubahan pada aplikasi.
                  </p>
                  
                  <div class="space-y-3">
                      <div class="flex items-start gap-3 p-3 bg-slate-800/50 rounded-lg border border-slate-700 hover:border-slate-600 transition">
                          <i class="fas fa-shield-alt text-yellow-400 mt-1"></i>
                          <div>
                              <strong class="block text-sm text-slate-200">Anti-Cheat</strong>
                              <span class="text-[11px] text-slate-500">Aktif otomatis untuk sesi siswa.</span>
                          </div>
                      </div>
                      <div class="flex items-start gap-3 p-3 bg-slate-800/50 rounded-lg border border-slate-700 hover:border-slate-600 transition">
                          <i class="fab fa-google-drive text-green-400 mt-1"></i>
                          <div>
                              <strong class="block text-sm text-slate-200">Database</strong>
                              <span class="text-[11px] text-slate-500">Terhubung ke Firebase Real-Time.</span>
                          </div>
                      </div>
                  </div>
              </div>
              <div class="bg-slate-950 p-3 text-center text-[10px] text-slate-600 font-mono">
                  Created by Operator Madrasah
              </div>
          </div>
       </div>
    </div>`;
}


/* ==========================================================================
   2. MANAJEMEN JADWAL UJIAN (TABLE & MODAL)
   ========================================================================== */

function renderExamForm(container) {
  // --- 1. SETUP FILTER ---
  window.filterExams = () => {
    const textVal = document.getElementById('search-exam-text').value.toLowerCase();
    const classVal = document.getElementById('filter-exam-class').value;
    const statusVal = document.getElementById('filter-exam-status').value;

    const rows = document.querySelectorAll('.exam-row');
    let count = 0;
    rows.forEach(r => {
      const txt = r.innerText.toLowerCase();
      const rowClass = r.getAttribute('data-class');
      const rowStatus = r.getAttribute('data-status');

      const matchText = txt.includes(textVal);
      const matchClass = classVal === '' || rowClass === classVal;
      const matchStatus = statusVal === '' || rowStatus === statusVal;

      if (matchText && matchClass && matchStatus) {
        r.style.display = '';
        count++;
      } else {
        r.style.display = 'none';
      }
    });
    
    // Toggle empty state message if needed
    const emptyMsg = document.getElementById('exam-empty-msg');
    if (emptyMsg) {
      emptyMsg.style.display = count === 0 ? '' : 'none';
    }
  };

  // Build Options for Class Filter
  const uniqueClasses = [...new Set(cachedExams.map(e => e.class))].sort();
  let classOptions = '<option value="">Semua Kelas</option>';
  uniqueClasses.forEach(c => {
    classOptions += `<option value="${c}">${c}</option>`;
  });

  // --- 2. HTML STRUCTURE ---
  let html = `
    <div class="fade-in w-full space-y-4">
       <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
           <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
               <div>
                   <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                       <i class="fas fa-calendar-alt text-blue-600"></i> Manajemen Jadwal Ujian
                   </h2>
                   <p class="text-sm text-slate-500 mt-1">Kelola jadwal, durasi, dan PIN sesi ujian siswa.</p>
               </div>
               <button onclick="openExamModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-blue-500/30 transition flex items-center gap-2 transform active:scale-95 whitespace-nowrap">
                  <i class="fas fa-plus"></i> Buat Jadwal Baru
               </button>
           </div>

           <div class="flex flex-col lg:flex-row gap-3 w-full">
               <div class="relative flex-1 group">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                     <i class="fas fa-search text-slate-400 group-focus-within:text-blue-500 transition"></i>
                  </div>
                  <input type="text" id="search-exam-text" placeholder="Cari Mata Pelajaran atau Kelas..." onkeyup="filterExams()" 
                         class="pl-10 pr-4 py-3 w-full border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition shadow-sm bg-slate-50 focus:bg-white text-slate-700">
               </div>
               <div class="flex gap-3 w-full lg:w-auto">
                   <select id="filter-exam-class" onchange="filterExams()" class="w-full lg:w-40 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none text-slate-700 bg-slate-50 focus:bg-white transition cursor-pointer shadow-sm">
                       ${classOptions}
                   </select>
                   <select id="filter-exam-status" onchange="filterExams()" class="w-full lg:w-48 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none text-slate-700 bg-slate-50 focus:bg-white transition cursor-pointer shadow-sm">
                       <option value="">Semua Status</option>
                       <option value="aktif">Aktif</option>
                       <option value="non-aktif">Non-Aktif</option>
                   </select>
               </div>
           </div>
       </div>

       <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
          <div class="overflow-x-auto">
             <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-50 border-b border-slate-200 text-slate-600 text-xs uppercase tracking-wider"> 
                        <th class="w-16 text-center pl-6 py-4 font-bold">No</th> 
                        <th class="py-4 font-bold">Mata Pelajaran & Kelas</th>
                        <th class="py-4 font-bold">Waktu Mulai & Selesai</th>
                        <th class="text-center py-4 font-bold">PIN Sesi</th>
                        <th class="text-center py-4 font-bold">Status</th>
                        <th class="text-right pr-6 py-4 font-bold">Aksi</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-slate-100">`;

  // --- 3. LOOP DATA ---
  if (!cachedExams || cachedExams.length === 0) {
    html += `
        <tr id="exam-empty-msg">
            <td colspan="6" class="p-12 text-center text-slate-400">
               <div class="flex flex-col items-center justify-center">
                   <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3 text-slate-300">
                       <i class="fas fa-calendar-times text-3xl"></i>
                   </div>
                   <p class="font-medium">Jadwal ujian tidak ditemukan.</p>
               </div>
            </td>
        </tr>`;
  } else {
    html += `
        <tr id="exam-empty-msg" style="display:none;">
            <td colspan="6" class="p-12 text-center text-slate-400">
               <div class="flex flex-col items-center justify-center">
                   <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3 text-slate-300">
                       <i class="fas fa-search text-3xl"></i>
                   </div>
                   <p class="font-medium">Tidak ada jadwal yang sesuai dengan filter.</p>
               </div>
            </td>
        </tr>`;
    cachedExams.forEach((exam, idx) => {
      // Logic Status Badge
      const isActive = String(exam.status).toLowerCase() === 'aktif';
      const statusBadge = isActive ?
        `<div class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mr-1.5"></span>AKTIF</div>` :
        `<div class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-500 border border-slate-200"><span class="w-1.5 h-1.5 rounded-full bg-slate-400 mr-1.5"></span>NON-AKTIF</div>`;

      const initial = exam.subject ? exam.subject.charAt(0).toUpperCase() : '?';
      const endDateDisplay = exam.endDateStr ? exam.endDateStr : '?';

      html += `
        <tr class="exam-row hover:bg-slate-50 transition group" data-class="${exam.class}" data-status="${isActive ? 'aktif' : 'non-aktif'}">
            <td class="p-4 pl-6 text-center text-slate-400 font-medium text-xs">${idx + 1}</td>
            <td class="p-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 text-white flex items-center justify-center font-bold text-lg shadow-sm shrink-0">
                         ${initial}
                    </div>
                    <div>
                        <div class="font-bold text-slate-800 text-sm line-clamp-1" title="${exam.subject}">${exam.subject}</div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-0.5 rounded border border-slate-200">${exam.class}</span>
                        </div>
                    </div>
                </div>
            </td>
            <td class="p-4">
                <div class="flex flex-col gap-1">
                    <div class="text-sm font-medium text-slate-700 flex items-center gap-2">
                         <i class="far fa-calendar-alt text-blue-500 w-4"></i> ${exam.dateStr}
                    </div>
                    <div class="text-xs text-slate-500 flex items-center gap-2">
                         <i class="far fa-calendar-check text-slate-400 w-4"></i> Sampai: <span class="text-slate-600 font-medium">${endDateDisplay}</span>
                    </div>
                    <div class="text-xs text-slate-400 flex items-center gap-2 mt-0.5">
                         <i class="far fa-clock text-slate-300 w-4"></i> ${exam.duration} Menit
                    </div>
                </div>
            </td>
            <td class="p-4 text-center">
                <div class="font-mono bg-yellow-50 text-yellow-800 px-3 py-1.5 rounded-lg border border-yellow-200 font-bold inline-block select-all text-sm tracking-widest shadow-sm cursor-help" title="PIN Siswa">
                     ${exam.pin}
                </div>
            </td>
            <td class="p-4 text-center cursor-pointer" onclick="toggleExamStatus('${exam.id}', '${exam.status === 'Aktif' ? 'Non-Aktif' : 'Aktif'}')" title="Klik untuk ubah status">
                ${statusBadge}
            </td>
            <td class="p-4 pr-6 text-right">
                <div class="flex justify-end gap-2 opacity-80 group-hover:opacity-100 transition">
                    <button onclick='openExamModal(${JSON.stringify(exam)})' class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white transition flex items-center justify-center shadow-sm border border-indigo-100" title="Edit">
                         <i class="fas fa-pen-to-square text-xs"></i>
                    </button>
                    <button onclick="handleDeleteExam('${exam.id}')" class="w-8 h-8 rounded-lg bg-red-50 text-red-600 hover:bg-red-600 hover:text-white transition flex items-center justify-center shadow-sm border border-red-100" title="Hapus">
                        <i class="fas fa-trash-can text-xs"></i>
                    </button>
                </div>
            </td>
        </tr>`;
    });
  }

  html += `</tbody></table></div></div></div>`;

  // Inject HTML
  container.innerHTML = html;

  // --- 4. INIT MODAL (Cek agar tidak duplikat) ---
  if (!document.getElementById('examModal')) {
    initExamModalComponent();
  }
}

// --- FUNGSI BARU: INISIALISASI MODAL UJIAN SECARA GLOBAL ---
function initExamModalComponent() {
  if (!document.getElementById('examModal')) {
    const modalHtml = `
      <div id="examModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
         <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeExamModal()"></div>
         
         <div class="relative w-full max-w-lg bg-white rounded-2xl shadow-2xl flex flex-col max-h-[90vh] animate-[fadeIn_0.3s_ease-out] z-[101]">
             
             <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50 shrink-0 rounded-t-2xl">
                 <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                     <i class="far fa-calendar-alt text-blue-600"></i>
                     <span id="examModalTitle">Jadwal Ujian</span>
                 </h3>
                 <button type="button" onclick="closeExamModal()" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-400 hover:bg-red-100 hover:text-red-500 transition focus:outline-none">
                     <i class="fas fa-times"></i>
                 </button>
             </div>
             
             <div class="overflow-y-auto p-6 custom-scrollbar">
                 <form id="examForm" onsubmit="handleExamSubmit(event)" class="space-y-5">
                     <input type="hidden" name="examId" id="input-examId">
                     
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                             <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Mata Pelajaran</label>
                             <select name="subject" id="input-subject" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm bg-white text-slate-700" required>
                                 <option value="">-- Pilih Mapel --</option>
                             </select>
                         </div>
                         <div>
                             <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pilih Kelas (Bisa lebih dari satu)</label>
                             <div id="input-class-container" class="max-h-36 overflow-y-auto p-3 bg-slate-50 border border-slate-300 rounded-lg space-y-2">
                                 <p class="text-xs text-slate-400">Memuat daftar kelas...</p>
                             </div>
                         </div>
                     </div>

                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                             <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Waktu Mulai</label>
                             <input type="datetime-local" name="date" id="input-date" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm text-slate-600" required>
                         </div>
                         <div>
                             <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Waktu Selesai</label>
                             <input type="datetime-local" name="endDate" id="input-endDate" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm text-slate-600" required>
                         </div>
                     </div>
                     
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                             <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Durasi (Menit)</label>
                             <div class="relative">
                                 <span class="absolute left-3 top-2.5 text-slate-400"><i class="far fa-clock"></i></span>
                                 <input type="number" name="duration" id="input-duration" class="pl-9 w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm" placeholder="60" required>
                             </div>
                         </div>
                         <div>
                             <label class="block text-xs font-bold text-slate-500 uppercase mb-1">PIN Sesi</label>
                             <div class="flex items-center gap-2">
                                 <div class="relative flex-1">
                                     <span class="absolute left-3 top-2.5 text-yellow-500"><i class="fas fa-key"></i></span>
                                     <input type="text" name="pin" id="input-pin" class="pl-10 w-full bg-yellow-50 border border-yellow-200 p-2.5 rounded-lg font-mono tracking-widest font-bold focus:ring-2 focus:ring-yellow-400 outline-none transition text-slate-800" placeholder="12345" required>
                                 </div>
                                 <button type="button" onclick="document.getElementById('input-pin').value = Math.floor(10000 + Math.random() * 90000)" class="h-11 px-4 bg-yellow-100 hover:bg-yellow-200 text-yellow-700 border border-yellow-300 rounded-lg flex items-center justify-center font-bold transition shadow-sm" title="Generate PIN Otomatis">
                                     <i class="fas fa-sync-alt"></i>
                                 </button>
                             </div>
                         </div>
                     </div>
                     
                     <div class="pt-4 border-t border-slate-100 mt-2">
                         <button type="submit" id="btnSaveExam" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 transition active:scale-95 flex justify-center items-center gap-2">
                             <i class="fas fa-save"></i> Simpan Jadwal
                         </button>
                     </div>
                 </form>
             </div>
         </div>
      </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  }
}

// Helper untuk menutup modal
function closeExamModal() {
  const modal = document.getElementById('examModal');
  if (modal) modal.classList.add('hidden');
}


/* ==========================================================================
   3. HANDLERS (SUBMIT, DELETE, STATUS, REFRESH)
   ========================================================================== */

function handleExamSubmit(e) {
  e.preventDefault();
  const fd = new FormData(e.target);
  const data = Object.fromEntries(fd.entries());

  // [NEW] Read multiple classes from checkboxes
  const selectedClasses = [];
  const classCheckboxes = document.querySelectorAll('#input-class-container input[type="checkbox"]:checked');
  classCheckboxes.forEach(cb => {
    selectedClasses.push(cb.value);
  });

  if (selectedClasses.length === 0) {
    Swal.fire('Validasi Gagal', 'Anda harus memilih setidaknya satu kelas.', 'warning');
    return; // Stop submission
  }
  data.class = selectedClasses.join(','); // Join into a comma-separated string

  closeExamModal();
  document.getElementById('global-loading').classList.remove('hidden');

  if (data.examId) {
    // --- UPDATE via Firebase ---
    database.ref('Exams').orderByChild('ExamID').equalTo(data.examId).once('value').then(snap => {
      let key = null;
      snap.forEach(c => { key = c.key; });
      if (!key) { key = data.examId; }
      const updateData = {
        Subject: data.subject, Class: data.class, Date: data.date, EndDate: data.endDate,
        Duration: parseInt(data.duration), PIN: data.pin
      };
      return database.ref('Exams/' + key).update(updateData);
    }).then(() => {
      document.getElementById('global-loading').classList.add('hidden');
      Swal.fire('Berhasil', 'Data diperbarui!', 'success');
      refreshExamList();
    }).catch(err => {
      document.getElementById('global-loading').classList.add('hidden');
      Swal.fire('Gagal', err.message, 'error');
    });
  } else {
    // --- CREATE via Firebase ---
    const newExamId = 'EXAM_' + Date.now();
    // Auto-detect status berdasarkan tanggal
    let autoStatus = 'Non-Aktif';
    if (data.date && data.endDate) {
      const now = new Date();
      const start = new Date(data.date);
      const end = new Date(data.endDate);
      if (now >= start && now <= end) {
        autoStatus = 'Aktif';
      }
    }
    const newExam = {
      ExamID: newExamId, Subject: data.subject, Class: data.class,
      Date: data.date, EndDate: data.endDate, Duration: parseInt(data.duration),
      PIN: data.pin, Status: autoStatus
    };
    database.ref('Exams').push(newExam).then(() => {
      document.getElementById('global-loading').classList.add('hidden');
      Swal.fire('Berhasil', 'Jadwal dibuat!', 'success');
      refreshExamList();
    }).catch(err => {
      document.getElementById('global-loading').classList.add('hidden');
      Swal.fire('Gagal', err.message, 'error');
    });
  }
}

function handleDeleteExam(examId) {
  Swal.fire({
    title: 'Hapus Ujian?',
    text: "Data nilai terkait mungkin hilang.",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Ya, Hapus!'
  }).then((result) => {
    if (result.isConfirmed) {
      document.getElementById('global-loading').classList.remove('hidden');

      // Delete via Firebase
      database.ref('Exams').orderByChild('ExamID').equalTo(examId).once('value').then(snap => {
        const promises = [];
        snap.forEach(c => { promises.push(c.ref.remove()); });
        return Promise.all(promises);
      }).then(() => {
        document.getElementById('global-loading').classList.add('hidden');
        Swal.fire('Terhapus!', 'Data dihapus.', 'success');
        refreshExamList();
      }).catch(err => {
        document.getElementById('global-loading').classList.add('hidden');
        Swal.fire('Gagal', err.message, 'error');
      });
    }
  });
}

function toggleExamStatus(examId, currentStatus) {
  let newStatus = (currentStatus === 'Aktif') ? 'Non-Aktif' : 'Aktif';

  Swal.fire({ title: 'Memproses...', text: 'Mengubah status ujian...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

  database.ref('Exams').orderByChild('ExamID').equalTo(examId).once('value').then(snap => {
    const promises = [];
    snap.forEach(c => {
      const upd = { Status: newStatus };
      if (newStatus === 'Non-Aktif') { upd.Date = ''; upd.EndDate = ''; }
      promises.push(c.ref.update(upd));
    });
    return Promise.all(promises);
  }).then(() => {
    Swal.fire({ icon: 'success', title: 'Berhasil', text: newStatus === 'Non-Aktif' ? 'Status Non-Aktif. Waktu direset.' : 'Status Aktif.', timer: 1500, showConfirmButton: false });
    refreshExamList();
  }).catch(err => {
    Swal.fire('Gagal', err.message, 'error');
  });
}

function switchStatus(id, currentStatus) {
  toggleExamStatus(id, currentStatus);
}

function refreshExamList() {
  database.ref('Exams').once('value').then(snapshot => {
    const exams = [];
    snapshot.forEach(child => {
      const e = child.val();
      exams.push({
        id: e.ExamID || child.key, _key: child.key,
        subject: e.Subject || '', class: e.Class || '',
        date: e.Date || '', endDate: e.EndDate || '',
        dateStr: e.Date ? new Date(e.Date).toLocaleString('id-ID') : '-',
        endDateStr: e.EndDate ? new Date(e.EndDate).toLocaleString('id-ID') : '-',
        duration: e.Duration || 60, pin: e.PIN || '', status: getAutoExamStatus(e.Date, e.EndDate, e.Status)
      });
    });
    cachedExams = exams;
    renderExamForm(document.getElementById('admin-content'));
  });
}

function refreshDashboard() {
  const content = document.getElementById('admin-content');
  content.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-slate-400 fade-in"><i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-blue-500"></i> Memuat ulang data dashboard...</div>';

  database.ref('Exams').once('value').then(snapshot => {
    const exams = [];
    snapshot.forEach(child => {
      const e = child.val();
      exams.push({
        id: e.ExamID || child.key, _key: child.key,
        subject: e.Subject || '', class: e.Class || '',
        date: e.Date || '', endDate: e.EndDate || '',
        dateStr: e.Date ? new Date(e.Date).toLocaleString('id-ID') : '-',
        endDateStr: e.EndDate ? new Date(e.EndDate).toLocaleString('id-ID') : '-',
        duration: e.Duration || 60, pin: e.PIN || '', status: getAutoExamStatus(e.Date, e.EndDate, e.Status)
      });
    });
    cachedExams = exams;
    renderAdminHome(content);
  });
}


/* ==========================================================================
   4. BANK SOAL & IMPORT
   ========================================================================== */

function renderQuestionBank(container) {
  // Siapkan opsi dropdown dari data ujian yang ada
  let examOptions = cachedExams.map(e => `<option value="${e.id}">${e.subject} (${e.class})</option>`).join('');

  // Load Data Gambar jika belum ada
  if (allImagesData.length === 0) {
    database.ref('Gambar').once('value').then(snap => {
      const imgs = [];
      snap.forEach(c => { const d = c.val(); d._key = c.key; imgs.push(d); });
      allImagesData = imgs;
    });
  }

  container.innerHTML = `
    <div class="fade-in w-full space-y-4">
        
        <div class="dash-card p-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                <div>
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i class="fas fa-book-open text-blue-600"></i> Bank Soal
                    </h2>
                    <p class="text-sm text-slate-500 mt-1">Kelola pertanyaan, bobot nilai, dan kunci jawaban.</p>
                </div>
                
                <div class="flex gap-2 w-full md:w-auto flex-wrap justify-end">
                    <button onclick="resetQuestionForm(); document.getElementById('form-add-q').classList.remove('hidden'); document.getElementById('form-import-q').classList.add('hidden'); document.getElementById('form-import-excel').classList.add('hidden'); document.getElementById('form-copy-q').classList.add('hidden'); toggleOptionsInput('PG');"
                     class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg transition flex items-center gap-2 transform active:scale-95">
                        <i class="fas fa-plus"></i> <span class="hidden sm:inline">Manual</span>
                    </button>
                    
                    <button onclick="document.getElementById('form-import-q').classList.remove('hidden'); document.getElementById('form-add-q').classList.add('hidden'); document.getElementById('form-import-excel').classList.add('hidden'); document.getElementById('form-copy-q').classList.add('hidden');"
                     class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg transition flex items-center gap-2 transform active:scale-95">
                        <i class="fab fa-google"></i> <span class="hidden sm:inline">G-Form</span>
                    </button>

                    <button onclick="document.getElementById('form-import-excel').classList.remove('hidden'); document.getElementById('form-add-q').classList.add('hidden'); document.getElementById('form-import-q').classList.add('hidden'); document.getElementById('form-copy-q').classList.add('hidden');"
                     class="bg-green-700 hover:bg-green-800 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg transition flex items-center gap-2 transform active:scale-95">
                        <i class="fas fa-file-excel"></i> <span class="hidden sm:inline">Excel</span>
                    </button>

                    <button onclick="initCopyForm(); document.getElementById('form-copy-q').classList.remove('hidden'); document.getElementById('form-add-q').classList.add('hidden'); document.getElementById('form-import-q').classList.add('hidden'); document.getElementById('form-import-excel').classList.add('hidden');"
                     class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg transition flex items-center gap-2 transform active:scale-95">
                        <i class="fas fa-copy"></i> <span class="hidden sm:inline">Copy</span>
                    </button>
                </div>
            </div>

            <div class="relative w-full">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Pilih Mata Pelajaran Untuk Diedit</label>
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-slate-400 group-focus-within:text-blue-500 transition"></i>
                    </div>
                    <select id="select-exam-q" class="pl-10 pr-4 py-3 w-full border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition shadow-sm bg-slate-50 focus:bg-white text-slate-700 appearance-none cursor-pointer font-medium" onchange="loadQuestionsTable(this.value)">
                        <option value="">-- Silakan Pilih Mata Pelajaran --</option>${examOptions}
                    </select>
                    <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-slate-500">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>
        </div>

        <div id="form-import-q" class="hidden dash-card p-6 bg-emerald-50 border-emerald-100 fade-in">
            <div class="flex items-center justify-between mb-4 border-b border-emerald-200 pb-3">
                <div class="flex items-center gap-3 text-emerald-800">
                    <div class="w-10 h-10 rounded-lg bg-emerald-200 flex items-center justify-center text-emerald-700 shadow-sm"><i class="fab fa-google text-lg"></i></div>
                    <h3 class="font-bold text-lg">Import dari Google Form</h3>
                </div>
                <button onclick="document.getElementById('form-import-q').classList.add('hidden')" class="text-emerald-600 hover:bg-emerald-100 p-2 rounded-full transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="bg-white/60 p-4 rounded-xl border border-emerald-100 mb-4 text-sm text-emerald-700 flex items-start gap-3">
              <i class="fas fa-info-circle mt-0.5 text-lg"></i>
              <div>
                  <p class="font-bold">Panduan Import:</p>
                  <ul class="list-disc list-inside mt-1 space-y-1 text-xs">
                      <li>Pastikan Anda adalah <b>Pemilik (Owner)</b> formulir.</li>
                      <li>Salin link dari address bar saat membuka mode edit (akhiran <b>/edit</b>).</li>
                      <li>Fitur ini mendukung: Pilihan Ganda & Isian Singkat.</li>
                  </ul>
              </div>
            </div>
            
            <div class="flex flex-col md:flex-row gap-4">
              <div class="relative flex-1 group">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-emerald-500"><i class="fas fa-link"></i></div>
                  <input type="text" id="input-form-url" placeholder="Tempel Link Google Form di sini..." class="pl-10 w-full border border-emerald-200 p-3 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none bg-white transition shadow-sm">
              </div>
              <button onclick="triggerImport()" class="bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-emerald-700 transition shadow-lg flex items-center justify-center gap-2 transform active:scale-95 whitespace-nowrap">
                  <i class="fas fa-file-import"></i> Mulai Import
              </button>
            </div>
        </div>

        <div id="form-import-excel" class="hidden dash-card p-6 bg-green-50 border-green-200 fade-in">
            <div class="flex items-center justify-between mb-4 border-b border-green-200 pb-3">
                <div class="flex items-center gap-3 text-green-800">
                    <div class="w-10 h-10 rounded-lg bg-green-200 flex items-center justify-center text-green-700 shadow-sm"><i class="fas fa-file-excel text-lg"></i></div>
                    <h3 class="font-bold text-lg">Import Soal dari Excel</h3>
                </div>
                <button onclick="document.getElementById('form-import-excel').classList.add('hidden')" class="text-green-600 hover:bg-green-100 p-2 rounded-full transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex-1 space-y-4">
                    <div class="bg-white p-4 rounded-xl border border-green-200 text-sm text-slate-600">
                        <p class="font-bold text-green-700 mb-2"><i class="fas fa-info-circle"></i> Aturan Format Excel:</p>
                        <ul class="list-disc list-inside space-y-1 text-xs">
                            <li>Baris pertama harus <b>Header</b>. Data dimulai baris ke-2.</li>
                            <li>Kolom A: <b>Tipe</b> (PG / BS / JODOH / Esai).</li>
                            <li>Kolom B: <b>Pertanyaan/Cerita</b>.</li>
                            <li>Kolom C: <b>JSON Opsi/Kiri</b>.</li>
                            <li>Kolom D: <b>JSON Kunci</b>.</li>
                            <li>Kolom E: <b>Bobot</b> (Opsional, Default 10).</li>
                        </ul>
                        <button onclick="downloadTemplateExcel()" class="mt-3 text-xs font-bold text-blue-600 hover:underline"><i class="fas fa-download"></i> Download Template Excel</button>
                    </div>
                </div>

                <div class="flex-1 flex flex-col justify-center">
                    <label class="block mb-2 text-sm font-bold text-slate-600">Upload File (.xlsx)</label>
                    <input type="file" id="input-excel-file" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500
                      file:mr-4 file:py-2.5 file:px-4
                      file:rounded-full file:border-0
                      file:text-sm file:font-semibold
                      file:bg-green-100 file:text-green-700
                      hover:file:bg-green-200
                      cursor-pointer border border-green-200 rounded-xl bg-white p-2
                    "/>
                    <button onclick="processExcelImport()" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-lg transition flex items-center justify-center gap-2 transform active:scale-95">
                        <i class="fas fa-upload"></i> Proses Import
                    </button>
                </div>
            </div>
        </div>

        <div id="form-copy-q" class="hidden dash-card p-6 bg-sky-50 border-sky-200 fade-in">
            <div class="flex items-center justify-between mb-4 border-b border-sky-200 pb-3">
                <div class="flex items-center gap-3 text-sky-800">
                    <div class="w-10 h-10 rounded-lg bg-sky-200 flex items-center justify-center text-sky-700 shadow-sm"><i class="fas fa-copy text-lg"></i></div>
                    <h3 class="font-bold text-lg">Salin Soal Antar Jadwal Ujian</h3>
                </div>
                <button onclick="document.getElementById('form-copy-q').classList.add('hidden')" class="text-sky-600 hover:bg-sky-100 p-2 rounded-full transition"><i class="fas fa-times"></i></button>
            </div>
            
             <div class="bg-white/60 p-4 rounded-xl border border-sky-100 mb-4 text-sm text-sky-700 flex items-start gap-3">
              <i class="fas fa-info-circle mt-0.5 text-lg"></i>
              <div>
                  <p class="font-bold">Cara Penggunaan:</p>
                  <ul class="list-disc list-inside mt-1 space-y-1 text-xs">
                      <li>Pilih jadwal ujian <b>sumber</b> (soal akan disalin dari sini).</li>
                      <li>Pilih jadwal ujian <b>tujuan</b> (soal akan ditempelkan ke sini).</li>
                      <li>Semua soal dari sumber akan diduplikasi ke tujuan.</li>
                  </ul>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
              <div>
                  <label class="block text-xs font-bold text-slate-500 uppercase mb-1">1. Salin Dari Mapel (Sumber)</label>
                  <select id="copy-source-exam" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm bg-white text-slate-700"></select>
              </div>
              <div>
                  <label class="block text-xs font-bold text-slate-500 uppercase mb-1">2. Tempel Ke Mapel (Tujuan)</label>
                  <select id="copy-destination-exam" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm bg-white text-slate-700"></select>
              </div>
            </div>
             <div class="mt-4">
                 <button onclick="handleCopyQuestions()" class="w-full bg-sky-600 hover:bg-sky-700 text-white py-3 rounded-xl font-bold shadow-lg transition flex items-center justify-center gap-2 transform active:scale-95">
                     <i class="fas fa-clone"></i> Mulai Proses Penyalinan
                 </button>
             </div>
        </div>

      <div id="form-add-q" class="hidden dash-card p-6 border-blue-100 relative overflow-visible fade-in">
          <div class="flex items-center justify-between mb-6 border-b border-slate-100 pb-4">
             <div class="flex items-center gap-3">
                 <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600 shadow-sm"><i class="fas fa-pen-fancy"></i></div>
                 <h3 class="font-bold text-lg text-slate-800">Editor Soal Manual</h3>
             </div>
             <button onclick="resetQuestionForm(); document.getElementById('form-add-q').classList.add('hidden')" class="text-slate-400 hover:text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-lg transition text-sm font-bold flex items-center gap-1"><i class="fas fa-times"></i> Tutup</button>
          </div>
          
          <form onsubmit="handleAddQuestion(event)" class="space-y-5">
             <input type="hidden" name="examId" id="input-exam-id">
             <input type="hidden" name="questionId" id="input-question-id">

             <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
               <div>
                   <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tipe Soal</label>
                   <select name="type" id="q-type-select" class="w-full border border-slate-200 p-3 rounded-xl bg-slate-50 focus:bg-white outline-none focus:ring-2 focus:ring-blue-500 transition cursor-pointer" onchange="toggleOptionsInput(this.value)">
                      <option value="PG">Pilihan Ganda</option>
                      <option value="PG_KOMPLEKS">Pilihan Ganda Kompleks</option>
                      <option value="BS">Benar/Salah (AKM)</option>
                      <option value="JODOH">Menjodohkan</option>
                      <option value="Esai">Esai</option>
                   </select>
               </div>
               <div>
                   <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Status Wajib</label>
                   <select name="isRequired" class="w-full border border-slate-200 p-3 rounded-xl bg-slate-50 focus:bg-white outline-none focus:ring-2 focus:ring-blue-500 transition font-medium text-slate-700 cursor-pointer">
                      <option value="TRUE">Wajib Diisi</option>
                      <option value="FALSE">Opsional</option>
                   </select>
               </div>
               
               <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Bobot Nilai (Poin)</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400 pointer-events-none">
                            <i class="fas fa-weight-hanging"></i>
                        </span>
                        <input type="number" name="point" id="input-point" 
                            class="pl-10 w-full border border-slate-200 p-3 rounded-xl bg-slate-50 focus:bg-white outline-none focus:ring-2 focus:ring-blue-500 transition font-bold text-slate-700" 
                            placeholder="Default: 10" value="10" min="1">
                    </div>
               </div>
             </div>

             <div class="relative group">
                   <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Media Gambar (Link/Upload)</label>
                   <div class="flex gap-2">
                       <div class="relative flex-1">
                           <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400 pointer-events-none"><i class="far fa-image"></i></span>
                           <input type="text" name="image" id="input-image-ac" 
                               placeholder="Nama file gambar..." 
                               class="w-full border border-slate-200 p-3 pl-10 rounded-xl bg-slate-50 focus:bg-white outline-none focus:ring-2 focus:ring-blue-500 transition"
                               autocomplete="off"
                               onkeyup="handleImageAutocomplete(this)"
                               onfocus="handleImageAutocomplete(this)"
                               onblur="setTimeout(() => document.getElementById('ac-results').classList.add('hidden'), 200)">
                           
                           <div id="ac-results" class="hidden absolute z-50 left-0 right-0 mt-1 bg-white border border-slate-200 rounded-xl shadow-xl max-h-56 overflow-y-auto custom-scrollbar"></div>
                       </div>

                       <div class="w-1/3 md:w-1/4">
                           <select id="input-image-size" class="w-full border border-slate-200 p-3 rounded-xl bg-slate-50 focus:bg-white outline-none focus:ring-2 focus:ring-blue-500 transition font-medium text-slate-700 cursor-pointer">
                               <option value="w300">Kecil</option>
                               <option value="w600">Sedang</option>
                               <option value="w1000" selected>Besar</option>
                           </select>
                       </div>
                   </div>
             </div>

             <div>
                 <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Konten / Pertanyaan / Cerita</label>
                 <textarea id="editor-content" name="content" placeholder="Tulis teks pertanyaan atau pengantar cerita di sini..." class="w-full border border-slate-200 p-4 rounded-xl bg-slate-50 focus:bg-white h-32 focus:ring-2 focus:ring-blue-500 outline-none transition resize-y font-serif leading-relaxed"></textarea>
             </div>
             
             <div id="options-area" class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                <p class="text-xs font-bold text-slate-500 mb-3 flex items-center gap-2"><i class="fas fa-list-ul"></i> PILIHAN JAWABAN (A-E)</p>
                
                <div class="space-y-4">
                    <div class="flex flex-col gap-1">
                        <span class="font-bold text-slate-500 text-xs">Pilihan A</span>
                        <textarea id="opt-0" class="editor-option w-full border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none p-2" placeholder="Tulis jawaban A..."></textarea>
                    </div>
                    <div class="flex flex-col gap-1">
                        <span class="font-bold text-slate-500 text-xs">Pilihan B</span>
                        <textarea id="opt-1" class="editor-option w-full border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none p-2" placeholder="Tulis jawaban B..."></textarea>
                    </div>
                    <div class="flex flex-col gap-1">
                        <span class="font-bold text-slate-500 text-xs">Pilihan C</span>
                        <textarea id="opt-2" class="editor-option w-full border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none p-2" placeholder="Tulis jawaban C..."></textarea>
                    </div>
                    <div class="flex flex-col gap-1">
                        <span class="font-bold text-slate-500 text-xs">Pilihan D</span>
                        <textarea id="opt-3" class="editor-option w-full border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none p-2" placeholder="Tulis jawaban D..."></textarea>
                    </div>
                    <div class="flex flex-col gap-1">
                        <span class="font-bold text-slate-500 text-xs">Pilihan E</span>
                        <textarea id="opt-4" class="editor-option w-full border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none p-2" placeholder="Tulis jawaban E..."></textarea>
                    </div>
                </div>
             </div>

             <div id="pairs-area" class="hidden bg-slate-50 p-5 rounded-xl border border-slate-200">
                 <div class="flex justify-between items-center mb-3">
                   <p class="text-xs font-bold text-slate-500"><i class="fas fa-random"></i> PASANGAN MENJODOHKAN</p>
                   <button type="button" onclick="addPairInput()" class="text-blue-600 text-xs font-bold hover:underline bg-blue-50 px-2 py-1 rounded border border-blue-200 hover:bg-blue-100 transition">+ Tambah Baris</button>
                </div>
                <div class="grid grid-cols-12 gap-2 mb-2 px-1 text-[10px] font-bold text-slate-400 uppercase">
                    <div class="col-span-4">Kiri (Soal)</div>
                    <div class="col-span-4">Tengah (Opsi Pasangan)</div>
                    <div class="col-span-3">Kanan (Jawaban)</div>
                    <div class="col-span-1 text-center">Hapus</div>
                </div>
                <div id="pairs-container" class="space-y-2"></div>
             </div>
             
             <div id="bs-area" class="hidden bg-slate-50 p-5 rounded-xl border border-slate-200">
                 <div class="flex justify-between items-center mb-3">
                   <p class="text-xs font-bold text-slate-500"><i class="fas fa-tasks"></i> PERNYATAAN & KUNCI JAWABAN</p>
                   <button type="button" onclick="addBsRowInput()" class="text-emerald-600 text-xs font-bold hover:underline bg-emerald-50 px-2 py-1 rounded border border-emerald-200 hover:bg-emerald-100 transition">+ Tambah Pernyataan</button>
                </div>
                
                <div class="grid grid-cols-12 gap-2 mb-2 px-1 text-[10px] font-bold text-slate-400 uppercase">
                    <div class="col-span-8">Isi Pernyataan</div>
                    <div class="col-span-3">Kunci Jawaban</div>
                    <div class="col-span-1 text-center">Hapus</div>
                </div>
                
                <div id="bs-container" class="space-y-2"></div>
             </div>

             <div id="simple-key-area">
                 <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kunci Jawaban</label>
                 <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-green-600"><i class="fas fa-key"></i></div>
                    <input type="text" name="correct" id="correct-input" placeholder="Contoh: Pilihan A (Harus sama persis dengan teks opsi)" class="pl-10 w-full border border-green-200 p-3 rounded-xl font-medium bg-green-50 text-green-800 focus:ring-2 focus:ring-green-500 outline-none transition placeholder-green-700/50">
                 </div>
                 <p class="text-[10px] text-slate-400 mt-1 ml-1">*Untuk Esai, isi kata kunci jawaban.</p>
             </div>
             
             <button type="submit" class="w-full bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 transform active:scale-95">
                 <i class="fas fa-save"></i> Simpan Pertanyaan
             </button>
          </form>
      </div>

      </div>

      <div id="q-table-container" class="w-full mt-6 transition-all duration-300">
          <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-16 flex flex-col items-center justify-center animate-pulse w-full">
               <div class="w-12 h-12 bg-slate-200 rounded-full mb-3"></div>
               <div class="h-4 bg-slate-200 rounded w-48 mb-2"></div>
               <div class="h-3 bg-slate-100 rounded w-32"></div>
          </div>
      </div>
    </div>
    `;

  // --- INIT EDITOR SETELAH ELEMENT RENDER ---
  setTimeout(() => {
    initRichEditor();
    if(typeof renderExamCards === 'function') {
        renderExamCards();
    }
  }, 100);
}

// --- FUNGSI BARU: TAMPILKAN GRID KARTU UJIAN ---
window.renderExamCards = () => {
  const container = document.getElementById('q-table-container');
  if(!container) return;

  // Reset dropdown
  const selectExam = document.getElementById('select-exam-q');
  if(selectExam) selectExam.value = '';

  container.innerHTML = `
      <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-16 flex flex-col items-center justify-center animate-pulse w-full">
           <div class="w-12 h-12 bg-slate-200 rounded-full mb-3"></div>
           <div class="h-4 bg-slate-200 rounded w-48 mb-2"></div>
           <div class="h-3 bg-slate-100 rounded w-32"></div>
      </div>`;

  // 1. Ambil semua soal untuk menghitung per mapel
  database.ref('Questions').once('value').then(snap => {
      const qCounts = {};
      snap.forEach(child => {
          const q = child.val();
          if(q.ExamID) {
              qCounts[q.ExamID] = (qCounts[q.ExamID] || 0) + 1;
          }
      });

      // 2. Filter mapel di cachedExams yang memiliki soal dan sesuai Role
      let activeExams = cachedExams.filter(e => qCounts[e.id] > 0);

      // --- LOGIKA FILTER ROLE (GURU vs ADMIN) ---
      if (currentUser && currentUser.role === 'Guru') {
        const assignments = String(currentUser.class || '').split(',').map(a => a.trim());
        const teacherSubjects = assignments.map(a => {
            const parts = a.split(':');
            return parts[0] ? parts[0].trim().toLowerCase() : '';
        }).filter(Boolean);

        activeExams = activeExams.filter(e => {
            const examSubj = e.subject ? e.subject.toLowerCase().trim() : '';
            return teacherSubjects.includes(examSubj);
        });
      }

      if(activeExams.length === 0) {
          let emptyMessage = 'Silakan buat mapel baru atau impor soal dari Excel/Google Form.';
          if (currentUser && currentUser.role === 'Guru') {
              emptyMessage = 'Belum ada soal untuk mata pelajaran yang Anda ampu.';
          }
          container.innerHTML = `
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-16 text-center w-full fade-in">
                <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-100">
                    <i class="fas fa-folder-open text-3xl text-slate-300"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-600">Belum Ada Bank Soal</h3>
                <p class="text-sm text-slate-400 mt-1 max-w-xs mx-auto">${emptyMessage}</p>
            </div>`;
          return;
      }

      // 3. Render Grid Cards
      let cardsHtml = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 fade-in">`;
      
      activeExams.forEach(exam => {
          const count = qCounts[exam.id] || 0;
          const initial = exam.subject ? exam.subject.charAt(0).toUpperCase() : '?';
          cardsHtml += `
            <div class="relative bg-white rounded-2xl p-6 border border-slate-200 shadow-sm hover:shadow-xl transition-all duration-300 group cursor-pointer transform hover:-translate-y-1"
                 onclick="document.getElementById('select-exam-q').value = '${exam.id}'; loadQuestionsTable('${exam.id}');">
                
                <button onclick="event.stopPropagation(); deleteSemuaSoal('${exam.id}', '${exam.subject}')" 
                        class="absolute top-4 right-4 w-8 h-8 bg-red-50 text-red-500 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 hover:bg-red-500 hover:text-white transition-all duration-200 shadow-sm"
                        title="Hapus Semua Soal">
                    <i class="fas fa-trash-alt text-xs"></i>
                </button>

                <div class="flex flex-col items-center text-center">
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center font-bold text-3xl shadow-lg shadow-blue-500/30 mb-4 transform group-hover:scale-110 transition-transform duration-300">
                        ${initial}
                    </div>
                    <h3 class="font-bold text-slate-800 text-lg mb-1 line-clamp-1" title="${exam.subject}">${exam.subject}</h3>
                    <span class="text-xs font-bold leading-none bg-slate-100 text-slate-600 px-3 py-1.5 rounded-full mb-4 border border-slate-200">${exam.class}</span>
                    
                    <div class="w-full pt-4 border-t border-slate-100 mt-2 flex items-center justify-between text-sm">
                        <span class="text-slate-500 font-medium">Total Soal</span>
                        <span class="font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-lg">${count}</span>
                    </div>
                </div>
            </div>
          `;
      });
      cardsHtml += `</div>`;
      
      container.innerHTML = `
        <div class="fade-in">
           <div class="flex items-center gap-2 mb-4 pl-2">
               <i class="fas fa-layer-group text-slate-400"></i>
               <h3 class="font-bold text-slate-600">Daftar Bank Soal Tersedia</h3>
           </div>
           ${cardsHtml}
        </div>
      `;

  }).catch(err => {
      container.innerHTML = `<div class="p-8 text-center text-red-500 bg-red-50 rounded-xl border border-red-100">Gagal memuat bank soal: ${err.message}</div>`;
  });
};

// --- FUNGSI BARU: HAPUS SEMUA SOAL ---
window.deleteSemuaSoal = (examId, subjectName) => {
    Swal.fire({
        title: 'Hapus Semua Soal?',
        html: `Anda akan menghapus secara permanen seluruh soal untuk mapel <b>${subjectName}</b>.<br>Tindakan ini tidak dapat dibatalkan!`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Ya, Hapus Semua!',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Menghapus...',
                text: 'Harap tunggu.',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            // Cari semua soal dengan ExamID tersebut
            database.ref('Questions').orderByChild('ExamID').equalTo(examId).once('value').then(snap => {
                const updates = {};
                snap.forEach(child => {
                    updates[child.key] = null;
                });

                if(Object.keys(updates).length === 0) {
                     Swal.fire('Info', 'Tidak ada soal untuk dihapus pada mapel ini.', 'info');
                     renderExamCards();
                     return;
                }

                database.ref('Questions').update(updates).then(() => {
                    Swal.fire({
                        toast: true, position: 'top-end', icon: 'success',
                        title: `Seluruh soal ${subjectName} berhasil dihapus.`,
                        showConfirmButton: false, timer: 2000
                    });
                    renderExamCards(); // Refresh grid
                }).catch(err => {
                    Swal.fire('Error', 'Gagal menghapus soal: ' + err.message, 'error');
                });
            });
        }
    });
};

/* ==========================================================================
   1. HELPER FUNGSI UNTUK EDITOR SOAL (BS & TOGGLE UI)
   ========================================================================== */

// 1. Fungsi Tambah Baris Benar/Salah (BS) di Editor
function addBsRowInput(text = '', key = 'Benar') {
  const container = document.getElementById('bs-container');
  const div = document.createElement('div');
  div.className = 'grid grid-cols-12 gap-2 items-center bs-row';

  div.innerHTML = `
        <div class="col-span-8">
            <input type="text" class="bs-text w-full border border-slate-300 rounded p-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Tulis pernyataan..." value="${text}">
        </div>
        <div class="col-span-3">
            <select class="bs-key w-full border border-slate-300 rounded p-2 text-sm bg-white cursor-pointer">
                <option value="Benar" ${key === 'Benar' ? 'selected' : ''}>Sesuai / Benar</option>
                <option value="Salah" ${key === 'Salah' ? 'selected' : ''}>Tidak Sesuai / Salah</option>
            </select>
        </div>
        <div class="col-span-1 text-center">
             <button type="button" onclick="this.parentElement.parentElement.remove()" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
        </div>
    `;
  container.appendChild(div);
}

// 2. Fungsi Toggle Area Editor (Update agar handle BS, PG Kompleks, dll)
function toggleOptionsInput(type) {
  const pgArea = document.getElementById('options-area');
  const pairsArea = document.getElementById('pairs-area');
  const bsArea = document.getElementById('bs-area');
  const simpleKeyArea = document.getElementById('simple-key-area');

  // Ambil elemen input untuk kunci jawaban agar bisa diubah placeholdernya
  const keyInput = document.getElementById('correct-input');

  // --- RESET: Sembunyikan Semua Area Terlebih Dahulu ---
  pgArea.classList.add('hidden');
  pairsArea.classList.add('hidden');
  bsArea.classList.add('hidden');
  simpleKeyArea.classList.add('hidden');

  // --- LOGIKA TAMPILAN BERDASARKAN TIPE ---

  // A. TIPE PILIHAN GANDA (BIASA & KOMPLEKS)
  if (type === 'PG' || type === 'PG_KOMPLEKS') {
    pgArea.classList.remove('hidden'); // Tampilkan area opsi A-E
    simpleKeyArea.classList.remove('hidden'); // Tampilkan area input kunci

    // Kustomisasi Placeholder Kunci Jawaban
    if (keyInput) {
      if (type === 'PG_KOMPLEKS') {
        keyInput.placeholder = 'Contoh: A, C (Pisahkan dengan koma)';
      } else {
        keyInput.placeholder = 'Contoh: A (Hanya satu huruf)';
      }
    }
  }

  // B. TIPE BENAR / SALAH (BS)
  else if (type === 'BS') {
    bsArea.classList.remove('hidden');
    // SimpleKeyArea TETAP DISEMBUNYIKAN (kunci dipilih di tabel opsi)
  }

  // C. TIPE MENJODOHKAN (JODOH)
  else if (type === 'JODOH') {
    pairsArea.classList.remove('hidden');
    // SimpleKeyArea TETAP DISEMBUNYIKAN (pasangan adalah kuncinya)
  }

  // D. TIPE ESAI
  else if (type === 'Esai') {
    simpleKeyArea.classList.remove('hidden');
    if (keyInput) {
      keyInput.placeholder = 'Masukkan kata kunci atau jawaban singkat...';
    }
  }
}

// 3. Fungsi Tambah Baris Menjodohkan
function addPairInput(leftVal = '', midVal = '', rightVal = '') {
  const div = document.createElement('div');
  div.className = 'grid grid-cols-12 gap-2 items-center';
  div.innerHTML = `
      <input type="text" class="pair-left col-span-4 border border-slate-300 p-2 rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Soal" value="${leftVal}">
      <input type="text" class="pair-mid col-span-4 border border-slate-300 p-2 rounded text-sm focus:ring-1 focus:ring-teal-500 outline-none" placeholder="Opsi Pasangan" value="${midVal}">
      <input type="text" class="pair-right col-span-3 border border-slate-300 p-2 rounded text-sm focus:ring-1 focus:ring-emerald-500 outline-none" placeholder="Jawaban" value="${rightVal}">
      <button type="button" onclick="this.parentElement.remove()" class="col-span-1 text-red-400 hover:text-red-600 text-center"><i class="fas fa-trash"></i></button>
  `;
  document.getElementById('pairs-container').appendChild(div);
}


/* ==========================================================================
   2. LOGIKA AUTOCOMPLETE GAMBAR (SOAL)
   ========================================================================== */

function handleImageAutocomplete(input) {
  const term = input.value.toLowerCase().trim();
  const resultDiv = document.getElementById('ac-results');

  // Pastikan data gambar sudah ada
  if (!allImagesData || allImagesData.length === 0) {
    database.ref('Gambar').once('value').then(snap => {
      const imgs = [];
      snap.forEach(c => { const d = c.val(); d._key = c.key; imgs.push(d); });
      allImagesData = imgs;
    });
    return;
  }

  if (!term) {
    resultDiv.classList.add('hidden');
    return;
  }

  // Filter gambar berdasarkan nama
  const matches = allImagesData.filter(img => img.name.toLowerCase().includes(term));

  if (matches.length === 0) {
    resultDiv.innerHTML = `<div class="p-3 text-xs text-slate-400 italic text-center">Tidak ada gambar ditemukan</div>`;
    resultDiv.classList.remove('hidden');
    return;
  }

  // Render Hasil Pencarian dengan Preview Kecil
  resultDiv.innerHTML = matches.map(img => `
        <div onclick="selectImageSuggestion('${img.link}')" class="flex items-center gap-3 p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-50 last:border-0 transition">
            <img src="${img.link}" class="w-10 h-10 rounded bg-slate-100 object-cover border border-slate-200 shrink-0">
            <div class="overflow-hidden">
                <p class="text-xs font-bold text-slate-700 truncate">${img.name}</p>
                <p class="text-[10px] text-slate-400 truncate font-mono">...${img.link.slice(-15)}</p>
            </div>
        </div>
    `).join('');

  resultDiv.classList.remove('hidden');
}

function selectImageSuggestion(link) {
  const input = document.getElementById('input-image-ac');
  input.value = link; // Isi input dengan Link Gambar
  document.getElementById('ac-results').classList.add('hidden'); // Tutup dropdown

  // Beri efek visual sukses
  input.classList.add('ring-2', 'ring-green-500', 'bg-green-50');
  setTimeout(() => input.classList.remove('ring-2', 'ring-green-500', 'bg-green-50'), 1000);
}


/* ==========================================================================
   3. MANAJEMEN TABEL SOAL (LOAD & RENDER)
   ========================================================================== */

function loadQuestionsTable(examId) {
  if (!examId) return;

  // 1. Reset Form Input
  if (typeof resetQuestionForm === "function") resetQuestionForm();
  
  // 2. Set ID Ujian ke Hidden Input
  document.getElementById('input-exam-id').value = examId;
  
  // 3. Ambil Container
  const container = document.getElementById('q-table-container');
  container.className = 'w-full mt-6 transition-all duration-300';
  
  // Tampilan Loading
  container.innerHTML = `
      <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-12 flex flex-col items-center justify-center animate-pulse w-full">
          <div class="w-12 h-12 bg-slate-200 rounded-full mb-3"></div>
          <div class="h-4 bg-slate-200 rounded w-48 mb-2"></div>
      </div>`;

  // 4. Ambil Data dari Firebase
  database.ref('Questions').orderByChild('ExamID').equalTo(examId).once('value').then(snapshot => {
    const qs = [];
    snapshot.forEach(child => {
      const q = child.val();
      q._key = child.key;
      q.id = q.QuestionID || child.key;
      q.type = q.Type || 'PG';
      q.content = q.Content || '';
      q.options = q.Options || [];
      q.correct = q.Correct || '';
      q.point = q.Point || 10;
      q.image = q.Image || '';
      q.isRequired = q.IsRequired || 'TRUE';
      q.examId = q.ExamID;
      qs.push(q);
    });

    // SIMPAN DATA KE VARIABLE GLOBAL
    allQuestionsData = qs;
    filteredQuestions = qs;
    currentQPage = 1;

    // A. JIKA DATA KOSONG (Belum ada soal)
    if (qs.length === 0) {
      container.innerHTML = `
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-16 text-center w-full">
                <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-100 shadow-sm">
                    <i class="fas fa-folder-open text-3xl text-slate-300"></i>
                </div>
                <h3 class="text-slate-700 font-bold text-lg">Belum Ada Soal</h3>
                <p class="text-slate-400 text-sm mt-1 max-w-xs mx-auto">Data soal kosong. Silakan tambah manual atau import.</p>
                <button onclick="document.getElementById('form-add-q').classList.remove('hidden'); document.getElementById('form-add-q').scrollIntoView({behavior: 'smooth'})" class="mt-6 text-blue-600 font-bold text-sm hover:underline">
                    + Tambah Soal Pertama
                </button>
            </div>`;
      return;
    }

    // B. JIKA ADA DATA: Render Kerangka Tabel + Kontrol Navigasi
    container.innerHTML = `
        <div class="space-y-4 fade-in">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <button onclick="renderExamCards()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition flex items-center gap-2 border border-slate-200" title="Kembali ke Daftar Mapel">
                        <i class="fas fa-arrow-left"></i> <span class="hidden md:inline">Kembali</span>
                    </button>
                    <div class="flex items-center gap-2 text-sm text-slate-600 border-l border-slate-200 pl-4">
                        <span>Show</span>
                        <select onchange="changeQRowsPerPage(this.value)" class="border border-slate-300 rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-blue-500 outline-none font-bold text-slate-700 bg-slate-50 cursor-pointer">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="500">500</option>
                            <option value="all">All</option>
                        </select>
                        <span class="hidden sm:inline">entries</span>
                    </div>
                </div>

                <div class="flex items-center gap-2 w-full md:w-auto">
                    <div class="relative w-full md:w-52">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400"><i class="fas fa-search"></i></span>
                        <input type="text" id="question-search-input" onkeyup="handleQuestionSearch(this.value)" placeholder="Cari soal..." class="pl-9 w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <button onclick="previewAllQuestions()" class="bg-teal-500 hover:bg-teal-600 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-md transition flex-shrink-0 flex items-center gap-2" title="Tampilkan pratinjau semua soal di mapel ini">
                        <i class="fas fa-eye"></i> <span class="hidden md:inline">Preview Mapel</span>
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden w-full">
                <div class="overflow-x-auto w-full">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50/80 border-b border-slate-200 text-slate-500 text-[11px] font-bold uppercase tracking-widest backdrop-blur-sm">
                                <th class="py-4 px-2 text-center w-16">#</th>
                                <th class="py-4 px-5">Pertanyaan & Metadata</th>
                                <th class="py-4 px-5 w-1/4">Kunci Jawaban</th>
                                <th class="py-4 px-5 text-right w-24">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="q-table-body" class="divide-y divide-slate-100 bg-white">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="q-pagination-controls" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4 text-sm">
                <div class="text-slate-500" id="q-pagination-info">Menampilkan 0 - 0 dari 0 data</div>
                <div class="flex gap-2">
                    <button onclick="changeQPage('prev')" id="btn-q-prev" class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition font-medium">Sebelumnya</button>
                    <button onclick="changeQPage('next')" id="btn-q-next" class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition font-medium">Selanjutnya</button>
                </div>
            </div>
        </div>`;

    // Panggil Render Internal
    renderQuestionsInternal(examId);

  });
}

function renderQuestionsInternal(examId) {
  const tbody = document.getElementById('q-table-body');
  const infoDisplay = document.getElementById('q-pagination-info');
  const btnPrev = document.getElementById('btn-q-prev');
  const btnNext = document.getElementById('btn-q-next');

  // Cek Data Filter Kosong
  if (filteredQuestions.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-slate-400">Data tidak ditemukan.</td></tr>`;
    infoDisplay.innerText = 'Menampilkan 0 data';
    btnPrev.disabled = true;
    btnNext.disabled = true;
    return;
  }

  // Hitung Pagination
  const totalData = filteredQuestions.length;
  const maxPage = Math.ceil(totalData / qRowsPerPage);

  if (currentQPage > maxPage) currentQPage = maxPage;
  if (currentQPage < 1) currentQPage = 1;

  const startIndex = (currentQPage - 1) * qRowsPerPage;
  const endIndex = Math.min(startIndex + qRowsPerPage, totalData);

  const pageData = filteredQuestions.slice(startIndex, endIndex);

  // Generate HTML Baris
  const rowsHtml = pageData.map((q, i) => {
    // Hitung nomor urut asli
    const realIndex = startIndex + i + 1;

    // Styling Badge & Icon
    let typeBadgeClass = 'bg-slate-100 text-slate-600 border-slate-200';
    let typeIcon = 'fa-question';

    if (q.type === 'PG') {
      typeBadgeClass = 'bg-blue-50 text-blue-700 border-blue-200';
      typeIcon = 'fa-list-ul';
    } else if (q.type === 'Esai') {
      typeBadgeClass = 'bg-purple-50 text-purple-700 border-purple-200';
      typeIcon = 'fa-paragraph';
    } else if (q.type === 'BS') {
      typeBadgeClass = 'bg-orange-50 text-orange-700 border-orange-200';
      typeIcon = 'fa-check-square';
    } else if (q.type === 'JODOH') {
      typeBadgeClass = 'bg-teal-50 text-teal-700 border-teal-200';
      typeIcon = 'fa-random';
    }

    const isReq = (String(q.isRequired) === 'TRUE');
    const hasImg = (q.image && q.image.length > 5);
    const qStr = encodeURIComponent(JSON.stringify(q));

    return `
        <tr class="group border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors duration-200">
            <td class="p-5 align-top text-center text-slate-400 font-medium text-sm w-16">${realIndex}</td>
            <td class="p-5 align-top">
                <div class="flex gap-4">
                    <div class="flex-shrink-0 mt-0.5">
                        <span class="w-10 h-10 rounded-lg flex flex-col items-center justify-center text-[10px] font-bold border ${typeBadgeClass} shadow-sm">
                            <i class="fas ${typeIcon} text-xs mb-0.5"></i>${q.type.substring(0,3)}
                        </span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-slate-700 font-medium text-sm leading-relaxed line-clamp-2 group-hover:line-clamp-none transition-all duration-300 cursor-pointer" title="${q.content}">${q.content}</p>
                        <div class="flex items-center gap-2 mt-2">
                             ${isReq ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-bold bg-red-50 text-red-600 border border-red-100 uppercase tracking-wide">Wajib</span>` : ''}
                             ${hasImg ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-bold bg-indigo-50 text-indigo-600 border border-indigo-100 uppercase tracking-wide"><i class="far fa-image"></i> Gambar</span>` : ''}
                        </div>
                    </div>
                </div>
            </td>
            <td class="p-5 align-top w-1/4">
                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Kunci</div>
                <div class="font-mono text-sm font-medium text-emerald-700 bg-emerald-50 px-3 py-2 rounded border border-emerald-100 break-words max-h-20 overflow-y-auto custom-scrollbar">
                    ${q.correct || '-'}
                </div>
            </td>
            <td class="p-5 align-top w-24 text-right">
                <div class="flex flex-col gap-2 items-end opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="editQuestion('${qStr}')" class="w-8 h-8 rounded flex items-center justify-center text-slate-500 hover:text-blue-600 hover:bg-blue-50 border border-transparent hover:border-blue-100 transition-all" title="Edit Soal"><i class="fas fa-pencil-alt text-sm"></i></button>
                    <button onclick="showQuestionPreview('${qStr}')" class="w-8 h-8 rounded flex items-center justify-center text-slate-500 hover:text-teal-600 hover:bg-teal-50 border border-transparent hover:border-teal-100 transition-all" title="Preview Soal"><i class="fas fa-eye text-sm"></i></button>
                    <button onclick="deleteQuestion('${q.id}','${document.getElementById('input-exam-id').value}')" class="w-8 h-8 rounded flex items-center justify-center text-slate-500 hover:text-red-600 hover:bg-red-50 border border-transparent hover:border-red-100 transition-all" title="Hapus Soal"><i class="fas fa-trash-alt text-sm"></i></button>
                </div>
            </td>
        </tr>`;
  }).join('');

  // Inject ke Body
  tbody.innerHTML = rowsHtml;

  // Update Info & Buttons
  infoDisplay.innerText = `Menampilkan ${startIndex + 1} - ${endIndex} dari ${totalData} data`;

  btnPrev.disabled = (currentQPage === 1);
  if (currentQPage === 1) btnPrev.classList.add('opacity-50', 'cursor-not-allowed');
  else btnPrev.classList.remove('opacity-50', 'cursor-not-allowed');

  btnNext.disabled = (currentQPage === maxPage || maxPage === 0);
  if (currentQPage === maxPage || maxPage === 0) btnNext.classList.add('opacity-50', 'cursor-not-allowed');
  else btnNext.classList.remove('opacity-50', 'cursor-not-allowed');
}


/* ==========================================================================
   4. LOGIKA SUBMIT SOAL (HANDLING EDITOR & FORMAT DATA)
   ========================================================================== */

function handleAddQuestion(e) {
  e.preventDefault();

  // 1. SINKRONISASI EDITOR KE TEXTAREA
  // Simpan Editor Utama (Soal)
  if (typeof tinymce !== 'undefined' && tinymce.get('editor-content')) {
    tinymce.triggerSave();
  }

  // Simpan Editor Opsi Jawaban (A-E) jika ada
  for (let i = 0; i < 5; i++) {
    if (typeof tinymce !== 'undefined' && tinymce.get('opt-' + i)) {
      tinymce.get('opt-' + i).save();
    }
  }

  // 2. AMBIL DATA FORM
  const fd = new FormData(e.target);
  const data = Object.fromEntries(fd.entries());
  const qId = document.getElementById('input-question-id').value;

  // Validasi Konten Utama (Bersihkan tag kosong bawaan editor)
  const cleanContent = data.content ? data.content.replace(/<p><br><\/p>|<p>&nbsp;<\/p>/g, '').trim() : '';

  if (!cleanContent && (!data.image || data.image.trim() === '')) {
    Swal.fire('Data Belum Lengkap', 'Silakan isi pertanyaan (teks) atau masukkan gambar soal.', 'warning');
    return;
  }

  // 3. LOGIKA: PROSES UKURAN GAMBAR UTAMA (THUMBNAIL)
  const sizeSelect = document.getElementById('input-image-size');
  const size = sizeSelect ? sizeSelect.value : 'w1000';

  if (data.image && data.image.includes('drive.google.com/thumbnail')) {
    let cleanUrl = data.image.replace(/&sz=[^&]+/, '');
    data.image = cleanUrl + `&sz=${size}`;
  }

  // 4. PROSES DATA OPTIONS BERDASARKAN TIPE SOAL

  // A. TIPE PILIHAN GANDA (PG BIASA & PG KOMPLEKS)
  if (data.type === 'PG' || data.type === 'PG_KOMPLEKS') {
    let opts = [];

    for (let i = 0; i < 5; i++) {
      let val = '';
      // Cek apakah Editor TinyMCE untuk opsi ini aktif?
      if (typeof tinymce !== 'undefined' && tinymce.get('opt-' + i)) {
        val = tinymce.get('opt-' + i).getContent();
      } else {
        val = document.getElementById('opt-' + i).value;
      }

      // Bersihkan tag kosong jika user hanya klik-klik tanpa isi
      const cleanVal = val.replace(/<p><br><\/p>|<p>&nbsp;<\/p>/g, '').trim();

      // Jika ada isinya, masukkan ke array
      if (cleanVal) {
        opts.push(val); // Simpan format aslinya (HTML)
      }
    }

    // Validasi Ukuran JSON
    const jsonLength = JSON.stringify(opts).length;
    if (jsonLength > 48000) {
      Swal.fire({
        icon: 'error',
        title: 'Data Terlalu Besar',
        text: `Ukuran opsi jawaban (${Math.round(jsonLength/1024)} KB) melebihi batas. Mohon gunakan gambar yang lebih kecil/sedikit pada pilihan jawaban.`
      });
      return; // Batalkan proses
    }

    data.options = opts;

    // KHUSUS PG_KOMPLEKS: Format kunci jawaban jadi JSON Array
    if (data.type === 'PG_KOMPLEKS') {
      const rawKey = data.correct;
      const keyArr = rawKey.split(',').map(k => k.trim()).filter(k => k);
      data.correct = JSON.stringify(keyArr);
    }
  }

  // B. TIPE BENAR/SALAH KOMPLEKS (BS)
  else if (data.type === 'BS') {
    let statements = [];
    let keys = {};

    const rows = document.querySelectorAll('.bs-row');
    rows.forEach((row, idx) => {
      const txt = row.querySelector('.bs-text').value;
      const k = row.querySelector('.bs-key').value;

      if (txt && txt.trim() !== "") {
        statements.push(txt);
        keys[idx] = k;
      }
    });

    data.options = statements;
    data.correct = JSON.stringify(keys);
  }

  // C. TIPE MENJODOHKAN (JODOH)
  else if (data.type === 'JODOH') {
    let pairs = [];
    const lefts = document.querySelectorAll('.pair-left');
    const mids = document.querySelectorAll('.pair-mid');
    const rights = document.querySelectorAll('.pair-right');

    lefts.forEach((el, i) => {
      if (el.value && mids[i] && mids[i].value) {
        pairs.push({
          q: el.value,
          m: mids[i].value,
          a: rights[i] && rights[i].value ? rights[i].value : mids[i].value
        });
      }
    });

    data.options = pairs;
    data.correct = "Auto-Check";
  }

  // D. LAINNYA (ESAI, DLL)
  else {
    data.options = [];
  }

  // 5. LOGIKA SIMPAN KE SERVER (ADD atau UPDATE)
  const btn = e.target.querySelector('button[type="submit"]');
  const originalText = btn.innerHTML;

  // Ubah status tombol loading
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

  if (qId) {
    // --- MODE UPDATE (EDIT SOAL) ---
    data.questionId = qId;
    database.ref('Questions').orderByChild('QuestionID').equalTo(qId).once('value').then(snap => {
      let key = null;
      snap.forEach(c => { key = c.key; });
      if (!key) { key = qId; }
      const updateData = {
        Type: data.type, Content: data.content, Options: data.options || [],
        Correct: data.correct || '', Point: parseInt(data.point) || 10,
        Image: data.image || '', IsRequired: data.isRequired || 'TRUE'
      };
      return database.ref('Questions/' + key).update(updateData);
    }).then(() => {
      btn.disabled = false;
      btn.innerHTML = originalText;
      Swal.fire('Berhasil', 'Soal berhasil diperbarui!', 'success');
      resetQuestionForm();
      loadQuestionsTable(data.examId);
    }).catch(err => {
      btn.disabled = false;
      btn.innerHTML = originalText;
      Swal.fire('Gagal', err.message, 'error');
    });
  } else {
    // --- MODE ADD (SOAL BARU) ---
    const newQId = 'Q_' + Date.now();
    const newQ = {
      QuestionID: newQId, ExamID: data.examId, Type: data.type,
      Content: data.content, Options: data.options || [],
      Correct: data.correct || '', Point: parseInt(data.point) || 10,
      Image: data.image || '', IsRequired: data.isRequired || 'TRUE'
    };
    database.ref('Questions').push(newQ).then(() => {
      btn.disabled = false;
      btn.innerHTML = originalText;

      Swal.fire({
        icon: 'success',
        title: 'Tersimpan!',
        text: 'Soal berhasil ditambahkan ke Bank Soal.',
        timer: 1500,
        showConfirmButton: false
      });

      const currentExamId = document.getElementById('input-exam-id').value;

      resetQuestionForm();

      // Kembalikan ID Ujian agar user nyaman input soal berikutnya
      document.getElementById('input-exam-id').value = currentExamId;

      loadQuestionsTable(data.examId);
    }).catch(err => {
      btn.disabled = false;
      btn.innerHTML = originalText;
      Swal.fire('Gagal', err.message, 'error');
    });
  }
}


/* ==========================================================================
   5. AUTOCOMPLETE KONFIGURASI (LOGO & BACKGROUND)
   ========================================================================== */

// 1. Fungsi Pencarian Logo Config
function handleConfigLogoSearch(input) {
  const term = input.value.toLowerCase();
  const resultDiv = document.getElementById('cfg-logo-results');

  // Load data gambar jika belum ada
  if (typeof allImagesData === 'undefined' || allImagesData.length === 0) {
    database.ref('Gambar').once('value').then(snap => {
      const imgs = [];
      snap.forEach(c => { const d = c.val(); d._key = c.key; imgs.push(d); });
      allImagesData = imgs;
      if (input.value.length > 0) handleConfigLogoSearch(input);
    });

    resultDiv.innerHTML = '<div class="p-3 text-xs text-slate-400">Memuat data gambar...</div>';
    resultDiv.classList.remove('hidden');
    return;
  }

  if (term.length < 1) {
    resultDiv.classList.add('hidden');
    return;
  }

  const matches = allImagesData.filter(img => img.name.toLowerCase().includes(term));

  if (matches.length > 0) {
    resultDiv.innerHTML = matches.map(img => `
            <div class="flex items-center gap-3 p-2 hover:bg-blue-50 cursor-pointer border-b border-slate-50 transition"
                 onclick="selectConfigLogo('${img.link}')">
                <img src="${img.link}" referrerpolicy="no-referrer" class="w-8 h-8 rounded bg-slate-200 object-cover">
                <div class="overflow-hidden">
                    <div class="text-xs font-bold text-slate-700 truncate">${img.name}</div>
                    <div class="text-[10px] text-slate-400 truncate">${img.id}</div>
                </div>
            </div>
        `).join('');
    resultDiv.classList.remove('hidden');
  } else {
    resultDiv.innerHTML = '<div class="p-3 text-xs text-slate-400 text-center">Tidak ada gambar ditemukan</div>';
    resultDiv.classList.remove('hidden');
  }
}

function selectConfigLogo(link) {
  document.getElementById('cfg-app-logo').value = link;
  document.getElementById('cfg-logo-results').classList.add('hidden');
  updateLogoPreview(link);
}

// 2. Fungsi Pencarian Background Config
function handleConfigBgSearch(input) {
  const term = input.value.toLowerCase();
  const resultDiv = document.getElementById('cfg-bg-results');

  if (typeof allImagesData === 'undefined' || allImagesData.length === 0) {
    database.ref('Gambar').once('value').then(snap => {
      const imgs = [];
      snap.forEach(c => { const d = c.val(); d._key = c.key; imgs.push(d); });
      allImagesData = imgs;
      if (input.value.length > 0) handleConfigBgSearch(input);
    });
    resultDiv.innerHTML = '<div class="p-3 text-xs text-slate-400">Memuat data...</div>';
    resultDiv.classList.remove('hidden');
    return;
  }

  if (term.length < 1) {
    resultDiv.classList.add('hidden');
    return;
  }

  const matches = allImagesData.filter(img => img.name.toLowerCase().includes(term));

  if (matches.length > 0) {
    resultDiv.innerHTML = matches.map(img => `
            <div class="flex items-center gap-3 p-2 hover:bg-blue-50 cursor-pointer border-b border-slate-50 transition"
                 onclick="selectConfigBg('${img.link}')">
                <img src="${img.link}" referrerpolicy="no-referrer" class="w-12 h-8 rounded bg-slate-200 object-cover">
                <div class="overflow-hidden">
                    <div class="text-xs font-bold text-slate-700 truncate">${img.name}</div>
                </div>
            </div>
        `).join('');
    resultDiv.classList.remove('hidden');
  } else {
    resultDiv.innerHTML = '<div class="p-3 text-xs text-slate-400 text-center">Tidak ditemukan</div>';
    resultDiv.classList.remove('hidden');
  }
}

function selectConfigBg(link) {
  document.getElementById('cfg-app-bg').value = link;
  document.getElementById('cfg-bg-results').classList.add('hidden');
  updateBgPreview(link);
}

function updateBgPreview(url) {
  const img = document.getElementById('cfg-bg-preview');
  img.style.display = 'block';
  img.src = url;
}


/* ==========================================================================
   6. FUNGSI IMPORT & DELETE SOAL
   ========================================================================== */

function triggerImport() {
  const examId = document.getElementById('select-exam-q').value;
  const urlInput = document.getElementById('input-form-url');
  const url = urlInput.value.trim();

  if (!examId) {
    Swal.fire('Peringatan', 'Silakan pilih Ujian (Mata Pelajaran) terlebih dahulu di dropdown atas!', 'warning');
    return;
  }
  if (!url) {
    Swal.fire('Peringatan', 'Link Google Form tidak boleh kosong!', 'warning');
    return;
  }

  const btn = document.querySelector('button[onclick="triggerImport()"]');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

  // Import Google Form tidak didukung di client-side Firebase
  btn.disabled = false;
  btn.innerHTML = originalText;
  Swal.fire('Fitur Tidak Tersedia', 'Import dari Google Form tidak didukung dalam mode Firebase. Silakan gunakan import Excel.', 'warning');
}

function deleteQuestion(qid, eid) {
  Swal.fire({
    title: 'Hapus Soal?',
    text: 'Tidak bisa dikembalikan.',
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#d33'
  }).then(r => {
    if (r.isConfirmed) {
      database.ref('Questions').orderByChild('QuestionID').equalTo(qid).once('value').then(snap => {
        const promises = [];
        snap.forEach(c => { promises.push(c.ref.remove()); });
        return Promise.all(promises);
      }).then(() => loadQuestionsTable(eid));
    }
  });
}

/* ==========================================================================
   1. LAPORAN HASIL & PENILAIAN (ADMIN VIEW)
   ========================================================================== */

function renderResults(container, selectedExamId = null) {
  // Menyiapkan opsi dropdown dari data ujian yang ada
  let opts = cachedExams.map(e => {
      const isSel = (selectedExamId && String(e.id) === String(selectedExamId)) ? 'selected' : '';
      return `<option value="${e.id}" ${isSel}>${e.subject} (${e.class})</option>`;
  }).join('');

  container.innerHTML = `
    <div class="fade-in w-full space-y-6"> 
        
        <div class="dash-card p-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                <div>
                   <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                        <i class="fas fa-poll-h text-blue-600"></i> Laporan Hasil & Penilaian
                   </h3>
                   <p class="text-sm text-slate-500 mt-1">Pilih ujian untuk melihat daftar nilai siswa.</p>
                </div>

                <div class="flex items-center gap-2">
                  <button id="btn-back-to-cards" onclick="renderResultCards()" class="hidden bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2.5 rounded-xl text-sm font-bold shadow-sm transition flex items-center gap-2 border border-slate-200" title="Kembali ke Daftar Kelas">
                      <i class="fas fa-arrow-left"></i> <span class="hidden sm:inline">Kembali</span>
                  </button>
                  <button id="btn-excel-recap" onclick="downloadResultsAsExcel()" class="hidden bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-emerald-500/30 transition flex items-center gap-2 transform active:scale-95">
                      <i class="fas fa-file-excel"></i> <span class="hidden sm:inline">Download Rekap Excel</span>
                  </button>
                  <button id="btn-pdf-recap" onclick="downloadResultPDF()" class="hidden bg-red-600 hover:bg-red-700 text-white px-4 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-red-500/30 transition flex items-center gap-2 transform active:scale-95">
                      <i class="fas fa-file-pdf"></i> <span class="hidden sm:inline">Download Rekap PDF</span>
                  </button>
                </div>
            </div>

            <div class="w-full">
               <div class="relative group">
                   <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                       <i class="fas fa-filter"></i>
                   </div>
                   <select id="select-result-exam" class="pl-10 pr-4 py-3 border border-slate-200 rounded-xl w-full bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none text-slate-700 shadow-sm transition-all appearance-none font-medium cursor-pointer" onchange="loadResultsTable(this.value)">
                       <option value="">-- Pilih Mata Pelajaran --</option>${opts}
                   </select>
                   <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-slate-500">
                      <i class="fas fa-chevron-down text-xs"></i>
                  </div>
               </div>
            </div>
        </div>
        
        <div id="res-table-wrapper" class="hidden w-full transition-all duration-300 space-y-4">
            
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                
                <div class="flex items-center gap-2 text-sm text-slate-600">
                    <span>Tampilkan</span>
                    <select onchange="changeRowsPerPage(this.value)" class="border border-slate-300 rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-blue-500 outline-none font-bold text-slate-700 bg-slate-50">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="500">500</option>
                        <option value="all">Semua</option>
                    </select>
                    <span>data</span>
                </div>

                <div class="relative w-full md:w-64">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400"><i class="fas fa-search"></i></span>
                    <input type="text" id="result-search-input" onkeyup="handleResultSearch(this.value)" placeholder="Cari Nama / ID..." class="pl-9 w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>
            </div>

            <div id="res-table-container"></div>

            <div id="pagination-controls" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4 text-sm">
                <div class="text-slate-500" id="pagination-info">Menampilkan 0 - 0 dari 0 data</div>
                <div class="flex gap-2">
                    <button onclick="changePage('prev')" id="btn-page-prev" class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition font-medium">Sebelumnya</button>
                    <button onclick="changePage('next')" id="btn-page-next" class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition font-medium">Selanjutnya</button>
                </div>
            </div>

        </div>

        <div id="res-empty-state" class="w-full">
            <div id="result-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full fade-in"></div>
        </div>
    </div>`;

  // Helper: Jika ada selectedExamId, otomatis load
  if (selectedExamId) {
      setTimeout(() => loadResultsTable(selectedExamId), 500);
      setTimeout(() => {
          const select = document.getElementById('select-result-exam');
          if (select) select.value = selectedExamId;
      }, 550);
  } else {
      setTimeout(() => renderResultCards(), 300);
  }
}

window.renderResultCards = () => {
    const container = document.getElementById('result-cards-container');
    if(!container) return;

    // Meniru logika Bank Soal: Reset komponen view tabel saat kembali
    const wrapper = document.getElementById('res-table-wrapper');
    const emptyState = document.getElementById('res-empty-state');
    const btnPdf = document.getElementById('btn-pdf-recap');
    const btnExcel = document.getElementById('btn-excel-recap');
    const btnBack = document.getElementById('btn-back-to-cards');
    const select = document.getElementById('select-result-exam');

    if (select) select.value = '';
    if (wrapper) wrapper.classList.add('hidden');
    if (emptyState) emptyState.classList.remove('hidden');
    if (btnPdf) btnPdf.classList.add('hidden');
    if (btnExcel) btnExcel.classList.add('hidden');
    if (btnBack) btnBack.classList.add('hidden');

    container.innerHTML = `
        <div class="col-span-full bg-white rounded-xl border border-slate-200 shadow-sm p-16 flex flex-col items-center justify-center animate-pulse w-full">
             <div class="w-12 h-12 bg-slate-200 rounded-full mb-3"></div>
             <div class="h-4 bg-slate-200 rounded w-48 mb-2"></div>
             <div class="h-3 bg-slate-100 rounded w-32"></div>
        </div>`;

    database.ref('Responses').once('value').then(snap => {
        const studentCounts = {};
        snap.forEach(child => {
            const r = child.val();
            if(r.ExamID) {
                studentCounts[r.ExamID] = (studentCounts[r.ExamID] || 0) + 1;
            }
        });

        let activeExams = cachedExams.filter(e => studentCounts[e.id] > 0);

        // --- FILTER ROLE ---
        if (currentUser && currentUser.role === 'Guru') {
            const assignments = String(currentUser.class || '').split(',').map(a => a.trim());
            const teacherSubjects = assignments.map(a => {
                const parts = a.split(':');
                return parts[0] ? parts[0].trim().toLowerCase() : '';
            }).filter(Boolean);

            activeExams = activeExams.filter(e => {
                const examSubj = e.subject ? e.subject.toLowerCase().trim() : '';
                return teacherSubjects.includes(examSubj);
            });
        }

        if(activeExams.length === 0) {
            let emptyMessage = 'Belum ada siswa yang mengerjakan ujian.';
            if (currentUser && currentUser.role === 'Guru') {
                emptyMessage = 'Belum ada nilai siswa untuk mata pelajaran yang Anda ampu.';
            }
            container.innerHTML = `
              <div class="col-span-full bg-white rounded-xl border border-slate-200 shadow-sm p-16 text-center w-full fade-in">
                  <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-100">
                      <i class="fas fa-poll-h text-3xl text-slate-300"></i>
                  </div>
                  <h3 class="text-lg font-bold text-slate-600">Belum Ada Hasil Ujian</h3>
                  <p class="text-sm text-slate-400 mt-1 max-w-xs mx-auto">${emptyMessage}</p>
              </div>`;
            return;
        }

        let cardsHtml = '';
        const colorClasses = [
            ['blue', 'border-blue-500', 'bg-blue-100', 'text-blue-800', 'ring-blue-400'],
            ['emerald', 'border-emerald-500', 'bg-emerald-100', 'text-emerald-800', 'ring-emerald-400'],
            ['purple', 'border-purple-500', 'bg-purple-100', 'text-purple-800', 'ring-purple-400'],
            ['orange', 'border-orange-500', 'bg-orange-100', 'text-orange-800', 'ring-orange-400'],
            ['pink', 'border-pink-500', 'bg-pink-100', 'text-pink-800', 'ring-pink-400'],
            ['rose', 'border-rose-500', 'bg-rose-100', 'text-rose-800', 'ring-rose-400'],
            ['indigo', 'border-indigo-500', 'bg-indigo-100', 'text-indigo-800', 'ring-indigo-400']
        ];

        activeExams.forEach((exam, index) => {
            const count = studentCounts[exam.id];
            const colorSet = colorClasses[index % colorClasses.length];
            const borderColor = colorSet[1];
            const iconBg = colorSet[2];
            const iconColor = colorSet[3];

            let initial = (exam.subject || 'U').substring(0, 1).toUpperCase();

            cardsHtml += `
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-xl hover:-translate-y-1 transition duration-300 overflow-hidden group cursor-pointer relative flex flex-col h-full" onclick="document.getElementById('select-result-exam').value='${exam.id}'; loadResultsTable('${exam.id}')">
                    <button onclick="event.stopPropagation(); window.hapusRombonganHasil('${exam.id}', '${exam.subject || 'Ujian'}');" class="absolute top-3 right-3 w-8 h-8 bg-red-50 hover:bg-red-500 text-red-500 hover:text-white rounded-lg flex items-center justify-center transition opacity-0 group-hover:opacity-100 shadow-sm" title="Hapus Semua Nilai Mapel Ini">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <div class="h-2 w-full ${iconBg}"></div>
                    <div class="p-5 flex-1 flex flex-col">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-14 h-14 rounded-2xl ${iconBg} ${iconColor} flex items-center justify-center text-2xl font-bold shadow-sm border ${borderColor} group-hover:scale-110 group-hover:rotate-3 transition duration-300">
                                ${initial}
                            </div>
                        </div>
                        <h4 class="font-bold text-slate-800 text-lg mb-1 group-hover:text-blue-600 transition truncate pr-2" title="${exam.subject || 'Ujian'}">${exam.subject || 'Ujian'}</h4>
                        <div class="flex items-center gap-2 mb-4">
                            <span class="px-2 py-0.5 bg-slate-100 text-slate-600 rounded text-xs font-semibold border border-slate-200 flex items-center gap-1">
                                <i class="fas fa-users"></i> ${exam.class || '-'}
                            </span>
                        </div>
                        <div class="mt-auto pt-4 border-t border-slate-100 flex items-center justify-between">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Total Hasil</span>
                                <span class="font-black text-slate-700 text-base">${count} <span class="text-xs font-medium text-slate-400">Siswa</span></span>
                            </div>
                            <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-blue-50 group-hover:text-blue-600 transition">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = cardsHtml;
    });
};

window.hapusRombonganHasil = (examId, subjectName) => {
    Swal.fire({
        title: `Hapus Semua Nilai ${subjectName}?`,
        text: 'Seluruh data jawaban siswa untuk ujian ini akan dihapus permanen dan tidak bisa dikembalikan!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Ya, Hapus Semua!',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Menghapus Data...',
                html: '<i class="fas fa-circle-notch fa-spin text-3xl text-red-500"></i>',
                showConfirmButton: false,
                allowOutsideClick: false
            });

            database.ref('Responses').orderByChild('ExamID').equalTo(examId).once('value').then(snap => {
                if (!snap.exists()) {
                    Swal.fire('Info', 'Tidak ada nilai yang ditemukan untuk dihapus.', 'info');
                    return;
                }
                
                const updates = {};
                snap.forEach(child => {
                    updates[child.key] = null;
                });

                return database.ref('Responses').update(updates);
            }).then(() => {
                Swal.fire('Berhasil', 'Seluruh data nilai mapel tersebut berhasil dihapus.', 'success');
                window.renderResultCards(); // refresh grid
            }).catch(err => {
                Swal.fire('Error', 'Gagal menghapus data: ' + err.message, 'error');
            });
        }
    });
};

function loadResultsTable(eid) {
  const wrapper = document.getElementById('res-table-wrapper');
  const emptyState = document.getElementById('res-empty-state');
  const container = document.getElementById('res-table-container');
  const btnPdf = document.getElementById('btn-pdf-recap');
  const btnExcel = document.getElementById('btn-excel-recap');
  const btnBack = document.getElementById('btn-back-to-cards');

  // Jika dropdown dipilih ke "Pilih Mata Pelajaran" (kosong)
  if (!eid) {
    wrapper.classList.add('hidden');
    emptyState.classList.remove('hidden');
    if (btnPdf) btnPdf.classList.add('hidden');
    if (btnExcel) btnExcel.classList.add('hidden');
    if (btnBack) btnBack.classList.add('hidden');
    return;
  }

  // Tampilkan Wrapper & Tombol
  wrapper.classList.remove('hidden');
  emptyState.classList.add('hidden');
  if (btnPdf) btnPdf.classList.remove('hidden');
  if (btnExcel) btnExcel.classList.remove('hidden');
  if (btnBack) btnBack.classList.remove('hidden');

  // Tampilkan Loading State Manual
  container.innerHTML = `
      <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-12 flex flex-col items-center justify-center animate-pulse w-full">
          <div class="w-12 h-12 bg-slate-200 rounded-full mb-3"></div>
          <div class="h-4 bg-slate-200 rounded w-48 mb-2"></div>
      </div>`;

  // Ambil Data dari Firebase
  database.ref('Responses').orderByChild('ExamID').equalTo(eid).once('value').then(snapshot => {
    const res = [];
    snapshot.forEach(child => {
      const r = child.val();
      r._key = child.key;
      r.id = r.ResponseID || child.key;
      r.responseId = r.ResponseID || child.key;
      r.studentId = r.UserID || '-';
      r.name = r.Username || r.UserID || '-';
      r.score = r.Score != null ? r.Score : '-';
      r.status = r.Status || 'Selesai';
      r.submittedAt = r.SubmittedAt || '-';
      r.submitTime = r.SubmittedAt ? new Date(r.SubmittedAt).toLocaleString('id-ID') : '-';
      r.violations = r.Violations || 0;
      res.push(r);
    });

    // SIMPAN DATA KE MEMORI BROWSER
    allResultsData = res;
    filteredResults = res;
    currentPage = 1;

    const searchInput = document.getElementById('result-search-input');
    if (searchInput) searchInput.value = '';

    renderInternalTable();
  });
}

function renderInternalTable() {
  const container = document.getElementById('res-table-container');
  const infoDisplay = document.getElementById('pagination-info');
  const btnPrev = document.getElementById('btn-page-prev');
  const btnNext = document.getElementById('btn-page-next');

  // A. Cek Jika Data Kosong (Setelah difilter atau memang kosong)
  if (filteredResults.length === 0) {
    container.innerHTML = `
          <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-16 text-center w-full">
              <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-100">
                  <i class="fas fa-inbox text-3xl text-slate-300"></i>
              </div>
              <h3 class="text-slate-700 font-bold text-lg">Data Tidak Ditemukan</h3>
              <p class="text-slate-400 text-sm mt-1">Coba kata kunci lain atau belum ada siswa ujian.</p>
          </div>`;

    if (infoDisplay) infoDisplay.innerText = 'Menampilkan 0 data';
    if (btnPrev) btnPrev.disabled = true;
    if (btnNext) btnNext.disabled = true;
    return;
  }

  // B. Hitung Logika Pagination
  const totalData = filteredResults.length;
  const maxPage = Math.ceil(totalData / rowsPerPage);

  // Validasi Current Page
  if (currentPage > maxPage) currentPage = maxPage;
  if (currentPage < 1) currentPage = 1;

  const startIndex = (currentPage - 1) * rowsPerPage;
  const endIndex = Math.min(startIndex + rowsPerPage, totalData);
  const pageData = filteredResults.slice(startIndex, endIndex);

  // C. Generate HTML Baris Tabel
  let rowsHtml = pageData.map((r, i) => {
    const realIndex = startIndex + i + 1;

    // --- LOGIKA STATUS ---
    const isCheat = r.status === 'Curang';
    const isDone = r.status === 'Completed' || r.status === 'Selesai';

    let statusBadge = '';
    let actionBtn = '';
    let scoreColor = 'text-slate-700';

    if (isCheat) {
      // KONDISI 1: CURANG
      statusBadge = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-red-50 text-red-700 border border-red-200 uppercase tracking-wide"><i class="fas fa-exclamation-triangle"></i> CURANG</span>`;
      scoreColor = 'text-red-600 line-through opacity-50';

      actionBtn = `
             <button onclick="unlockExamAttempt('${r.responseId}', '${r.name}')" class="inline-flex items-center justify-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold text-teal-700 bg-teal-100 hover:bg-teal-200 border border-teal-200 shadow-sm transition-all transform active:scale-95 mr-2" title="Buka akses siswa agar bisa melanjutkan ujian">
              <i class="fas fa-unlock"></i> Buka Akses
             </button>
             <button onclick="resetExamAttempt('${r.responseId}', '${r.name}')" class="inline-flex items-center justify-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold text-white bg-orange-500 hover:bg-orange-600 shadow-sm transition-all transform active:scale-95" title="Hapus data agar siswa bisa ujian lagi">
              <i class="fas fa-redo-alt"></i> Reset
             </button>`;

    } else if (isDone) {
      // KONDISI 2: SELESAI NORMAL
      statusBadge = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-emerald-50 text-emerald-700 border border-emerald-100 uppercase tracking-wide"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>Selesai</span>`;
      scoreColor = r.score >= 75 ? 'text-emerald-600' : (r.score < 50 ? 'text-red-600' : 'text-orange-600');

      actionBtn = `
             <div class="flex items-center justify-end gap-2">
                 <button onclick="viewStudentAnswers('${r.responseId}')" class="w-8 h-8 flex items-center justify-center rounded-lg text-teal-600 bg-teal-50 hover:bg-teal-100 border border-teal-200 hover:border-teal-300 transition-all shadow-sm" title="Lihat Jawaban Siswa">
                  <i class="fas fa-eye"></i>
                 </button>
                 
                 <button onclick="downloadStudentPDF('${r.responseId}', this)" class="w-8 h-8 flex items-center justify-center rounded-lg text-purple-600 bg-purple-50 hover:bg-purple-100 border border-purple-200 hover:border-purple-300 transition-all shadow-sm" title="Download PDF Jawaban">
                  <i class="fas fa-print"></i>
                 </button>
                 
                 <button onclick="downloadSingleStudentAnswers('${r.responseId}', '${r.name}')" class="w-8 h-8 flex items-center justify-center rounded-lg text-emerald-600 bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 hover:border-emerald-300 transition-all shadow-sm" title="Download Jawaban (Excel)">
                  <i class="fas fa-file-excel"></i>
                 </button>

                 <button onclick="openGradingModal('${r.responseId}')" class="w-8 h-8 flex items-center justify-center rounded-lg text-blue-600 bg-blue-50 hover:bg-blue-100 border border-blue-200 hover:border-blue-300 transition-all shadow-sm" title="Koreksi Esai & Nilai">
                  <i class="fas fa-pencil-alt"></i>
                 </button>
             </div>`;

    } else {
      // KONDISI 3: STATUS LAIN (Sedang Mengerjakan)
      statusBadge = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-yellow-50 text-yellow-700 border border-yellow-100 uppercase tracking-wide"><span class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></span>Ujian</span>`;
      actionBtn = `<span class="text-slate-300 text-[10px] uppercase font-bold tracking-wider">-</span>`;
    }

    return `
       <tr class="border-b border-slate-50 hover:bg-slate-50/80 transition-colors duration-200 group">
          <td class="p-5 text-center text-slate-400 text-sm font-medium w-16">${realIndex}</td>
          <td class="p-5">
              <div class="flex items-center gap-4">
                  <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 text-sm font-bold border border-slate-200">
                      ${r.name.charAt(0).toUpperCase()}
                  </div>
                  <div>
                      <div class="font-bold text-slate-700 text-sm group-hover:text-blue-600 transition-colors">${r.name}</div>
                      <div class="flex items-center gap-2 mt-1">
                          <span class="text-[10px] font-mono text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">${r.studentId}</span>
                      </div>
                  </div>
              </div>
          </td>
          <td class="p-5 text-sm text-slate-500 font-medium">
              <div class="flex items-center gap-2">
                  <i class="far fa-clock text-slate-300"></i> ${r.submitTime}
              </div>
          </td>
          <td class="p-5">
              <div class="text-lg font-black ${scoreColor} tracking-tight">${r.score}</div>
          </td>
          <td class="p-5 text-center">${statusBadge}</td>
          <td class="p-5 text-right w-36">
              ${actionBtn}
          </td>
       </tr>`;
  }).join('');

  // D. Update HTML Container Tabel
  container.innerHTML = `
      <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden w-full">
          <div class="overflow-x-auto w-full">
              <table class="w-full text-left border-collapse">
                  <thead>
                      <tr class="bg-slate-50/80 border-b border-slate-200 text-slate-500 text-[11px] font-bold uppercase tracking-widest backdrop-blur-sm">
                          <th class="py-4 px-2 text-center w-16">No</th>
                          <th class="py-4 px-5">Identitas Siswa</th>
                          <th class="py-4 px-5 w-40">Waktu Submit</th>
                          <th class="py-4 px-5 w-24">Nilai</th>
                          <th class="py-4 px-5 text-center w-32">Status</th>
                          <th class="py-4 px-5 text-right w-36">Aksi</th>
                      </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100 bg-white">${rowsHtml}</tbody>
              </table>
          </div>
      </div>`;

  // E. Update Info Pagination & State Tombol
  if (infoDisplay) infoDisplay.innerText = `Menampilkan ${startIndex + 1} - ${endIndex} dari ${totalData} data`;

  if (btnPrev) {
    btnPrev.disabled = (currentPage === 1);
    if (currentPage === 1) btnPrev.classList.add('opacity-50', 'cursor-not-allowed');
    else btnPrev.classList.remove('opacity-50', 'cursor-not-allowed');
  }

  if (btnNext) {
    const isLastPage = (currentPage === maxPage || maxPage === 0);
    btnNext.disabled = isLastPage;
    if (isLastPage) btnNext.classList.add('opacity-50', 'cursor-not-allowed');
    else btnNext.classList.remove('opacity-50', 'cursor-not-allowed');
  }
}

function downloadResultPDF() {
  const examId = document.getElementById('select-result-exam').value;

  if (!examId) {
    Swal.fire('Peringatan', 'Silakan pilih Mata Pelajaran terlebih dahulu agar sistem mengetahui kelas mana yang akan dicetak.', 'warning');
    return;
  }

  // Get selected exam info to extract the target class
  const selectedExam = cachedExams.find(e => String(e.id) === String(examId));
  if (!selectedExam) return;

  const targetClass = selectedExam.class;

  const btn = document.getElementById('btn-pdf-recap');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

  // Find all subjects/exams for this class
  let classExams = cachedExams.filter(e => e.class === targetClass);

  if (currentUser && currentUser.role === 'Guru') {
    const assignments = String(currentUser.class || '').split(',').map(a => a.trim());
    const teacherSubjects = assignments.map(a => {
        const parts = a.split(':');
        return parts[0] ? parts[0].trim().toLowerCase() : '';
    }).filter(Boolean);

    classExams = classExams.filter(e => {
        const examSubj = e.subject ? e.subject.toLowerCase().trim() : '';
        return teacherSubjects.some(ts => ts === examSubj);
    });
  }

  if (classExams.length === 0) {
      Swal.fire('Info', 'Tidak ada mata pelajaran ujian untuk kelas ini.', 'info');
      btn.disabled = false;
      btn.innerHTML = originalText;
      return;
  }

  // Sort exams/subjects for consistent columns
  classExams.sort((a,b) => (a.subject || '').localeCompare(b.subject || ''));
  const examIds = classExams.map(e => String(e.id));
  const subjectNames = classExams.map(e => e.subject);

  const ensureUsersLoaded = (typeof allUsersData !== 'undefined' && allUsersData && allUsersData.length > 0)
    ? Promise.resolve()
    : database.ref('Users').once('value').then(snap => {
        const users = [];
        snap.forEach(child => {
          const raw = child.val();
          users.push({
            _key: child.key,
            id: raw.UserID || raw.userId || raw.id || '',
            username: raw.Username || raw.username || '',
            role: raw.Role || raw.role || 'Siswa',
            class: raw.Class || raw.class || raw.kelas || '',
            password: raw.Password || raw.password || ''
          });
        });
        allUsersData = users;
      });

  ensureUsersLoaded.then(() => {
    const classStudents = allUsersData.filter(u => u.role === 'Siswa' && u.class === targetClass);

    if (classStudents.length === 0) {
        Swal.fire('Info', 'Tidak ada siswa yang terdaftar di kelas ini.', 'info');
        btn.disabled = false;
        btn.innerHTML = originalText;
        return;
    }

    classStudents.sort((a,b) => (a.username || '').localeCompare(b.username || ''));

    database.ref('Responses').once('value').then(snap => {
      const studentResults = {};
      classStudents.forEach(s => {
          studentResults[s.id] = {};
      });

      snap.forEach(child => {
         const resp = child.val();
         // Only process if it belongs to one of the class exams and a valid class student
         if (resp.ExamID && examIds.includes(String(resp.ExamID)) && studentResults[resp.UserID]) {
             studentResults[resp.UserID][resp.ExamID] = {
                 score: resp.Score || 0,
                 status: resp.Status || '',
                 submitTime: resp.SubmitTime || ''
             };
         }
      });

      const logoImg = document.getElementById('login-logo-img') || document.querySelector('.sidebar-logo') || document.querySelector('img[src*="logo"]');
      const logoUrl = logoImg ? logoImg.src : 'https://via.placeholder.com/150';

      let tableHtml = `<!DOCTYPE html><html><head><meta charset="utf-8">
        <title>Rekap Hasil Ujian ${targetClass}</title>
        <style>
          @page { size: landscape; margin: 10mm; }
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 11px; color: #1e293b; padding: 5mm; }
          .header { text-align: center; margin-bottom: 25px; position: relative; }
          .header .logo { position: absolute; left: 15px; top: 0; width: 85px; height: auto; }
          .header h1 { font-size: 16px; font-weight: bold; margin-bottom: 3px; font-family: 'Times New Roman', Times, serif; }
          .header h2 { font-size: 20px; font-weight: bold; margin-bottom: 3px; font-family: 'Times New Roman', Times, serif; }
          .header p { font-size: 10px; color: #1e293b; margin-top: 2px; }
          .header .small-text { font-size: 9px; font-weight: bold; }
          .header-line { margin-top: 10px; margin-bottom: 2px; border: 0; border-top: 3px solid #000; display: block; }
          .header-line-thin { border: 0; border-top: 1px solid #000; margin-bottom: 20px; display: block; }
          .doc-title { text-align: center; margin-bottom: 15px; }
          .doc-title h3 { font-size: 14px; text-decoration: underline; font-weight: bold; }
          .doc-title p { font-size: 11px; margin-top: 3px; }
          table { width: 100%; border-collapse: collapse; font-size: 10px; }
          thead { display: table-header-group; }
          tr { page-break-inside: avoid; }
          th { background: #1e293b; color: white; border: 1px solid #475569; padding: 6px 5px; text-align: center; font-size: 9px; text-transform: uppercase; letter-spacing: 0.03em; }
          td { border: 1px solid #cbd5e1; padding: 5px 6px; text-align: center; vertical-align: middle; }
          td.nama { text-align: left; font-weight: 500; }
          tr:nth-child(even) { background: #f8fafc; }
          .footer { margin-top: 25px; display: flex; justify-content: flex-end; page-break-inside: avoid; }
          .ttd { text-align: center; min-width: 180px; font-size: 10px; color: #475569; }
          .ttd .line { border-top: 1px solid #1e293b; margin-top: 60px; padding-top: 3px; }
        </style>
      </head><body>
        <div class="header">
          <img src="${logoUrl}" class="logo" alt="Logo KOP Surat" crossorigin="anonymous">
          <h1>YAYASAN BUSTANUL ULUM ROKAN HILIR</h1>
          <h2>MADRASAH TSANAWIYAH BUSTANUL ULUM</h2>
          <p class="small-text">KEC. BAGAN SINEMBAH RAYA KAB. ROKAN HILIR PROV. RIAU</p>
          <p>Terakreditasi B</p>
          <p class="small-text">AKTA NOTARIS 37/2016 &nbsp;&nbsp;|&nbsp;&nbsp; PIAGAM NO. Kd.04.8/3/pp.00.4/MTs/1225/2010</p>
          <p class="small-text">IJOP : 59 Tahun 2010 &nbsp;&nbsp;|&nbsp;&nbsp; NSM : 121214070048 &nbsp;&nbsp;|&nbsp;&nbsp; NPSN : 10499236</p>
          <p style="font-style: italic;">Alamat : Panca Mukti Kec. Bagan Sinembah Raya Kab. Rokan Hilir Kode Pos. 28992</p>
        </div>
        <hr class="header-line"><hr class="header-line-thin">
        <div class="doc-title">
          <h3>REKAPITULASI NILAI UJIAN KELAS</h3>
          <p>Kelas: <strong>${targetClass}</strong> &nbsp;|&nbsp; Dicetak: ${new Date().toLocaleDateString('id-ID', {day:'2-digit',month:'long',year:'numeric'})}</p>
        </div>
        <table>
          <thead><tr>
            <th style="width:30px;">No</th>
            <th style="text-align:left; min-width:140px;">Nama Siswa</th>
            <th style="text-align:center; min-width:70px;">User ID</th>`;

      subjectNames.forEach(subj => {
          tableHtml += `<th style="text-align:center; min-width:55px;">${subj}</th>`;
      });

      tableHtml += `</tr></thead><tbody>`;

      let idx = 1;
      classStudents.forEach(student => {
          tableHtml += `<tr>`;
          tableHtml += `<td style="font-weight:600; color:#94a3b8;">${idx++}</td>`;
          tableHtml += `<td class="nama">${student.username}</td>`;
          tableHtml += `<td style="font-family:monospace;">${student.id}</td>`;

          classExams.forEach(exam => {
              const res = studentResults[student.id][exam.id];
              if (!res) {
                  tableHtml += `<td style="color:#94a3b8; font-weight:400;">-</td>`;
              } else {
                  const isCheat = res.status === 'Curang';
                  const isDone = res.status === 'Completed' || res.status === 'Selesai';
                  
                  let scoreText = res.score;
                  let scoreStyle = 'font-weight:600;';
                  
                  if (isCheat) {
                      scoreText = 'CURANG';
                      scoreStyle = 'color:#dc2626; text-decoration:line-through; font-weight:600; font-size:9px;';
                  } else if (isDone) {
                      scoreStyle = Number(res.score) >= 75 ? 'color:#059669; font-weight:600;' : (Number(res.score) < 50 ? 'color:#dc2626; font-weight:600;' : 'color:#ea580c; font-weight:600;');
                  } else {
                      scoreText = 'Ujian';
                      scoreStyle = 'color:#eab308; font-weight:600; font-size:9px;';
                  }
                  
                  tableHtml += `<td style="${scoreStyle}">${scoreText}</td>`;
              }
          });
          tableHtml += `</tr>`;
      });

      tableHtml += `</tbody></table>
        <div class="footer">
          <div class="ttd">
            <p>Mengetahui,</p>
            <p>Wali Kelas / Guru</p>
            <div class="line">( _________________________ )</div>
            <p style="font-size:9px; color:#94a3b8; margin-top:2px;">NIP.</p>
          </div>
        </div>
      </body></html>`;

      btn.disabled = false;
      btn.innerHTML = originalText;

      const printWin = window.open('', '_blank', 'width=1100,height=700');
      if (printWin) {
        printWin.document.write(tableHtml);
        printWin.document.close();
        printWin.onload = () => {
          printWin.focus();
          printWin.print();
          printWin.onafterprint = () => printWin.close();
        };
      } else {
        Swal.fire('Error', 'Gagal membuka jendela baru. Pastikan popup dibolehkan.', 'error');
      }
    }).catch(err => {
        console.error(err);
        Swal.fire('Error', 'Gagal mengambil data dari database.', 'error');
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
  });
}


/* ==========================================================================
   2. MODAL LIHAT JAWABAN SISWA (FRONTEND)
   ========================================================================== */

function viewStudentAnswers(responseId) {
  // 1. Cek & Siapkan Modal
  if (!document.getElementById('modal-view-answers')) {
    if (typeof createViewAnswersModal === 'function') {
      createViewAnswersModal();
    } else {
      console.error("Fungsi createViewAnswersModal tidak ditemukan");
      alert("Terjadi kesalahan: Modal template belum dimuat.");
      return;
    }
  }

  const modal = document.getElementById('modal-view-answers');
  const content = document.getElementById('view-answers-content');
  const title = document.getElementById('view-answers-title');

  // 2. Tampilkan State Loading
  modal.classList.remove('hidden');
  title.innerText = "Memuat Data...";
  content.innerHTML = `
        <div class="flex flex-col items-center justify-center h-64 text-slate-400">
           <i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-teal-500"></i>
           <p>Mengambil data jawaban...</p>
        </div>`;

  // --- HELPER: FORMAT TAMPILAN JODOH ---
  const formatJodohForDisplay = (pairs, studentAnswer, isKey) => {
    if (!Array.isArray(pairs) || pairs.length === 0) {
      return '<i class="text-slate-400">Data kunci tidak valid.</i>';
    }
    let html = '<ul class="text-sm space-y-2">';
    pairs.forEach(pair => {
      const left = pair.q;
      const correctRight = pair.a;
      const middleOpt = pair.m || pair.a;

      if (isKey) {
        // Tampilan Kunci Jawaban: Kiri → Jawaban
        html += `<li class="flex items-center"><b class="w-2/5 truncate" title="${left}">${left}</b> <i class="fas fa-long-arrow-alt-right mx-2 text-slate-300"></i> <span class="truncate" title="${correctRight}">${correctRight}</span></li>`;
      } else {
        // Tampilan Jawaban Siswa
        const studentChoice = studentAnswer ? studentAnswer[left] : undefined;
        const isMatch = String(studentChoice).trim().toLowerCase() === String(correctRight).trim().toLowerCase();
        const icon = isMatch ? '<i class="fas fa-check-circle text-emerald-500 ml-2"></i>' : '<i class="fas fa-times-circle text-red-500 ml-2"></i>';
        const displayChoice = studentChoice ? studentChoice : '<i class="text-slate-400">(Kosong)</i>';

        html += `<li class="flex items-center ${isMatch ? '' : 'text-red-600 font-semibold'}"><b class="w-2/5 font-medium text-slate-800 truncate" title="${left}">${left}</b> <i class="fas fa-long-arrow-alt-right mx-2 text-slate-300"></i> <span>${displayChoice}</span> ${icon}</li>`;
      }
    });
    html += '</ul>';
    return html;
  };

  // 3. Ambil data dari Firebase (dengan fallback jika ResponseID tidak ditemukan)
  const findResponseData = () => {
    return database.ref('Responses').orderByChild('ResponseID').equalTo(responseId).once('value').then(rSnap => {
      let responseData = null;
      rSnap.forEach(c => { responseData = c.val(); responseData._key = c.key; });
      if (responseData) return responseData;

      // Fallback: scan semua Responses untuk cari yang cocok
      return database.ref('Responses').once('value').then(allSnap => {
        allSnap.forEach(c => {
          const val = c.val();
          if (val.ResponseID === responseId || c.key === responseId) {
            responseData = val;
            responseData._key = c.key;
          }
        });
        return responseData;
      });
    });
  };

  findResponseData().then(responseData => {
    if (!responseData) {
      content.innerHTML = '<div class="text-red-500 text-center p-4">Data tidak ditemukan.</div>';
      title.innerText = 'Error';
      return;
    }
    const studentAnswers = responseData.Answers || {};
    const examId = responseData.ExamID;

    return database.ref('Questions').orderByChild('ExamID').equalTo(examId).once('value').then(qSnap => {
      const qList = [];
      qSnap.forEach(qc => {
        const q = qc.val();
        q._key = qc.key;
        q.id = q.QuestionID || qc.key;
        qList.push(q);
      });

      const dataItems = qList.map((q, idx) => {
        const sa = studentAnswers[q.id];
        let isCorrect = false;

        if (q.Type === 'JODOH') {
          // Bandingkan setiap pasangan
          if (sa && typeof sa === 'object' && Array.isArray(q.Options)) {
            isCorrect = true;
            q.Options.forEach(pair => {
              if (String(sa[pair.q] || '').trim().toLowerCase() !== String(pair.a || '').trim().toLowerCase()) {
                isCorrect = false;
              }
            });
            if (q.Options.length === 0) isCorrect = false;
          }
        } else if (q.Type !== 'Esai') {
          isCorrect = String(sa || '').trim().toLowerCase() === String(q.Correct || '').trim().toLowerCase();
        }

        return {
          type: q.Type || 'PG', q: q.Content || '', key: q.Correct || '',
          studentAns: sa || '', isCorrect: isCorrect, point: q.Point || 10,
          image: q.Image || '', options: q.Options || []
        };
      });

      const resName = responseData.Username || responseData.UserID || '-';
      const finalScore = responseData.Score != null ? responseData.Score : '-';

      title.innerHTML = `
                <div class="flex justify-between items-center w-full">
                    <span class="truncate max-w-[60%]">Jawab: ${resName}</span>
                    <span class="bg-blue-600 text-white px-3 py-1 rounded text-sm shadow whitespace-nowrap">Nilai Akhir: ${finalScore}</span>
                </div>`;

      let html = '<div class="space-y-4">';
      if (dataItems.length === 0) {
        html += '<div class="text-center text-slate-400 py-10">Tidak ada data soal yang ditemukan.</div>';
      } else {
        dataItems.forEach((item, idx) => {
          let statusIcon = '';
          let borderClass = 'border-slate-200';
          let bgClass = 'bg-white';
          let studentAnswerHTML = '';
          let keyAnswerHTML = '';
          let pointClean = Number.isInteger(item.point) ? item.point : parseFloat(item.point).toFixed(2);
          const scoreBadge = item.type !== 'Esai' ? `<div class="ml-2 px-2 py-1 rounded bg-slate-100 text-slate-700 border border-slate-300 text-[10px] font-bold whitespace-nowrap">Poin: ${pointClean}</div>` : '';

          if (item.type === 'Esai') {
            statusIcon = '<span class="text-[10px] bg-purple-100 text-purple-700 px-2 py-0.5 rounded border border-purple-200 font-bold">ESAI</span>';
            borderClass = 'border-purple-200';
            studentAnswerHTML = item.studentAns || '<i class="text-slate-400">(Tidak Dijawab)</i>';
            keyAnswerHTML = item.point > 0 ? `<span class="text-emerald-600 font-bold">Sudah Dinilai: ${pointClean} Poin</span>` : '(Menunggu Koreksi Guru)';
          } else if (item.type === 'JODOH' || item.type === 'Jodoh') {
            statusIcon = '<span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded border border-blue-200 font-bold">MENJODOHKAN</span>';
            let keyPairs = [];
            try { keyPairs = typeof item.key === 'string' ? JSON.parse(item.key) : item.key; } catch(e) {}
            let studentAnsObj = {};
            try { studentAnsObj = (typeof item.studentAns === 'string' && item.studentAns.trim().startsWith('{')) ? JSON.parse(item.studentAns) : item.studentAns; } catch(e) {}
            studentAnswerHTML = formatJodohForDisplay(keyPairs, studentAnsObj, false);
            keyAnswerHTML = formatJodohForDisplay(keyPairs, null, true);
          } else {
            if (item.isCorrect) {
              statusIcon = '<span class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded border border-emerald-200 font-bold"><i class="fas fa-check mr-1"></i>BENAR</span>';
              borderClass = 'border-emerald-200'; bgClass = 'bg-emerald-50/30';
            } else {
              statusIcon = '<span class="text-[10px] bg-red-100 text-red-700 px-2 py-0.5 rounded border border-red-200 font-bold"><i class="fas fa-times mr-1"></i>SALAH</span>';
              borderClass = 'border-red-200'; bgClass = 'bg-red-50/30';
            }
            studentAnswerHTML = item.studentAns || '<i class="text-slate-400">(Tidak Dijawab)</i>';
            keyAnswerHTML = item.key;
          }

          let imgHtml = item.image ? `<div class="mb-3"><img src="${item.image}" referrerpolicy="no-referrer" class="max-h-40 rounded border border-slate-200 shadow-sm"></div>` : '';

          html += `
            <div class="p-4 rounded-xl border ${borderClass} ${bgClass} transition hover:shadow-md">
              <div class="flex justify-between items-start mb-2">
                <div class="flex items-center">
                  <span class="text-xs font-bold text-slate-400 uppercase mr-2">No. ${idx + 1}</span>
                  ${scoreBadge}
                </div>
                ${statusIcon}
              </div>
              <div class="mb-3 text-slate-800 font-medium text-sm leading-relaxed">${item.q}</div>
              ${imgHtml}
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mt-3 pt-3 border-t border-slate-100">
                <div class="bg-white p-3 rounded border border-slate-200 shadow-sm">
                  <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Jawaban Siswa</p>
                  <div class="font-bold break-words ${item.isCorrect ? 'text-emerald-600' : 'text-red-600'}">${studentAnswerHTML}</div>
                </div>
                <div class="bg-slate-50 p-3 rounded border border-slate-200 shadow-inner">
                  <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Kunci Jawaban</p>
                  <div class="font-mono text-slate-600 font-medium break-words text-xs">${keyAnswerHTML}</div>
                </div>
              </div>
            </div>`;
        });
      }
      html += '</div>';
      content.innerHTML = html;
    });
  }).catch(error => {
    console.error(error);
    title.innerText = 'Error Sistem';
    content.innerHTML = `
        <div class="flex flex-col items-center justify-center h-64 text-red-500">
           <i class="fas fa-wifi text-4xl mb-3"></i>
           <p class="font-bold">Gagal menghubungi server.</p>
           <p class="text-sm text-center px-4">${error.message}</p>
        </div>`;
  });
}

function closeViewAnswersModal() {
  document.getElementById('modal-view-answers').classList.add('hidden');
}

function createViewAnswersModal() {
  const modalHtml = `
    <div id="modal-view-answers" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeViewAnswersModal()"></div>
        
        <div class="relative w-full max-w-3xl bg-white rounded-2xl shadow-2xl flex flex-col max-h-[90vh] animate-[fadeIn_0.3s_ease-out] z-[101]">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-teal-50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-teal-100 text-teal-600 flex items-center justify-center"><i class="fas fa-list-check"></i></div>
                    <h3 class="font-bold text-lg text-teal-900" id="view-answers-title">Detail Jawaban</h3>
                </div>
                <button onclick="closeViewAnswersModal()" class="text-slate-400 hover:text-red-500 transition w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar bg-slate-50" id="view-answers-content">
            </div>
            
            <div class="p-4 border-t bg-white rounded-b-2xl flex justify-end">
                <button onclick="closeViewAnswersModal()" class="px-6 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg font-bold text-sm transition">
                    Tutup
                </button>
            </div>
        </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function downloadStudentPDF(responseId, btnElement) {
  const originalHtml = btnElement.innerHTML;
  btnElement.disabled = true;
  btnElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

  // PDF student detail tidak tersedia di client-side Firebase
  btnElement.disabled = false;
  btnElement.innerHTML = originalHtml;
  Swal.fire('Fitur Tidak Tersedia', 'Fitur PDF Detail Siswa tidak tersedia dalam mode Firebase.', 'warning');
}


/* ==========================================================================
   3. LOGIKA UJIAN SISWA (EXAM INTERFACE)
   ========================================================================== */

function initStudentExam(examData) {
  Swal.fire({
    title: 'PERHATIAN SEBELUM UJIAN',
    html: `
            <div class="text-left mt-2">
                <p class="text-slate-600 mb-3 font-medium">Sistem ini sangat sensitif. Demi kelancaran ujian:</p>
                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded text-sm text-red-700 font-bold mb-4 shadow-sm">
                    <ul class="list-disc list-inside space-y-1">
                        <li>JANGAN mencoba membuka tab lain.</li>
                        <li>JANGAN keluar dari mode Full Screen.</li>
                        <li>JANGAN melakukan minimize browser.</li>
                    </ul>
                </div>
                <p class="text-slate-500 text-sm">
                    Jika terdeteksi, ujian akan <b class="text-red-600">tertutup otomatis</b> dan jawaban Anda langsung dikirim tanpa peringatan kedua.
                </p>
            </div>
        `,
    icon: 'warning',
    confirmButtonText: 'SAYA MENGERTI & MULAI',
    confirmButtonColor: '#d33',
    allowOutsideClick: false,
    allowEscapeKey: false,
    backdrop: `rgba(0,0,0,0.85)`
  }).then((result) => {
    if (result.isConfirmed) {
      violationCount = 0;
      currentExam = examData;

      switchPage('page-exam');
      enterFullscreen();

      document.getElementById('exam-subject-title').textContent = examData.subject;
      document.getElementById('student-name-display').textContent = currentUser.username;
      document.getElementById('student-id-display').textContent = currentUser.userID;

      // Ambil soal dari Firebase
      database.ref('Questions').orderByChild('ExamID').equalTo(examData.id).once('value').then(snapshot => {
        const qs = [];
        snapshot.forEach(child => {
          const q = child.val();
          q._key = child.key;
          q.id = q.QuestionID || child.key;
          q.type = q.Type || 'PG';
          q.content = q.Content || '';
          q.options = q.Options || [];
          q.correct = q.Correct || '';
          q.point = q.Point || 10;
          q.image = q.Image || '';
          q.isRequired = q.IsRequired || 'TRUE';
          qs.push(q);
        });

        // 1. SHUFFLE QUESTIONS (Melakukan pengacakan urutan soal)
        for (let i = qs.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [qs[i], qs[j]] = [qs[j], qs[i]];
        }

        // Cek apakah ada jawaban tersimpan
        return database.ref('Responses').orderByChild('ExamID').equalTo(examData.id).once('value').then(rSnap => {
          let savedAnswers = null;
          rSnap.forEach(rc => {
            const r = rc.val();
            if (r.UserID === currentUser.userID) {
              savedAnswers = r.Answers || null;
            }
          });

          if (qs.length === 0) {
            Swal.fire('Gagal', 'Tidak ada soal untuk ujian ini.', 'error').then(() => logout());
            return;
          }

          questions = qs;
          if (savedAnswers) answers = savedAnswers;
          checkpoints = {};

          renderNavGrid();
          renderQuestion(0);
          startTimer(examData.duration);
          enableAntiCheat();
        });
      });
    }
  });
}

function renderQuestion(index) {
  if (!questions || !questions[index]) return;

  if (index > currentQIndex) {
      for (let i = 0; i < index; i++) {
          const isCp = ((i + 1) % 5 === 0) || (i === questions.length - 1);
          if (isCp) {
              if (!checkpoints[i] || checkpoints[i].status !== 'done') {
                  Swal.fire('Akses Terkunci', `Anda harus menyelesaikan dan melewati Waktu Wajib Koreksi pada soal nomor ${i+1}.`, 'warning');
                  return;
              }
          }
      }
  }

  currentQIndex = index;
  const q = questions[index];

  // 2. INISIALISASI JAWABAN (Safety Check)
  if (!answers[q.id]) {
    if (q.type === 'PG_KOMPLEKS') {
      answers[q.id] = [];
    } else if (q.type === 'JODOH' || q.type === 'BS') {
      answers[q.id] = {};
    } else {
      answers[q.id] = '';
    }
  }

  let savedAns = answers[q.id];
  if (q.type === 'PG_KOMPLEKS') {
    if (!Array.isArray(savedAns)) savedAns = [];
  } else if ((q.type === 'BS' || q.type === 'JODOH') && (typeof savedAns !== 'object' || savedAns === null)) {
    savedAns = {};
  }

  // 3. RENDER HEADER
  let typeLabel = q.type;
  if (q.type === 'PG_KOMPLEKS') typeLabel = 'PG KOMPLEKS';

  const container = document.getElementById('question-container');
  container.innerHTML = '';

  const headerHTML = `
    <div class="flex items-start justify-between mb-4 fade-in">
        <div>
            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-0.5 block">Pertanyaan No.</span>
            <h2 class="text-xl font-bold text-slate-800">${index + 1}</h2>
        </div>
        <div class="flex flex-col items-end gap-1">
             <span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-[10px] font-bold border border-blue-100">${typeLabel}</span>
             ${(String(q.isRequired) === 'TRUE') ? '<span class="text-[10px] text-red-500 font-bold bg-red-50 px-2 py-0.5 rounded border border-red-100">WAJIB</span>' : ''}
        </div>
    </div>`;

  const contentHTML = `
    <div class="question-text text-base text-slate-700 leading-relaxed font-medium mb-6 whitespace-pre-wrap fade-in">
        ${q.content}
    </div>`;

  let imageHTML = '';
  if (q.image) {
    imageHTML = `
    <div class="mb-6 p-1.5 border border-slate-100 rounded-xl bg-slate-50 inline-block fade-in">
      <img src="${q.image}" referrerpolicy="no-referrer" class="max-w-full h-auto max-h-[350px] rounded-lg cursor-pointer hover:opacity-95 transition" onclick="window.open(this.src)">
    </div>`;
  }

  container.insertAdjacentHTML('beforeend', headerHTML + contentHTML + imageHTML);

  // 4. RENDER OPSI JAWABAN
  const optionsWrapper = document.createElement('div');
  optionsWrapper.className = 'space-y-4 fade-in';
  container.appendChild(optionsWrapper);

  // A. PILIHAN GANDA (PG)
  if (q.type === 'PG') {
    // 1. Map options ke object beserta nilai alphabet aslinya
    let mappedOptions = q.options.map((optContent, idx) => ({
        content: optContent,
        realVal: String.fromCharCode(65 + idx)
    }));

    // 2. Shuffle array mappedOptions
    for (let i = mappedOptions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [mappedOptions[i], mappedOptions[j]] = [mappedOptions[j], mappedOptions[i]];
    }

    // 3. Render array yang sudah di-shuffle
    mappedOptions.forEach((opt, displayIdx) => {
      const displayAlphabet = String.fromCharCode(65 + displayIdx); // Label tampilan urut A, B, C, D
      const realVal = opt.realVal; // Nilai asli yang dikirim ke database
      const isChecked = savedAns === realVal;

      const optionDiv = document.createElement('div');
      optionDiv.className = `option-label ${isChecked ? 'checked' : ''} py-3 px-4 flex items-center cursor-pointer border border-slate-200 rounded-lg hover:bg-slate-50 transition mb-2 group`;

      optionDiv.onclick = function() {
        selectOption(q.id, realVal, this);
      };

      optionDiv.innerHTML = `
          <div class="custom-radio w-5 h-5 mr-3 flex-shrink-0 border-2 border-slate-300 rounded-full group-hover:border-blue-400 transition"></div> 
          <div class="flex-1 min-w-0">
               <div class="flex items-start gap-2">
                  <span class="font-bold text-slate-400 text-xs mt-0.5 select-none flex-shrink-0">${displayAlphabet}.</span>
                  <div class="text-slate-700 font-medium text-sm prose prose-sm max-w-none">
                      ${opt.content} 
                  </div>
               </div>
          </div>`;
      optionsWrapper.appendChild(optionDiv);
    });
  }

  // B. PILIHAN GANDA KOMPLEKS
  else if (q.type === 'PG_KOMPLEKS') {
    optionsWrapper.innerHTML += '<p class="text-xs font-bold text-blue-600 mb-2 flex items-center gap-1"><i class="fas fa-check-double"></i> Pilih satu atau lebih jawaban yang benar:</p>';

    // 1. Map options ke object beserta nilai alphabet aslinya
    let mappedOptions = q.options.map((optContent, idx) => ({
        content: optContent,
        realVal: String.fromCharCode(65 + idx)
    }));

    // 2. Shuffle array mappedOptions
    for (let i = mappedOptions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [mappedOptions[i], mappedOptions[j]] = [mappedOptions[j], mappedOptions[i]];
    }

    mappedOptions.forEach((opt, displayIdx) => {
      const displayAlphabet = String.fromCharCode(65 + displayIdx); // A, B, C, D (tampilan)
      const realVal = opt.realVal; // Nilai asli yang disimpan

      const isChecked = Array.isArray(savedAns) && savedAns.includes(realVal);

      const boxClass = isChecked ? 'bg-blue-600 border-blue-600' : 'bg-white border-slate-300';
      const containerClass = isChecked ? 'checked ring-1 ring-blue-200 bg-blue-50/30' : 'bg-white hover:bg-slate-50';
      const checkboxIcon = isChecked ? '<i class="fas fa-check text-white text-[10px]"></i>' : '';

      const optionDiv = document.createElement('div');
      optionDiv.className = `option-label ${containerClass} py-3 px-4 cursor-pointer border border-slate-200 rounded-lg flex items-center transition-all duration-200 mb-2 group`;

      optionDiv.onclick = function() {
        toggleComplexPG(q.id, realVal, this);
      };

      optionDiv.innerHTML = `
          <div class="w-5 h-5 mr-3 flex items-center justify-center border rounded ${boxClass} transition-colors box-indicator flex-shrink-0 group-hover:border-blue-400">
               ${checkboxIcon}
          </div>
          <div class="flex-1 min-w-0">
               <div class="flex items-start gap-2">
                  <span class="font-bold text-slate-400 text-xs mt-0.5 select-none flex-shrink-0">${displayAlphabet}.</span>
                  <div class="text-slate-700 font-medium text-sm prose prose-sm max-w-none">
                      ${opt.content}
                  </div>
               </div>
          </div>`;
      optionsWrapper.appendChild(optionDiv);
    });
  }

  // C. BENAR / SALAH (BS)
  else if (q.type === 'BS') {
    const instruction = document.createElement('p');
    instruction.className = "text-xs font-bold text-blue-600 mb-2 flex items-center gap-1";
    instruction.innerHTML = '<i class="fas fa-info-circle"></i> Tentukan Sesuai atau Tidak Sesuai:';
    optionsWrapper.appendChild(instruction);

    const tableDiv = document.createElement('div');
    tableDiv.className = "overflow-hidden border border-slate-200 rounded-xl shadow-sm";

    let tableHTML = `
        <table class="w-full text-sm text-left text-slate-600">
          <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b border-slate-200">
            <tr>
              <th scope="col" class="px-4 py-3 font-bold w-full">Pernyataan</th>
              <th scope="col" class="px-2 py-3 text-center font-bold w-24 border-l border-slate-200 bg-blue-50/50 text-blue-700">Sesuai</th>
              <th scope="col" class="px-2 py-3 text-center font-bold w-28 border-l border-slate-200 bg-red-50/50 text-red-700">Tidak Sesuai</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100 bg-white">`;

    // 1. Map options ke object beserta original index-nya (agar saat disimpan bisa tetap sesuai DB)
    let mappedBsOptions = q.options.map((stmt, idx) => ({
        stmt: stmt,
        originalIdx: idx
    }));

    // 2. Shuffle statement-nya
    for (let i = mappedBsOptions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [mappedBsOptions[i], mappedBsOptions[j]] = [mappedBsOptions[j], mappedBsOptions[i]];
    }

    // 3. Render baris-baris sesuai hasil yang dishuffle
    mappedBsOptions.forEach((item, displayIdx) => {
      const originalIdx = item.originalIdx;
      const stmt = item.stmt;

      const rowVal = savedAns[originalIdx];
      const rowClass = (displayIdx % 2 === 0) ? 'bg-white' : 'bg-slate-50/50';

      tableHTML += `
            <tr class="${rowClass} hover:bg-blue-50 transition duration-150">
              <td class="px-4 py-3 font-medium text-slate-800 leading-relaxed prose prose-sm max-w-none">
                ${stmt}
              </td>
              <td class="px-2 py-3 text-center border-l border-slate-100 align-middle">
                <label class="cursor-pointer flex justify-center items-center h-full w-full p-2">
                  <input type="radio" name="bs_${q.id}_${originalIdx}" 
                         onchange="saveComplexBS('${q.id}', '${originalIdx}', 'Benar')"
                         ${rowVal === 'Benar' ? 'checked' : ''}
                         class="w-5 h-5 text-emerald-600 focus:ring-emerald-500 border-gray-300 cursor-pointer">
                </label>
              </td>
              <td class="px-2 py-3 text-center border-l border-slate-100 align-middle">
                <label class="cursor-pointer flex justify-center items-center h-full w-full p-2">
                  <input type="radio" name="bs_${q.id}_${originalIdx}" 
                         onchange="saveComplexBS('${q.id}', '${originalIdx}', 'Salah')"
                         ${rowVal === 'Salah' ? 'checked' : ''}
                         class="w-5 h-5 text-red-600 focus:ring-red-500 border-gray-300 cursor-pointer">
                </label>
              </td>
            </tr>`;
    });

    tableHTML += `</tbody></table>`;
    tableDiv.innerHTML = tableHTML;
    optionsWrapper.appendChild(tableDiv);
  }

  // D. MENJODOHKAN (JODOH)
  else if (q.type === 'JODOH') {
    const pairs = q.options;
    const lefts = pairs.map(p => p.q);
    let rights = pairs.map(p => p.m || p.a);

    // Shuffle array rights agar pilihan jawaban diacak urutannya
    for (let i = rights.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [rights[i], rights[j]] = [rights[j], rights[i]];
    }

    const palettes = [
      ['emerald', 'border-emerald-500', 'bg-emerald-100', 'text-emerald-800', 'ring-emerald-400'],
      ['red', 'border-red-500', 'bg-red-100', 'text-red-800', 'ring-red-400'],
      ['blue', 'border-blue-500', 'bg-blue-100', 'text-blue-800', 'ring-blue-400'],
      ['amber', 'border-amber-500', 'bg-amber-100', 'text-amber-800', 'ring-amber-400'],
      ['purple', 'border-purple-500', 'bg-purple-100', 'text-purple-800', 'ring-purple-400'],
      ['pink', 'border-pink-500', 'bg-pink-100', 'text-pink-800', 'ring-pink-400'],
    ];

    const jodohGrid = document.createElement('div');
    jodohGrid.className = "grid grid-cols-1 md:grid-cols-2 gap-6 bg-white p-4 rounded-xl border border-slate-200";

    // Kolom Kiri
    const leftCol = document.createElement('div');
    leftCol.className = "space-y-3";
    leftCol.innerHTML = '<p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest text-center mb-2">Pertanyaan</p>';

    lefts.forEach((it, i) => {
      const theme = palettes[i % palettes.length];
      const isSelected = (typeof selectedLeft !== 'undefined' && selectedLeft === it);
      const isPaired = savedAns && savedAns[it];

      let btnClass = "";
      if (isSelected) {
        btnClass = `${theme[2]} ${theme[1]} ${theme[3]} ring-2 ${theme[4]} border-l-4`;
      } else if (isPaired) {
        btnClass = `${theme[2]} ${theme[1]} ${theme[3]} border-l-4`;
      } else {
        btnClass = `bg-white border-slate-200 text-slate-600 hover:bg-slate-50 border-l-4 border-l-${theme[0]}-400`;
      }

      const btn = document.createElement('button');
      btn.className = `w-full p-3.5 text-left rounded-lg border transition-all duration-200 shadow-sm font-medium text-sm flex justify-between items-center ${btnClass}`;
      btn.onclick = function() {
        selectMatchLeft(q.id, it, this);
      };
      btn.innerHTML = `<span>${it}</span> ${isPaired ? '<i class="fas fa-link text-xs opacity-60"></i>' : ''}`;

      leftCol.appendChild(btn);
    });

    // Kolom Kanan
    const rightCol = document.createElement('div');
    rightCol.className = "space-y-3";
    rightCol.innerHTML = '<p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest text-center mb-2">Jawaban</p>';

    rights.forEach((it) => {
      let pairedColorIndex = -1;
      let isPairedRight = false;

      if (savedAns) {
        const foundKey = Object.keys(savedAns).find(key => savedAns[key] === it);
        if (foundKey) {
          isPairedRight = true;
          pairedColorIndex = lefts.indexOf(foundKey);
        }
      }

      let btnRightClass = "bg-white border-slate-200 text-slate-600 hover:bg-slate-50";
      if (isPairedRight && pairedColorIndex !== -1) {
        const theme = palettes[pairedColorIndex % palettes.length];
        btnRightClass = `${theme[2]} ${theme[1]} ${theme[3]} border-r-4 border-r-${theme[0]}-500`;
      }

      const btn = document.createElement('button');
      btn.className = `w-full p-3.5 text-right rounded-lg border transition-all duration-200 shadow-sm font-medium text-sm ${btnRightClass}`;
      btn.onclick = function() {
        selectMatchRight(q.id, it, this);
      };
      btn.innerHTML = it;

      rightCol.appendChild(btn);
    });

    jodohGrid.appendChild(leftCol);
    jodohGrid.appendChild(rightCol);
    optionsWrapper.appendChild(jodohGrid);
  }

  // E. ESAI
  else {
    const textArea = document.createElement('textarea');
    textArea.className = "w-full border border-slate-300 rounded-xl p-4 h-40 focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition text-sm text-slate-700 leading-relaxed shadow-inner bg-slate-50 focus:bg-white";
    textArea.placeholder = "Ketik jawaban Anda di sini...";
    textArea.value = savedAns || '';
    textArea.onblur = function() {
      saveAnswer(q.id, this.value);
    };

    optionsWrapper.appendChild(textArea);
  }

  // 5. UPDATE NAVIGASI
  if (typeof MathJax !== 'undefined') MathJax.typesetPromise();

  const btnPrev = document.getElementById('btn-prev');
  btnPrev.disabled = (index === 0);
  btnPrev.classList.toggle('opacity-50', index === 0);

  const btnNext = document.getElementById('btn-next');
  if (index === questions.length - 1) {
    btnNext.innerHTML = 'Selesai <i class="fas fa-flag-checkered ml-2"></i>';
    btnNext.className = "bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2.5 rounded-lg font-bold shadow-lg transition flex items-center";
    btnNext.setAttribute('onclick', 'finishExamManual()');
  } else {
    btnNext.innerHTML = 'Selanjutnya <i class="fas fa-arrow-right ml-2"></i>';
    btnNext.className = "bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-bold shadow-lg transition flex items-center";
    btnNext.setAttribute('onclick', 'nextQ()');
  }

  updateNavStyle();
  document.getElementById('main-exam-area').scrollTo(0, 0);
}


/* ==========================================================================
   4. INTERAKSI SOAL (HANDLERS)
   ========================================================================== */

function toggleComplexPG(qid, val, el) {
  let curr = answers[qid];
  if (!Array.isArray(curr)) curr = [];

  const idx = curr.indexOf(val);

  if (idx > -1) {
    // Hapus (Uncheck)
    curr.splice(idx, 1);
    el.classList.remove('checked', 'ring-1', 'ring-blue-200', 'bg-blue-50/30');
    el.classList.add('bg-white');

    const box = el.querySelector('.box-indicator');
    box.classList.remove('bg-blue-600', 'border-blue-600');
    box.classList.add('bg-white', 'border-slate-300');
    box.innerHTML = '';
  } else {
    // Tambah (Check)
    curr.push(val);
    el.classList.add('checked', 'ring-1', 'ring-blue-200', 'bg-blue-50/30');
    el.classList.remove('bg-white');

    const box = el.querySelector('.box-indicator');
    box.classList.remove('bg-white', 'border-slate-300');
    box.classList.add('bg-blue-600', 'border-blue-600');
    box.innerHTML = '<i class="fas fa-check text-white text-[10px]"></i>';
  }

  answers[qid] = curr;
  updateNavStyle();
}

function selectOption(qid, val, el) {
  const siblings = el.parentElement.querySelectorAll('.option-label');
  siblings.forEach(sib => sib.classList.remove('checked'));

  el.classList.add('checked');
  saveAnswer(qid, val);
}

function renderNavGrid() {
  document.getElementById('nav-grid').innerHTML = questions.map((q, i) =>
    `<button id="nav-btn-${i}" onclick="renderQuestion(${i})" class="nav-btn-modern">
        ${i+1}
     </button>`
  ).join('');
  updateNavStyle();
}

// --- HELPER FILTER & PAGINATION BANK SOAL ---

function handleQuestionSearch(keyword) {
    const term = keyword.toLowerCase().trim();
    // Filter dari data master allQuestionsData
    filteredQuestions = allQuestionsData.filter(q => {
        return q.content.toLowerCase().includes(term) || 
               q.type.toLowerCase().includes(term) ||
               (q.correct && q.correct.toLowerCase().includes(term));
    });
    currentQPage = 1; // Reset ke halaman 1
    // Ambil ID Exam dari hidden input untuk parameter delete (walau di renderInternal logic delete pakai value input langsung)
    const eid = document.getElementById('input-exam-id').value;
    renderQuestionsInternal(eid);
}

function changeQRowsPerPage(val) {
    if (val === 'all') {
        qRowsPerPage = filteredQuestions.length > 0 ? filteredQuestions.length : 10;
    } else {
        qRowsPerPage = parseInt(val);
    }
    currentQPage = 1;
    const eid = document.getElementById('input-exam-id').value;
    renderQuestionsInternal(eid);
}

function changeQPage(direction) {
    if (direction === 'prev') {
        if (currentQPage > 1) currentQPage--;
    } else if (direction === 'next') {
        const maxPage = Math.ceil(filteredQuestions.length / qRowsPerPage);
        if (currentQPage < maxPage) currentQPage++;
    }
    const eid = document.getElementById('input-exam-id').value;
    renderQuestionsInternal(eid);
}

// --- UPDATE NAV STYLE (Logic coloring) ---
function updateNavStyle() {
  questions.forEach((q, i) => {
     const btn = document.getElementById(`nav-btn-${i}`);
     if (btn) {
         let isAns = answers[q.id]; 
         if(typeof isAns === 'object') isAns = Object.keys(isAns).length > 0;
         else if (typeof isAns === 'string') isAns = isAns.trim() !== '';

         // Reset class base
         btn.className = 'nav-btn-modern';

         if (i === currentQIndex) {
             btn.classList.add('current');
         } else if (isAns) {
             btn.classList.add('answered');
         }
     }
  });
}

    function selectMatchLeft(qid, val, el) {
        // Hapus efek aktif dari semua tombol kiri (hapus bg-cyan-200)
        document.querySelectorAll('.match-left').forEach(b => b.classList.remove('ring-2','ring-cyan-500','bg-cyan-200'));
        
        // Tambahkan efek aktif ke tombol yang diklik (gunakan bg-cyan-200 agar lebih gelap dari base)
        el.classList.add('ring-2','ring-cyan-500','bg-cyan-200');
        selectedLeft = val;
    }
    
    function selectMatchRight(qid, val, el) {
        if(!selectedLeft) { Swal.fire('Info','Pilih sisi kiri dulu!','info'); return; }
        if(!answers[qid]) answers[qid] = {}; answers[qid][selectedLeft] = val; selectedLeft = null;
        renderQuestion(currentQIndex); database.ref('Responses').orderByChild('UserID').equalTo(currentUser.userID).once('value').then(snap => { let key = null; snap.forEach(c => { if (c.val().ExamID === currentExam.id) key = c.key; }); if (key) { database.ref('Responses/' + key).update({ Answers: answers, Violations: violationCount }); } else { database.ref('Responses').push({ UserID: currentUser.userID, ExamID: currentExam.id, Answers: answers, Violations: violationCount, Username: currentUser.username }); } });
    }

    function saveAnswer(qid, val) {
      answers[qid] = val; updateNavStyle(); database.ref('Responses').orderByChild('UserID').equalTo(currentUser.userID).once('value').then(snap => { let key = null; snap.forEach(c => { if (c.val().ExamID === currentExam.id) key = c.key; }); if (key) { database.ref('Responses/' + key).update({ Answers: answers, Violations: violationCount }); } else { database.ref('Responses').push({ UserID: currentUser.userID, ExamID: currentExam.id, Answers: answers, Violations: violationCount, Username: currentUser.username }); } });
    }


// Fungsi Penyimpanan Khusus untuk Benar/Salah Kompleks
/* --- FUNGSI SAVE COMPLEX BS (DIPERBAIKI) --- */
function saveComplexBS(qid, index, val) {
    // 1. Pastikan wadah jawaban untuk soal ini (qid) tersedia sebagai object
    // Variable 'answers' adalah variabel global tempat semua jawaban disimpan
    if (!answers[qid] || typeof answers[qid] !== 'object') {
        answers[qid] = {};
    }

    // 2. Simpan nilai jawaban spesifik untuk baris (index) tersebut
    // Kita ubah index menjadi String agar konsisten sebagai key object
    answers[qid][String(index)] = val;

    // 3. Update tampilan navigasi (agar nomor soal berubah warna menjadi hijau/terjawab)
    updateNavStyle();

    // 4. Debugging (bisa dilihat di Console browser untuk memastikan data masuk)
    console.log(`Tersimpan Soal BS Kompleks [${qid}] Baris [${index}]: ${val}`);

    // 5. Sinkronisasi ke Server (Auto-save ke Spreadsheet/Database)
    // Pengecekan agar tidak error jika data user belum siap
    if (currentUser && currentExam) {
        database.ref('Responses').orderByChild('UserID').equalTo(currentUser.userID).once('value').then(snap => {
            let key = null;
            snap.forEach(c => { if (c.val().ExamID === currentExam.id) key = c.key; });
            if (key) {
                database.ref('Responses/' + key).update({ Answers: answers, Violations: violationCount });
            } else {
                database.ref('Responses').push({ UserID: currentUser.userID, ExamID: currentExam.id, Answers: answers, Violations: violationCount, Username: currentUser.username });
            }
        }).catch(err => console.error('Gagal sync jawaban:', err));
    }
}
    function renderNavGrid() {
      document.getElementById('nav-grid').innerHTML = questions.map((q, i) => `<button id="nav-btn-${i}" onclick="renderQuestion(${i})" class="w-full aspect-square border rounded-lg flex items-center justify-center font-bold text-sm transition hover:shadow-md">${i+1}</button>`).join('');
      updateNavStyle();
    }

    function updateNavStyle() {
      questions.forEach((q, i) => {
         const btn = document.getElementById(`nav-btn-${i}`);
         if (btn) {
             let isAns = answers[q.id]; if(typeof isAns === 'object') isAns = Object.keys(isAns).length > 0;
             btn.className = `w-full aspect-square border rounded-lg flex items-center justify-center font-bold text-sm transition ${i===currentQIndex ? 'bg-yellow-100 border-yellow-400 ring-2 ring-yellow-300 text-yellow-800 scale-105 shadow' : (isAns ? 'bg-blue-600 text-white border-blue-600 shadow-sm' : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50')}`;
         }
      });

      if (typeof currentQIndex !== 'undefined' && questions.length > 0) {
          const isCp = ((currentQIndex + 1) % 5 === 0) || (currentQIndex === questions.length - 1);
          if (isCp) {
              const q = questions[currentQIndex];
              let isAns = answers[q.id];
              if(typeof isAns === 'object') isAns = Object.keys(isAns).length > 0;
              else if (typeof isAns === 'string') isAns = String(isAns).trim() !== '';

              if (isAns && !checkpoints[currentQIndex]) {
                  checkpoints[currentQIndex] = { status: 'running', remaining: 120, interval: null };
                  
                  const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 4000 });
                  Toast.fire({ icon: 'info', title: 'Waktu Wajib Koreksi Dimulai!' });

                  checkpoints[currentQIndex].interval = setInterval(() => {
                      checkpoints[currentQIndex].remaining--;
                      if (checkpoints[currentQIndex].remaining <= 0) {
                          clearInterval(checkpoints[currentQIndex].interval);
                          checkpoints[currentQIndex].status = 'done';
                      }
                      updateCheckpointUI();
                  }, 1000);
              }
          }
          updateCheckpointUI();
      }
    }

    function updateCheckpointUI() {
        const btnNext = document.getElementById('btn-next');
        if (!btnNext || questions.length === 0) return;

        const isCp = ((currentQIndex + 1) % 5 === 0) || (currentQIndex === questions.length - 1);
        if (isCp && checkpoints[currentQIndex] && checkpoints[currentQIndex].status === 'running') {
            const cp = checkpoints[currentQIndex];
            btnNext.disabled = true;
            btnNext.classList.add('opacity-50', 'cursor-not-allowed');
            btnNext.classList.replace('bg-blue-600', 'bg-slate-500');
            btnNext.classList.replace('hover:bg-blue-700', 'bg-slate-500');
            btnNext.classList.replace('bg-emerald-600', 'bg-slate-500');
            btnNext.classList.replace('hover:bg-emerald-700', 'bg-slate-500');
            btnNext.innerHTML = `Waktu Koreksi (<span class="text-yellow-300 font-mono">${cp.remaining}s</span>) <i class="fas fa-lock ml-2"></i>`;
        } else {
            btnNext.disabled = false;
            btnNext.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-slate-500');
            if (currentQIndex === questions.length - 1) {
                btnNext.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
                btnNext.innerHTML = 'Selesai <i class="fas fa-flag-checkered ml-2"></i>';
            } else {
                btnNext.classList.add('bg-blue-600', 'hover:bg-blue-700');
                btnNext.innerHTML = 'Selanjutnya <i class="fas fa-arrow-right ml-2"></i>';
            }
        }
    }

    function prevQ() { if(currentQIndex > 0) renderQuestion(currentQIndex - 1); }
    function nextQ() {
        // --- VALIDASI NAVIGASI KETAT ---
        const q = questions[currentQIndex];
        // Cek apakah soal ini wajib
        const isReq = String(q.isRequired).toUpperCase().trim() === 'TRUE';
        
        if (isReq) {
            const hasAnswer = answers[q.id] && String(answers[q.id]).trim() !== '';
            const isObjFilled = typeof answers[q.id] === 'object' && Object.keys(answers[q.id]).length > 0;
            
            // Jika wajib tapi kosong, munculkan peringatan & batalkan pindah halaman
            if ((q.type === 'JODOH' && !isObjFilled) || (q.type !== 'JODOH' && !hasAnswer)) {
                const Toast = Swal.mixin({ toast: true, position: 'center', showConfirmButton: false, timer: 1500 });
                Toast.fire({ icon: 'warning', title: 'Soal ini wajib diisi dulu!' });
                return; // STOP, JANGAN PINDAH
            }
        }
        // -------------------------------

        const isCp = ((currentQIndex + 1) % 5 === 0) || (currentQIndex === questions.length - 1);
        if (isCp) {
            const cp = checkpoints[currentQIndex];
            if (!cp || cp.status !== 'done') {
                if (!cp) {
                    Swal.fire('Perhatian', 'Anda harus menjawab soal ini terlebih dahulu untuk memulai Waktu Wajib Koreksi.', 'warning');
                } else {
                    Swal.fire('Waktu Tunggu', 'Silakan kembali memeriksa jawaban Anda dan tunggu hingga waktu koreksi selesai.', 'info');
                }
                return;
            }
        }

        if(currentQIndex < questions.length - 1) {
            renderQuestion(currentQIndex + 1);
        }
    }
    function toggleExamNav() { document.getElementById('exam-nav').classList.toggle('translate-x-full'); }

    // --- ANTI-CHEAT & SYSTEM ---
    function enableAntiCheat() {
      console.log("Anti-Cheat Strict Mode Aktif");

      // 1. Handler Klik Kanan (Matikan Menu Konteks)
      ac_ctxHandler = e => e.preventDefault();

      // 2. Handler Keyboard (Metode Whitelist)
      ac_keyHandler = e => {
        // A. Daftar Tombol yang DIBOLEHKAN (Wajib ada untuk mengetik)
        const allowedKeys = [
            'Backspace', 'Delete', 'Enter', ' ', 'Spacebar', // Edit Teks
            'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', // Navigasi Kursor
            'Shift', 'CapsLock' // Huruf Besar
        ];

        // B. Cek apakah tombol adalah Huruf (A-Z) atau Angka (0-9)
        // Regex ini mencocokkan satu karakter huruf atau angka
        const isAlphanumeric = /^[a-zA-Z0-9]$/.test(e.key);

        // C. Cek Kombinasi Terlarang (Ctrl/Alt/Meta ditekan)
        // Kita blokir keras jika ada tombol modifier ditekan
        if (e.ctrlKey || e.altKey || e.metaKey) {
            e.preventDefault();
            e.stopPropagation();
            
            // Deteksi Khusus Tombol Windows (Meta) agar langsung memicu pelanggaran
            if (e.key === 'Meta' || e.key === 'OS' || e.metaKey) {
                handleSecurityTrigger('Menekan Tombol Windows');
            }
            return false;
        }

        // D. LOGIKA UTAMA: Jika BUKAN tombol allowed DAN BUKAN huruf/angka => BLOKIR TOTAL
        if (!allowedKeys.includes(e.key) && !isAlphanumeric) {
            e.preventDefault();
            e.stopPropagation();
            // Opsional: Beri peringatan di console atau alert kecil
            // console.log("Tombol diblokir: " + e.key);
            return false;
        }
      };

      // 3. Handler Pindah Tab / Minimize
      ac_visHandler = () => {
        if (document.hidden) {
            handleSecurityTrigger('Pindah Tab / Minimize Browser');
        }
      };

      // 4. Handler Kehilangan Fokus (Blur) - Dipercepat jadi 10ms
      ac_blurHandler = () => { 
          setTimeout(() => {
              if (!document.hasFocus()) {
                  handleSecurityTrigger('Membuka Aplikasi Lain / Start Menu'); 
              } 
          }, 10); 
      };

      // 5. Handler Keluar Fullscreen
      ac_fsHandler = () => {
        if (!document.fullscreenElement && !document.webkitFullscreenElement) {
          const examPage = document.getElementById('page-exam');
          if (examPage && !examPage.classList.contains('hidden')) {
            handleSecurityTrigger('Keluar dari Mode Fullscreen');
          }
        }
      };

      // Mencegah unload halaman
      ac_unloadHandler = (e) => {
        e.preventDefault();
        e.returnValue = '';
      };

      // Registrasi Event Listener
      document.addEventListener('contextmenu', ac_ctxHandler);
      document.addEventListener('keydown', ac_keyHandler); // Menggunakan handler baru
      document.addEventListener('visibilitychange', ac_visHandler);
      window.addEventListener('blur', ac_blurHandler);
      document.addEventListener('fullscreenchange', ac_fsHandler);
      document.addEventListener('webkitfullscreenchange', ac_fsHandler);
      window.addEventListener('beforeunload', ac_unloadHandler);
    }

    function disableAntiCheat() {
      console.log("Anti-Cheat Dimatikan");
      document.removeEventListener('contextmenu', ac_ctxHandler); document.removeEventListener('keydown', ac_keyHandler); document.removeEventListener('visibilitychange', ac_visHandler); window.removeEventListener('blur', ac_blurHandler); document.removeEventListener('fullscreenchange', ac_fsHandler); document.removeEventListener('webkitfullscreenchange', ac_fsHandler); window.removeEventListener('beforeunload', ac_unloadHandler);
      document.getElementById('warning-overlay').style.display = 'none'; document.getElementById('warning-overlay').classList.add('hidden');
    }

function handleSecurityTrigger(reason) {
    console.warn("Security Triggered: " + reason);

    // 1. Log Pelanggaran ke Server (Penting untuk bukti)
    if (currentUser && currentExam) {
        database.ref('Logs').push({ UserID: currentUser.userID, ExamID: currentExam.id, Count: 1, Reason: reason, Timestamp: new Date().toISOString() });
    }

    // 2. Matikan sistem keamanan agar alert tidak spam
    disableAntiCheat();
    
    // 3. Matikan Timer
    if (timerInterval) clearInterval(timerInterval);

    // 4. Force Submit dengan Status 'Curang'
    // Parameter: (forced=true, statusLabel='Curang')
    finishExamManual(true, 'Curang');

    // 5. Tampilkan Alert Diskualifikasi
    Swal.fire({
        title: 'DISKUALIFIKASI!',
        html: `
            <div class="text-left mt-2">
                <p class="text-slate-600 mb-3">Sistem mendeteksi aktivitas terlarang:</p>
                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r mb-4 shadow-sm">
                    <p class="text-red-700 font-bold flex items-center gap-2 text-lg">
                        <i class="fas fa-exclamation-triangle"></i> ${reason}
                    </p>
                </div>
                <p class="text-sm text-slate-500 leading-relaxed">
                    Ujian dihentikan otomatis. Status Anda tercatat sebagai <b>CURANG</b>.
                </p>
            </div>
        `,
        icon: 'error',
        allowOutsideClick: false,
        allowEscapeKey: false,
        confirmButtonText: 'Tutup Aplikasi',
        confirmButtonColor: '#d33',
        width: '500px'
    }).then((result) => {
        if (result.isConfirmed) {
            logout();
        }
    });
}

    function resumeExamFromViolation() {
      const overlay = document.getElementById('warning-overlay'); overlay.style.display = 'none'; overlay.classList.add('hidden'); enterFullscreen();
    }

    function enterFullscreen() { const el = document.documentElement; if(el.requestFullscreen) el.requestFullscreen().catch(()=>{}); }

    function startTimer(dur) {
       let t = parseInt(dur) * 60;
       if(isNaN(t) || t<=0) { t = 60 * 60; }
       
       if(timerInterval) clearInterval(timerInterval);
       
       const timerDisplay = document.getElementById('timer-display');        // ID Desktop
       const timerMobile = document.getElementById('timer-display-mobile');  // ID Mobile
       
       timerInterval = setInterval(() => {
          const h = Math.floor(t/3600);
          const m = Math.floor((t%3600)/60);
          const s = t%60;
          
          // Format 00:00:00
          const timeStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
          // Format Pendek 00:00 (Untuk Mobile jika jam 0)
          const timeStrShort = h > 0 ? timeStr : `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

          // Update Tampilan Desktop
          if(timerDisplay) timerDisplay.innerText = timeStr;
          
          // Update Tampilan Mobile (PERBAIKAN DISINI)
          if(timerMobile) timerMobile.innerText = timeStrShort;

          // Waktu Habis
          if(--t < 0) { 
              clearInterval(timerInterval); 
              finishExamManual(true, 'Waktu Habis'); 
          }
       }, 1000);
    }

/* MODIFIKASI: finishExamManual */
function finishExamManual(forced = false, statusLabel = 'Completed') {
   // 1. Jika dipaksa (Waktu habis atau Curang)
   if (forced) { 
       // Langsung eksekusi submit tanpa validasi soal wajib
       executeSubmission(true, statusLabel); 
       return; 
   }

   // CHECKPOINT VALIDASI UNTUK SOAL TERAKHIR
   if (questions.length > 0) {
       const lastIdx = questions.length - 1;
       const cp = checkpoints[lastIdx];
       if (!cp || cp.status !== 'done') {
           Swal.fire('Perhatian', 'Anda wajib menjawab soal terakhir dan menunggu Waktu Wajib Koreksi sebelum mengakhiri ujian.', 'warning');
           renderQuestion(lastIdx);
           return;
       }
   }

   // 2. Validasi Soal Wajib (Hanya jika submit manual normal)
   const emptyRequired = [];
   questions.forEach((q, index) => {
       const isReq = String(q.isRequired).toUpperCase().trim() === 'TRUE';
       
       const hasAnswer = answers[q.id] && String(answers[q.id]).trim() !== '';
       const isObjFilled = typeof answers[q.id] === 'object' && Object.keys(answers[q.id]).length > 0;
       
       if (isReq) {
           if ((q.type === 'JODOH' && !isObjFilled) || (q.type !== 'JODOH' && !hasAnswer)) {
               emptyRequired.push(index + 1);
           }
       }
   });

   // 3. Jika ada soal wajib yang kosong, tolak submit
   if (emptyRequired.length > 0) {
       Swal.fire({
           title: 'Jawaban Belum Lengkap!',
           html: `<p>Anda tidak bisa mengumpulkan ujian karena soal berikut wajib diisi:</p><br><b class="text-red-600 text-xl">Nomor: ${emptyRequired.join(', ')}</b>`,
           icon: 'error',
           confirmButtonText: 'Lengkapi Jawaban',
           confirmButtonColor: '#d33'
       });
       return; 
   }

   // 4. Konfirmasi Submit Normal
   Swal.fire({ 
       title: 'Selesai Ujian?', 
       text: "Yakin ingin mengumpulkan jawaban?", 
       icon: 'question', 
       showCancelButton: true, 
       confirmButtonColor: '#2563eb', 
       cancelButtonColor: '#d33', 
       confirmButtonText: 'Ya, Kumpulkan!', 
       cancelButtonText: 'Batal' 
   }).then((result) => { 
       if (result.isConfirmed) { 
           // Submit normal statusnya pasti 'Completed'
           executeSubmission(false, 'Completed'); 
       } 
   });
}

function resetQuestionForm() {
    // 1. Reset Hidden ID (Kecuali ExamID agar user tidak perlu pilih mapel lagi jika input beruntun)
    document.getElementById('input-question-id').value = '';
    
    // 2. Reset Tipe Soal ke Default (PG)
    document.getElementById('q-type-select').value = 'PG';
    
    // -----------------------------------------------------------
    // [BARU] 3. RESET BOBOT NILAI (POINT)
    // -----------------------------------------------------------
    // Pastikan elemen ada sebelum di-set (mencegah error di versi lama)
    if (document.getElementById('input-point')) {
        document.getElementById('input-point').value = '10'; // Default 10 Poin
    }

    // 4. Reset Editor Konten Utama (TinyMCE atau Textarea Biasa)
    if (typeof tinymce !== 'undefined' && tinymce.get('editor-content')) {
        tinymce.get('editor-content').setContent('');
    } else {
        document.getElementById('editor-content').value = '';
    }

    // 5. Reset Input Gambar
    document.getElementById('input-image-ac').value = '';
    if(document.getElementById('input-image-size')) {
        document.getElementById('input-image-size').value = 'w1000'; // Default Besar
    }
    // Sembunyikan hasil autocomplete jika masih terbuka
    if(document.getElementById('ac-results')) {
        document.getElementById('ac-results').classList.add('hidden');
    }

    // 6. Reset Status Wajib
    const reqSelect = document.querySelector('select[name="isRequired"]');
    if(reqSelect) reqSelect.value = 'TRUE'; // Default Wajib atau FALSE sesuai preferensi Anda

    // 7. Reset Opsi Jawaban A-E (Untuk PG)
    for(let i=0; i<5; i++) {
        if(tinymce.get('opt-'+i)) {
            tinymce.get('opt-'+i).setContent('');
        } else {
            const el = document.getElementById('opt-'+i);
            if(el) el.value = '';
        }
    }

    // 8. Reset Container Khusus (BS & Menjodohkan)
    if(document.getElementById('bs-container')) document.getElementById('bs-container').innerHTML = '';
    if(document.getElementById('pairs-container')) document.getElementById('pairs-container').innerHTML = '';

    // 9. Reset Kunci Jawaban Text
    document.getElementById('correct-input').value = '';

    // 10. Kembalikan Tampilan Input ke Mode PG
    toggleOptionsInput('PG');

    // 11. KEMBALIKAN TOMBOL KE MODE "SIMPAN" (BIRU)
    // Karena saat Edit tombol berubah jadi Orange/Update
    const btn = document.querySelector('form[onsubmit="handleAddQuestion(event)"] button[type="submit"]');
    if(btn) {
        btn.innerHTML = '<i class="fas fa-save"></i> Simpan Pertanyaan';
        // Reset kelas CSS tombol ke style Biru (Default)
        btn.className = 'w-full bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 transform active:scale-95';
    }
}

/* --- FUNGSI ISI FORM SAAT EDIT --- */
/* --- FUNGSI ISI FORM SAAT EDIT (SUDAH DIPERBAIKI UNTUK PG KOMPLEKS) --- */
function editQuestion(qStr) {
    // Decode data soal dari string JSON
    const q = JSON.parse(decodeURIComponent(qStr));

    // 1. Buka Tab Manual & Scroll ke atas
    document.getElementById('form-add-q').classList.remove('hidden');
    document.getElementById('form-import-q').classList.add('hidden');
    document.getElementById('form-import-excel').classList.add('hidden');
    document.getElementById('form-copy-q').classList.add('hidden');
    document.getElementById('form-add-q').scrollIntoView({ behavior: 'smooth' });

    // 2. Isi Form Dasar (ID & Tipe)
    document.getElementById('input-question-id').value = q.id;
    document.getElementById('input-exam-id').value = q.examId; 
    document.querySelector('select[name="type"]').value = q.type;
    
    // -----------------------------------------------------------
    // [BARU] 3. ISI BOBOT NILAI (POINT)
    // -----------------------------------------------------------
    // Cek apakah elemen input ada, lalu isi value. Default 10 jika null.
    if (document.getElementById('input-point')) {
        document.getElementById('input-point').value = q.point || 10;
    }

    // -----------------------------------------------------------
    // 4. ISI KONTEN KE EDITOR TINYMCE UTAMA (SOAL)
    // -----------------------------------------------------------
    if (typeof tinymce !== 'undefined' && tinymce.get('editor-content')) {
        tinymce.get('editor-content').setContent(q.content || '');
    } else {
        document.getElementById('editor-content').value = q.content || '';
    }

    // 5. Isi Data Gambar Header (Jika ada)
    document.querySelector('input[name="image"]').value = q.image || '';

    // --- LOGIKA: DETEKSI UKURAN GAMBAR ---
    const sizeSelect = document.getElementById('input-image-size');
    if (sizeSelect) {
        if (q.image) {
            if (q.image.includes('sz=w300')) {
                sizeSelect.value = 'w300';
            } else if (q.image.includes('sz=w600')) {
                sizeSelect.value = 'w600';
            } else {
                sizeSelect.value = 'w1000';
            }
        } else {
            sizeSelect.value = 'w1000';
        }
    }

    // 6. Perbaikan seleksi status Wajib (TRUE/FALSE)
    const reqSelect = document.querySelector('select[name="isRequired"]');
    if(reqSelect) {
        const val = String(q.isRequired).toUpperCase().trim();
        reqSelect.value = (val === 'TRUE') ? 'TRUE' : 'FALSE';
    }

    // 7. Atur Tampilan Opsi berdasarkan Tipe (PG/BS/JODOH)
    toggleOptionsInput(q.type);

    // 8. Parsing Data Options (Cegah error jika JSON rusak)
    let options = [];
    try {
        options = (typeof q.options === 'string') ? JSON.parse(q.options) : q.options;
    } catch(e) { options = []; }

    // --- PENGISIAN OPSI BERDASARKAN TIPE ---

    // ============================================================
    // A. TIPE: PILIHAN GANDA (PG BIASA & PG KOMPLEKS)
    // ============================================================
    if (q.type === 'PG' || q.type === 'PG_KOMPLEKS') {
        
        // Loop untuk 5 opsi (A, B, C, D, E)
        for(let i=0; i<5; i++) {
             // A. Reset dulu kontennya agar bersih
             if(tinymce.get('opt-'+i)) {
                 tinymce.get('opt-'+i).setContent('');
             } else {
                 const el = document.getElementById('opt-'+i);
                 if(el) el.value = '';
             }

             // B. Isi dengan data jika ada 
             if(Array.isArray(options) && options[i]) {
                 if(tinymce.get('opt-'+i)) {
                     tinymce.get('opt-'+i).setContent(options[i]);
                 } else {
                     const el = document.getElementById('opt-'+i);
                     if(el) el.value = options[i];
                 }
             }
        }

        // Isi Kunci Jawaban
        let keyDisplay = q.correct; 

        // [KHUSUS PG KOMPLEKS] Ubah Array JSON ["A", "C"] -> String "A, C"
        if (q.type === 'PG_KOMPLEKS') {
            try {
                if (Array.isArray(keyDisplay)) {
                     keyDisplay = keyDisplay.join(', ');
                } else {
                    const parsedKey = JSON.parse(keyDisplay);
                    if (Array.isArray(parsedKey)) {
                        keyDisplay = parsedKey.join(', '); 
                    }
                }
            } catch(e) {}
        }

        document.getElementById('correct-input').value = keyDisplay || ''; 
    } 
    
    // ============================================================
    // B. TIPE: BENAR/SALAH (BS)
    // ============================================================
    else if (q.type === 'BS') {
        const container = document.getElementById('bs-container');
        container.innerHTML = ''; // Bersihkan baris lama
        
        // Parsing Kunci Jawaban JSON 
        let keys = {};
        try { 
            keys = (typeof q.correct === 'string') ? JSON.parse(q.correct) : q.correct; 
        } catch(e) {}

        if(Array.isArray(options)) {
            options.forEach((stmt, idx) => {
                const keyVal = keys ? (keys[idx] || 'Benar') : 'Benar';
                addBsRowInput(stmt, keyVal);
            });
        }
    }

    // ============================================================
    // C. TIPE: MENJODOHKAN (JODOH)
    // ============================================================
    else if (q.type === 'JODOH') {
        const container = document.getElementById('pairs-container');
        container.innerHTML = ''; // Bersihkan input lama
        
        if(Array.isArray(options)) {
            options.forEach(pair => {
                addPairInput(pair.q || '', pair.m || pair.a || '', pair.a || '');
            });
        }
    }
    
    // ============================================================
    // D. TIPE: ESAI
    // ============================================================
    else if (q.type === 'Esai') {
        document.getElementById('correct-input').value = q.correct || ''; 
    }

    // 9. Ubah Tombol Simpan jadi Mode Update (Warna Orange)
    const btn = document.querySelector('form[onsubmit="handleAddQuestion(event)"] button[type="submit"]');
    if(btn) {
        btn.innerHTML = '<i class="fas fa-edit mr-1"></i> Update Perubahan';
        btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        btn.classList.add('bg-orange-600', 'hover:bg-orange-700'); 
    }
}

function executeSubmission(forced, statusLabel) {
    // Matikan fitur keamanan & timer
    disableAntiCheat(); 
    clearInterval(timerInterval); 
    
    // Tampilkan Loading
    document.getElementById('global-loading').classList.remove('hidden');

    // Submit via Firebase — Hitung skor di client-side
    database.ref('Questions').orderByChild('ExamID').equalTo(currentExam.id).once('value').then(qSnap => {
      const qList = [];
      qSnap.forEach(c => { qList.push(c.val()); });

      // Hitung skor
      let totalScore = 0;
      let totalPoints = 0;
      qList.forEach(q => {
        const pts = parseInt(q.Point) || 10;
        const qid = q.QuestionID;
        const sa = answers[qid];

        if (q.Type === 'Esai') {
          totalPoints += pts;
          // Esai tidak dinilai otomatis
        } else if (q.Type === 'JODOH') {
          // JODOH: Hitung per pasang
          if (Array.isArray(q.Options)) {
            totalPoints += (q.Options.length * pts);
            if (sa && typeof sa === 'object') {
               q.Options.forEach(pair => {
                 const studentChoice = sa[pair.q];
                 if (String(studentChoice || '').trim().toLowerCase() === String(pair.a || '').trim().toLowerCase()) {
                   totalScore += pts;
                 }
               });
            }
          } else {
             totalPoints += pts;
          }
        } else if (q.Type === 'BS') {
          // BS: Hitung per pernyataan
          let bsKey = {};
          try { bsKey = typeof q.Correct === 'string' ? JSON.parse(q.Correct) : q.Correct; } catch(e){}
          
          if (bsKey && typeof bsKey === 'object') {
             const itemCount = Object.keys(bsKey).length;
             totalPoints += (itemCount * pts);
             
             if (sa && typeof sa === 'object') {
                Object.keys(bsKey).forEach(idx => {
                   if (String(sa[idx] || '').trim().toLowerCase() === String(bsKey[idx] || '').trim().toLowerCase()) {
                      totalScore += pts;
                   }
                });
             }
          } else {
             totalPoints += pts;
          }
        } else {
          // PG, PG_KOMPLEKS (string), dll
          totalPoints += pts;
          if (String(sa || '').trim().toLowerCase() === String(q.Correct || '').trim().toLowerCase()) {
            totalScore += pts;
          }
        }
      });
      const finalScore = totalPoints > 0 ? Math.round((totalScore / totalPoints) * 100) : 0;

      // Simpan ke Firebase
      return database.ref('Responses').orderByChild('UserID').equalTo(currentUser.userID).once('value').then(rSnap => {
        let key = null;
        rSnap.forEach(c => { if (c.val().ExamID === currentExam.id) key = c.key; });
        const data = {
          UserID: currentUser.userID, ExamID: currentExam.id, Username: currentUser.username,
          Answers: answers, Score: finalScore, Status: statusLabel,
          Violations: violationCount, SubmittedAt: new Date().toISOString()
        };
        if (key) {
          // Pastikan ResponseID selalu ada saat update agar query view tidak gagal
          data.ResponseID = 'RESP_' + key;
          return database.ref('Responses/' + key).update(data);
        } else {
          data.ResponseID = 'RESP_' + Date.now();
          return database.ref('Responses').push(data);
        }
      });
    }).then(() => {
        document.getElementById('global-loading').classList.add('hidden');
        
        // Keluar dari fullscreen jika aktif
        if (document.exitFullscreen) document.exitFullscreen().catch(()=>{});

        // Tampilkan Halaman Selesai
        document.getElementById('page-exam').innerHTML = `
        <div class="min-h-screen flex flex-col items-center justify-center bg-white text-center p-6 fade-in">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center text-green-600 mb-6 text-4xl shadow-lg animate-bounce">
                <i class="fas fa-check"></i>
            </div>
            <h2 class="text-3xl font-bold text-slate-800">Ujian Selesai!</h2>
            <p class="text-slate-500 mt-2">Jawaban Anda telah disimpan ke dalam sistem.</p>
            
            <div class="mt-8 p-6 bg-slate-50 rounded-xl border border-slate-200 min-w-[300px] shadow-sm">
                <p class="text-sm text-slate-500 uppercase font-bold tracking-wide">Status Akhir</p>
                <p class="text-2xl font-bold ${statusLabel === 'Curang' ? 'text-red-600' : 'text-blue-600'} mt-2">
                    ${statusLabel === 'Curang' ? 'DISKUALIFIKASI (CURANG)' : 'SELESAI'}
                </p>
            </div>
            
            <button onclick="logout()" class="mt-8 px-8 py-3 bg-slate-800 hover:bg-slate-900 text-white rounded-lg font-bold transition shadow-lg transform active:scale-95 flex items-center gap-2">
                <i class="fas fa-sign-out-alt"></i> Keluar Aplikasi
            </button>
        </div>`;
        
        // Scroll ke atas
        window.scrollTo(0, 0);

        // Notifikasi Sukses (Hanya jika tidak dipaksa)
        if (!forced) { 
            Swal.fire({
                title: 'Terkirim!', 
                text: 'Jawaban Anda telah disimpan.', 
                icon: 'success',
                timer: 3000,
                showConfirmButton: false
            });
        }
    });
}

function openGradingModal(responseId) {
    // 1. Set ID ke variabel global
    currentGradingId = responseId;

    // 2. Ambil elemen DOM
    const modal = document.getElementById('modal-grading');
    const content = document.getElementById('grading-content');
    const nameDisplay = document.getElementById('grading-student-name');
    const scoreInput = document.getElementById('input-essay-score');

    // 3. Tampilkan Modal & Loading
    modal.classList.remove('hidden');
    content.innerHTML = '<div class="flex flex-col items-center py-10 text-slate-400"><i class="fas fa-circle-notch fa-spin text-3xl mb-2 text-blue-500"></i> Memuat jawaban esai...</div>';
    
    // Reset input sementara loading (agar tidak menampilkan nilai sisa sebelumnya)
    scoreInput.value = ''; 

    // 4. Panggil Data dari Firebase (dengan fallback)
    const findResp = () => {
      return database.ref('Responses').orderByChild('ResponseID').equalTo(responseId).once('value').then(rSnap => {
        let respData = null;
        rSnap.forEach(c => { respData = c.val(); respData._key = c.key; });
        if (respData) return respData;
        return database.ref('Responses').once('value').then(allSnap => {
          allSnap.forEach(c => { const v = c.val(); if (v.ResponseID === responseId || c.key === responseId) { respData = v; respData._key = c.key; } });
          return respData;
        });
      });
    };
    findResp().then(respData => {
      if (!respData) {
        content.innerHTML = '<div class="text-red-500 text-center p-4">Data tidak ditemukan.</div>';
        return;
      }
      const examId = respData.ExamID;
      nameDisplay.innerText = 'Siswa: ' + (respData.Username || respData.UserID || 'Tanpa Nama');

      return database.ref('Questions').orderByChild('ExamID').equalTo(examId).once('value').then(qSnap => {
        const essayItems = [];
        qSnap.forEach(qc => {
          const q = qc.val();
          if (q.Type === 'Esai') {
            essayItems.push({ question: q.Content || '', answer: (respData.Answers || {})[q.QuestionID || qc.key] || '' });
          }
        });

        if (essayItems.length === 0) {
          content.innerHTML = '<div class="text-center py-8"><i class="fas fa-check-circle text-4xl text-green-300 mb-3"></i><p class="text-slate-600 font-bold">Tidak ada soal Esai.</p><p class="text-slate-400 text-sm">Nilai sudah otomatis dari Pilihan Ganda.</p></div>';
          scoreInput.value = 0;
          scoreInput.disabled = true;
        } else {
          let html = '<div class="space-y-6">';
          essayItems.forEach((item, idx) => {
            html += `<div class="bg-slate-50 p-4 rounded-xl border border-slate-200"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-500 uppercase">Soal Esai #${idx+1}</span></div><p class="text-slate-800 font-medium mb-3">${item.question}</p><div class="bg-white p-3 rounded border border-slate-200 text-slate-700 text-sm whitespace-pre-wrap font-serif italic">"${item.answer || '-'}"</div></div>`;
          });
          html += '</div>';
          content.innerHTML = html;
          scoreInput.disabled = false;
        }

        // Tampilkan nilai lama
        if (respData.EssayScore !== undefined && respData.EssayScore !== null) {
          scoreInput.value = respData.EssayScore;
        } else {
          scoreInput.value = 0;
        }
      });
    }).catch(err => {
      console.error(err);
      content.innerHTML = '<div class="text-red-500 text-center p-4">Error: ' + err.message + '</div>';
    });
}
    function closeGradingModal() {
        document.getElementById('modal-grading').classList.add('hidden');
        currentGradingId = null;
    }

function submitEssayGrade() {
    // 1. Ambil input nilai
    const inputElem = document.getElementById('input-essay-score');
    if (!inputElem) {
        console.error("Input score tidak ditemukan!"); 
        return;
    }
    const score = inputElem.value;

    // 2. Validasi input
    if (score === '' || score < 0) {
        Swal.fire('Error', 'Masukkan poin esai yang valid (Angka Positif).', 'error');
        return;
    }

    // 3. Efek tombol loading
    // Mencari tombol simpan di dalam modal (sesuaikan selector jika perlu)
    const btn = document.querySelector('#modal-grading button.btn-primary') || document.querySelector('#modal-grading button[onclick="submitEssayGrade()"]');
    let oldText = 'Simpan';
    if (btn) {
        oldText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
    }

    // 4. Kirim ke Firebase (dengan fallback)
    const findGrading = () => {
      return database.ref('Responses').orderByChild('ResponseID').equalTo(currentGradingId).once('value').then(snap => {
        let rKey = null; let responseData = null;
        snap.forEach(c => { rKey = c.key; responseData = c.val(); });
        if (rKey) return { rKey, responseData };
        return database.ref('Responses').once('value').then(allSnap => {
          allSnap.forEach(c => { const v = c.val(); if (v.ResponseID === currentGradingId || c.key === currentGradingId) { rKey = c.key; responseData = v; } });
          return { rKey, responseData };
        });
      });
    };
    findGrading().then(({rKey, responseData}) => {
      if (!rKey) throw new Error('Data tidak ditemukan.');

      // Update EssayScore dan hitung ulang finalScore
      const examId = responseData.ExamID;
      return database.ref('Questions').orderByChild('ExamID').equalTo(examId).once('value').then(qSnap => {
        const qList = [];
        qSnap.forEach(c => { qList.push(c.val()); });
        let autoScore = 0;
        let totalPoints = 0;
        qList.forEach(q => {
          const pts = parseInt(q.Point) || 10;
          
          if (q.Type === 'Esai') {
             totalPoints += pts;
          } else if (q.Type === 'JODOH') {
             if (Array.isArray(q.Options)) {
                totalPoints += (q.Options.length * pts);
                const sa = (responseData.Answers || {})[q.QuestionID];
                if (sa && typeof sa === 'object') {
                   q.Options.forEach(pair => {
                      if (String(sa[pair.q] || '').trim().toLowerCase() === String(pair.a || '').trim().toLowerCase()) {
                         autoScore += pts;
                      }
                   });
                }
             } else { totalPoints += pts; }
          } else if (q.Type === 'BS') {
             let bsKey = {};
             try { bsKey = typeof q.Correct === 'string' ? JSON.parse(q.Correct) : q.Correct; } catch(e){}
             if (bsKey && typeof bsKey === 'object') {
                totalPoints += (Object.keys(bsKey).length * pts);
                const sa = (responseData.Answers || {})[q.QuestionID];
                if (sa && typeof sa === 'object') {
                   Object.keys(bsKey).forEach(k => {
                      if (String(sa[k] || '').trim().toLowerCase() === String(bsKey[k] || '').trim().toLowerCase()) {
                         autoScore += pts;
                      }
                   });
                }
             } else { totalPoints += pts; }
          } else {
            // PG, dll
            totalPoints += pts;
            const sa = (responseData.Answers || {})[q.QuestionID];
            if (String(sa || '').trim().toLowerCase() === String(q.Correct || '').trim().toLowerCase()) {
              autoScore += pts;
            }
          }
        });
        const finalScore = totalPoints > 0 ? Math.round(((autoScore + score) / totalPoints) * 100) : 0;
        return database.ref('Responses/' + rKey).update({ EssayScore: score, Score: finalScore }).then(() => finalScore);
      });
    }).then(finalScore => {
      if (btn) { btn.disabled = false; btn.innerHTML = oldText; }
      if (typeof closeGradingModal === 'function') closeGradingModal();

      const btnAction = document.querySelector(`button[onclick*="${currentGradingId}"], a[onclick*="${currentGradingId}"]`);
      if (btnAction) {
        const row = btnAction.closest('tr');
        if (row) {
          const cells = row.querySelectorAll('td');
          const targetIndex = 6;
          if (cells.length > targetIndex) {
            const cellNilai = cells[targetIndex];
            const divNilai = cellNilai.querySelector('div') || cellNilai;
            divNilai.innerText = finalScore;
            divNilai.style.transition = 'all 0.3s ease';
            divNilai.style.fontWeight = 'bold';
            divNilai.style.color = '#16a34a';
            divNilai.style.transform = 'scale(1.2)';
            setTimeout(() => {
              divNilai.style.transform = 'scale(1)';
              if (finalScore < 50) divNilai.style.color = '#dc2626';
            }, 500);
          }
        }
      }

      Swal.fire({ title: 'Tersimpan!', text: `Nilai total diperbarui menjadi: ${finalScore}`, icon: 'success', timer: 1500, showConfirmButton: false });
    }).catch(err => {
      if (btn) { btn.disabled = false; btn.innerHTML = oldText; }
      Swal.fire('Gagal', err.message, 'error');
    });
}
function checkSavedSession() {
    // 1. Cek apakah ada data sesi di LocalStorage browser
    const savedSession = localStorage.getItem('sipadu_session');

    if (savedSession) {
        try {
            const sess = JSON.parse(savedSession);

            // Jika data tidak lengkap, anggap invalid
            if (!sess.userID || !sess.token) {
                localStorage.removeItem('sipadu_session');
                return;
            }

            // 2. Tampilkan Loading, Sembunyikan Login Form
            // Ini mencegah kedipan (flicker) form login saat me-refresh halaman
            document.getElementById('page-login').classList.add('hidden');
            document.getElementById('global-loading').classList.remove('hidden');

            // 3. Validasi Token via Firebase
            database.ref('Users').orderByChild('UserID').equalTo(sess.userID).once('value').then(snapshot => {
                document.getElementById('global-loading').classList.add('hidden');
                let foundUser = null;
                snapshot.forEach(child => {
                  const u = child.val();
                  if (u.SessionToken === sess.token) {
                    foundUser = u;
                    foundUser._key = child.key;
                  }
                });

                if (foundUser) {
                    // === TOKEN VALID ===
                    const role = foundUser.Role || 'Siswa';
                    console.log('Auto-login berhasil sebagai:', role);
                    currentUser = {
                      success: true, userID: foundUser.UserID, username: foundUser.Username || foundUser.UserID,
                      role: role, token: foundUser.SessionToken, class: foundUser.Class || ''
                    };

                    if (role === 'Admin' || role === 'Guru') {
                        initAdminPanel();
                    } else {
                        Swal.fire({
                            title: 'Sesi Dipulihkan',
                            text: 'Silakan masukkan kembali PIN Ujian jika diminta.',
                            icon: 'info',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        localStorage.removeItem('sipadu_session');
                        document.getElementById('page-login').classList.remove('hidden');
                    }

                } else {
                    // === TOKEN INVALID ===
                    localStorage.removeItem('sipadu_session');
                    document.getElementById('page-login').classList.remove('hidden');
                }
            }).catch(err => {
                console.error('Gagal cek sesi:', err);
                document.getElementById('global-loading').classList.add('hidden');
                document.getElementById('page-login').classList.remove('hidden');
            });

        } catch (e) {
            // Jika JSON error
            console.error("Error parsing session:", e);
            localStorage.removeItem('sipadu_session');
            document.getElementById('page-login').classList.remove('hidden');
        }
    } else {
        // Tidak ada sesi tersimpan, biarkan di halaman login
        // Tidak perlu melakukan apa-apa
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // 1. --- TAMBAHAN BARU: Simpan kode HTML asli halaman ujian ---
    // Ini penting agar saat logout, kita bisa mengembalikan tampilan ke awal
    const examPageEl = document.getElementById('page-exam');
    if (examPageEl) {
        initialExamHTML = examPageEl.innerHTML;
    }
    // ------------------------------------------------------------

    // 2. Cek Sesi (yang sudah ada sebelumnya)
    checkSavedSession(); 
});

/* -----------------------------------------------------------
   LOGIKA IMPORT EXCEL
   ----------------------------------------------------------- */

function downloadTemplateExcel() {
    const headers = ["Tipe", "Pertanyaan", "Opsi_A", "Opsi_B", "Opsi_C", "Opsi_D", "Opsi_E", "Kunci_Jawaban", "Wajib"];
    
    const sample = [
        // PG Biasa
        ["PG", "Apa warna langit?", "Merah", "Biru", "Hijau", "Kuning", "Hitam", "Biru", "TRUE"],
        // PG Fleksibel
        ["PG", "1 + 1 = ?", "3", "2", "5", "", "", "2", "TRUE"],
        // Benar Salah
        ["BS", "Bumi itu bulat.", "Benar", "Salah", "", "", "", "Benar", "TRUE"],
        // Esai
        ["Esai", "Jelaskan tentang atom.", "", "", "", "", "", "", "FALSE"],
        
        // --- [BARU] CONTOH MENJODOHKAN ---
        // Format: "Pertanyaan=Jawaban"
        ["JODOH", "Pasangkan Negara dan Ibu Kota", "Indonesia=Jakarta", "Jepang=Tokyo", "Inggris=London", "", "", "Auto-Check", "TRUE"]
    ];
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...sample]);
    
    // Atur lebar kolom
    ws['!cols'] = [{wch:10}, {wch:40}, {wch:20}, {wch:20}, {wch:20}, {wch:20}, {wch:20}, {wch:20}, {wch:10}];
    
    XLSX.utils.book_append_sheet(wb, ws, "Template");
    XLSX.writeFile(wb, "Template_Soal_Lengkap.xlsx");
}

function processExcelImport() {
    const fileInput = document.getElementById('input-excel-file');
    const examId = document.getElementById('select-exam-q').value;

    if (!examId) {
        Swal.fire('Peringatan', 'Silakan pilih Mata Pelajaran di dropdown atas terlebih dahulu!', 'warning');
        return;
    }

    if (fileInput.files.length === 0) {
        Swal.fire('Peringatan', 'Pilih file Excel (.xlsx) dulu.', 'warning');
        return;
    }

    const file = fileInput.files[0];
    const reader = new FileReader();

    const btn = document.querySelector('button[onclick="processExcelImport()"]');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Membaca File...';

    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

            if (rawData.length > 0) rawData.shift(); // Hapus Header

            const questionsToSave = [];

            rawData.forEach((row) => {
                if (row.length === 0) return;

                const type = row[0] ? String(row[0]).trim() : "";
                const content = row[1] ? String(row[1]).trim() : "";

                if (type && content) {
                    let options = [];
                    let key = "";
                    let isReq = "FALSE";

                    // === LOGIKA PILIHAN GANDA ===
                    if (type === 'PG') {
                        const potentialOptions = [row[2], row[3], row[4], row[5], row[6]];
                        options = potentialOptions.filter(opt => opt !== undefined && opt !== null && String(opt).trim() !== "").map(String);
                        key = row[7] ? String(row[7]).trim() : "";
                    
                    // === LOGIKA BENAR SALAH ===
                    } else if (type === 'BS') {
                        options = ["Benar", "Salah"];
                        key = row[7] ? String(row[7]).trim() : "";

                    // === LOGIKA MENJODOHKAN (BARU) ===
                    } else if (type === 'JODOH') {
                        // Ambil kolom opsi, filter yang kosong
                        const rawPairs = [row[2], row[3], row[4], row[5], row[6]];
                        const validStrings = rawPairs.filter(p => p && String(p).trim() !== "");
                        
                        options = validStrings.map(pairStr => {
                            // Format: "Left=Mid=Answer" atau "Left=Answer" (backwards compatible)
                            const parts = String(pairStr).split('=');
                            if (parts.length >= 3) {
                                // 3 bagian: soal=opsi=jawaban
                                return { q: parts[0].trim(), m: parts[1].trim(), a: parts.slice(2).join('=').trim() };
                            } else if (parts.length >= 2) {
                                // 2 bagian: soal=jawaban (backward compat)
                                const qSide = parts[0].trim();
                                const aSide = parts.slice(1).join('=').trim();
                                return { q: qSide, m: aSide, a: aSide };
                            }
                            return null;
                        }).filter(item => item !== null);

                        key = "Auto-Check"; // Kunci otomatis

                    // === LOGIKA ESAI ===
                    } else if (type === 'Esai') {
                        options = [];
                        key = "";
                    }

                    if (row[8]) isReq = String(row[8]).toUpperCase();

                    questionsToSave.push({
                        type: type,
                        content: content,
                        options: options,
                        correct: key,
                        isRequired: isReq,
                        image: ''
                    });
                }
            });

            if (questionsToSave.length === 0) throw new Error("Tidak ada data soal valid.");

            btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Mengupload...';
            
            // Simpan soal ke Firebase
            const promises = questionsToSave.map(q => {
              return database.ref('Questions').push({
                ExamID: examId,
                QuestionID: 'Q_' + Date.now() + '_' + Math.random().toString(36).substr(2,5),
                Type: q.type, Content: q.content, Options: q.options,
                Correct: q.correct, IsRequired: q.isRequired, Point: q.point || 10, Image: q.image || ''
              });
            });
            Promise.all(promises).then(() => {
              btn.disabled = false;
              btn.innerHTML = originalText;
              Swal.fire('Sukses', `Berhasil mengimport ${questionsToSave.length} soal!`, 'success');
              fileInput.value = '';
              document.getElementById('form-import-excel').classList.add('hidden');
              loadQuestionsTable(examId);
            }).catch(err => {
              btn.disabled = false;
              btn.innerHTML = originalText;
              Swal.fire('Gagal', err.message, 'error');
            });

        } catch (err) {
            btn.disabled = false;
            btn.innerHTML = originalText;
            Swal.fire('Error', 'Gagal memproses file: ' + err.message, 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}

// --- FUNGSI ADMIN: RESET UJIAN (UJIAN ULANG) ---
// --- FITUR UJIAN ULANG / RESET ---
function resetExamAttempt(responseId, studentName) {
    // 1. Konfirmasi User
    Swal.fire({
        title: 'Reset Ujian?',
        text: `Apakah Anda yakin ingin menghapus data ujian siswa: ${studentName}? Siswa dapat melakukan ujian kembali setelah ini.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Ya, Reset Data'
    }).then((result) => {
        if (result.isConfirmed) {
            // 2. Tampilkan Loading
            Swal.fire({
                title: 'Memproses...',
                text: 'Menghapus data ujian...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // 3. Hapus data respon via Firebase (dengan fallback)
            const findRespToDelete = () => {
              return database.ref('Responses').orderByChild('ResponseID').equalTo(responseId).once('value').then(snap => {
                let rKey = null;
                snap.forEach(c => { rKey = c.key; });
                if (rKey) return rKey;
                return database.ref('Responses').once('value').then(allSnap => {
                  allSnap.forEach(c => { const v = c.val(); if (v.ResponseID === responseId || c.key === responseId) { rKey = c.key; } });
                  return rKey;
                });
              });
            };
            findRespToDelete().then(rKey => {
              if (rKey) {
                return database.ref('Responses/' + rKey).remove();
              } else {
                throw new Error('Data response tidak ditemukan.');
              }
            }).then(() => {
              Swal.fire({ icon: 'success', title: 'Berhasil', text: 'Data ujian siswa berhasil dihapus.', timer: 1500, showConfirmButton: false });
              const examId = document.getElementById('select-result-exam').value;
              if (examId) loadResultsTable(examId);
            }).catch(err => {
              Swal.fire('Error', err.message, 'error');
            });
        }
    });
}

// =========================================================================
// RENDER HALAMAN MANAGEMENT USER
// =========================================================================

function renderUserManagement(container) {
    container.innerHTML = `
    <div class="fade-in w-full space-y-4">
       
       <div class="dash-card p-6">
           <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
               <div>
                   <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                       <i class="fas fa-users-cog text-blue-600"></i> Data Pengguna
                   </h2>
                   <p class="text-sm text-slate-500 mt-1">Kelola akun Siswa, Guru, dan Admin.</p>
               </div>
               
               <div class="flex gap-2 w-full md:w-auto">
                   <button onclick="openImportUserModal()" class="flex-1 md:flex-none bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 rounded-xl text-sm font-bold shadow-lg transition flex items-center justify-center gap-2 transform active:scale-95">
                      <i class="fas fa-file-excel"></i> <span class="hidden sm:inline">Import Excel</span>
                   </button>

                   <button onclick="openUserModal()" class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-xl text-sm font-bold shadow-lg transition flex items-center justify-center gap-2 transform active:scale-95">
                      <i class="fas fa-user-plus"></i> <span class="hidden sm:inline">Tambah User</span>
                   </button>

                   <button onclick="handleClearDatabase()" class="flex-1 md:flex-none bg-red-600 hover:bg-red-700 text-white px-4 py-2.5 rounded-xl text-sm font-bold shadow-lg transition flex items-center justify-center gap-2 transform active:scale-95">
                      <i class="fas fa-database"></i> <span class="hidden sm:inline">Hapus Data DB</span>
                   </button>
               </div>
           </div>

            <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50 p-4 rounded-xl border border-slate-200">
                
                <div class="flex items-center gap-2 text-sm text-slate-600">
                    <span>Show</span>
                    <select onchange="changeUserRowsPerPage(this.value)" class="border border-slate-300 rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-blue-500 outline-none font-bold text-slate-700 bg-white cursor-pointer">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="all">Semua</option>
                    </select>
                    <span>entries</span>
                </div>

                <div class="flex items-center gap-2 flex-wrap">
                    <select id="user-role-filter" onchange="onRoleFilterChange()" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-bold text-slate-700 bg-white cursor-pointer">
                        <option value="">Semua Role</option>
                        <option value="Admin">Admin</option>
                        <option value="Guru">Guru</option>
                        <option value="Siswa">Siswa</option>
                    </select>
                    <select id="user-class-filter" onchange="applyUserFilters()" class="hidden border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-teal-500 outline-none font-bold text-slate-700 bg-white cursor-pointer">
                        <option value="">Semua Kelas</option>
                    </select>
                </div>

                <div class="relative w-full md:w-64 group">
                   <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                      <i class="fas fa-search"></i>
                   </div>
                   <input type="text" id="user-search-input" placeholder="Cari Nama, ID, atau Kelas..." oninput="applyUserFilters()" 
                          class="pl-10 pr-4 py-2 w-full border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none transition shadow-sm bg-white">
                </div>
            </div>
        </div>

        <div id="user-table-wrapper" class="dash-card border border-slate-200 overflow-hidden min-h-[300px]">
            <div class="flex flex-col items-center justify-center h-full py-10 text-slate-400">
                <i class="fas fa-circle-notch fa-spin text-3xl mb-2 text-blue-500"></i> Memuat data user...
            </div>
        </div>

        <!-- BULK ACTION BAR -->
        <div id="user-bulk-bar" class="hidden dash-card p-3 flex flex-col sm:flex-row justify-between items-center gap-3 bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-xl shadow-lg">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
                  <i class="fas fa-check-double text-red-500"></i>
                </div>
                <div>
                  <span class="font-bold text-red-700" id="user-selected-count">0</span>
                  <span class="text-sm text-red-600">user dipilih</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleSelectAllUsers()" class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg text-sm font-bold hover:bg-slate-50 transition">
                  <i class="fas fa-check-square mr-1"></i> Pilih Semua
                </button>
                <button onclick="printAllCards()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 transition shadow-md">
                  <i class="fas fa-print mr-1"></i> Cetak Kartu
                </button>
                <button onclick="handleBulkDeleteUsers()" class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-bold hover:bg-red-700 transition shadow-md">
                  <i class="fas fa-trash-alt mr-1"></i> Hapus Terpilih
                </button>
                <button onclick="clearUserSelection()" class="px-4 py-2 bg-slate-200 text-slate-600 rounded-lg text-sm font-bold hover:bg-slate-300 transition">
                  <i class="fas fa-times mr-1"></i> Batal
                </button>
            </div>
        </div>

        <div id="user-pagination-controls" class="dash-card p-4 flex flex-col md:flex-row justify-between items-center gap-4 text-sm hidden">
             <div class="text-slate-500 font-medium" id="user-pagination-info">Menampilkan 0 - 0 dari 0 data</div>
             <div class="flex gap-2">
                 <button onclick="changeUserPage('prev')" id="btn-user-prev" class="px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition font-bold text-slate-600">Sebelumnya</button>
                 <button onclick="changeUserPage('next')" id="btn-user-next" class="px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition font-bold text-slate-600">Selanjutnya</button>
             </div>
        </div>
    </div>`;

    // 5. INISIALISASI DATA & MODAL
    
    // Load Data dari Server
    loadUserTable();
    
    // Inject Modal Tambah/Edit User jika belum ada
    if (!document.getElementById('modal-user')) {
        createUserModalHTML();
    }

    // Inject Modal Import Excel jika belum ada
    if (!document.getElementById('modal-import-user')) {
         if(typeof createImportUserModalHTML === 'function') {
             createImportUserModalHTML();
         }
    }
}

// --- FUNGSI CETAK KARTU UJIAN (INDIVIDUAL & MISAL) ---
function convertDriveLink(url) {
    if (!url) return 'https://via.placeholder.com/150?text=No+Photo';
    let fileId = null;
    
    // 1. Mencari ID file dari format link biasa (contoh: /file/d/ID/view)
    const match1 = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
    
    // 2. Mencari ID file dari format link lain (contoh: /open?id=ID)
    const match2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    
    // 3. Menyimpan ID yang berhasil ditemukan
    if (match1 && match1[1]) fileId = match1[1];
    else if (match2 && match2[1]) fileId = match2[1];
    
    // 4. MENGUBAH URL MENGGUNAKAN ENDPOINT THUMBNAIL
    if (fileId) {
        return `https://drive.google.com/thumbnail?id=${fileId}&sz=w800`;
    }
    
    return url;
}

function updatePhotoPreview(url) {
    const previewContainer = document.getElementById('photo-preview-container');
    const previewImg = document.getElementById('photo-preview');
    
    if (!url || url.trim() === '') {
        if(previewContainer) previewContainer.classList.add('hidden');
        return;
    }

    const convertedUrl = convertDriveLink(url);
    if(previewImg) {
        previewImg.src = convertedUrl;
        previewImg.onerror = function() {
             this.src = 'https://via.placeholder.com/150?text=Error';
        };
    }
    if(previewContainer) previewContainer.classList.remove('hidden');
}

function getCardHTML(user, logoUrl) {
    // Pastikan data aman
    const name = user.username || '-';
    const id = user.id || '-';
    const pass = user.password || '******'; 
    const kls = user.class || '-';
    const photoUrl = convertDriveLink(user.photo || '');
    
    return `
    <div class="exam-card">
        <div class="card-header">
            <div class="logo-area">
                <img src="${logoUrl}" alt="Logo" onerror="this.style.display='none'">
            </div>
            <div class="header-text">
                <h2>MTs Bustanul Ulum</h2>
                <h3>KARTU PESERTA UJIAN</h3>
            </div>
        </div>
        <div class="card-body">
            <div style="flex: 1;">
                <table>
                    <tr>
                        <td class="label">Nama</td>
                        <td class="sep">:</td>
                        <td class="value"><b>${name}</b></td>
                    </tr>
                    <tr>
                        <td class="label">Username</td>
                        <td class="sep">:</td>
                        <td class="value font-mono">${id}</td>
                    </tr>
                    <tr>
                        <td class="label">Password</td>
                        <td class="sep">:</td>
                        <td class="value font-mono">${pass}</td>
                    </tr>
                    <tr>
                        <td class="label">Kelas</td>
                        <td class="sep">:</td>
                        <td class="value">${kls}</td>
                    </tr>
                </table>
            </div>
            <div class="photo-area">
                <img src="${photoUrl}" alt="FOTO" onerror="this.src='https://via.placeholder.com/100x130?text=FOTO'">
            </div>
        </div>
        <div class="card-footer">
            <p>*Bawa kartu ini saat ujian berlangsung.</p>
            <p style="font-size: 8px;">Dicetak: ${new Date().toLocaleDateString('id-ID')}</p>
        </div>
    </div>
    `;
}

function printCards(usersToPrint) {
    if(!usersToPrint || usersToPrint.length === 0) {
        Swal.fire('Info', 'Tidak ada data user untuk dicetak.', 'info');
        return;
    }

    const logoImg = document.getElementById('login-logo-img');
    const logoUrl = logoImg ? logoImg.src : 'https://via.placeholder.com/150?text=Logo';

    const printWindow = window.open('', '_blank');
    
    let cardsHTML = '';
    usersToPrint.forEach(u => {
        cardsHTML += getCardHTML(u, logoUrl);
    });

    const docContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Cetak Kartu Ujian</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
            @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

            body {
                background: #eee;
                font-family: 'Roboto', sans-serif;
                padding: 20px;
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
                justify-content: center;
            }

            .exam-card {
                width: 380px;
                height: 220px;
                background: white;
                border: 2px solid #000;
                border-radius: 12px; /* Rounded corners */
                box-sizing: border-box;
                position: relative;
                page-break-inside: avoid;
                margin-bottom: 0;
                overflow: hidden; /* Ensure content inside rounded corners */
            }

            .card-header {
                height: 60px;
                border-bottom: 2px solid #000;
                display: flex;
                align-items: center;
                padding: 0 10px;
                background: #fff;
            }

            .logo-area {
                width: 45px;
                height: 45px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-right: 10px;
            }

            .logo-area img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
            }

            .header-text {
                flex: 1;
                text-align: center;
            }

            .header-text h2 {
                margin: 0;
                font-size: 16px; /* Slightly smaller to fit school name */
                font-weight: 800;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .header-text h3 {
                margin: 2px 0 0 0;
                font-size: 12px;
                font-weight: 600;
                color: #333;
            }

            .card-body {
                padding: 12px;
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            td {
                padding: 2px 0;
                font-size: 11px;
                vertical-align: top;
            }

            .label {
                width: 70px;
                color: #555;
                font-weight: 500;
            }

            .sep {
                width: 10px;
                text-align: center;
            }

            .value {
                color: #000;
            }
            
            .font-mono {
                font-family: 'Courier Prime', monospace;
                font-weight: 700;
                font-size: 13px;
                letter-spacing: 0.5px;
            }

            .photo-area {
                width: 80px;
                height: 100px;
                border: 1px solid #ccc;
                background: #f9f9f9;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-left: 10px;
                padding: 2px;
                border-radius: 4px;
            }
            
            .photo-area img {
                 width: 100%;
                 height: 100%;
                 object-fit: cover;
                 border-radius: 2px;
            }

            .card-footer {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 6px 15px;
                background: #f1f5f9;
                border-top: 1px solid #ddd;
                text-align: center;
            }

            .card-footer p {
                margin: 0;
                font-size: 9px;
                color: #64748b;
                font-style: italic;
            }

            @media print {
                body {
                    background: white;
                    padding: 0;
                    display: block; 
                }
                .exam-card {
                    float: left;
                    margin: 10px;
                    border: 1px solid #000;
                    -webkit-print-color-adjust: exact;
                }
                .card-header, .card-footer {
                    background-color: #f1f5f9 !important;
                    -webkit-print-color-adjust: exact;
                }
            }
        </style>
    </head>
    <body onload="window.print();">
        ${cardsHTML}
    </body>
    </html>
    `;

    printWindow.document.write(docContent);
    printWindow.document.close();
}

function printStudentCard(userId) {
    const user = allUsersData.find(u => u.id === userId);
    if(user) {
        printCards([user]);
    } else {
        Swal.fire('Error', 'Data user tidak ditemukan.', 'error');
    }
}

function printAllCards() {
    const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
    
    if (selectedCheckboxes.length > 0) {
        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.userId);
        const usersToPrint = allUsersData.filter(u => selectedIds.includes(u.id));
        printCards(usersToPrint);
    } else {
        Swal.fire({
            title: 'Cetak Semua?',
            text: `Tidak ada user dipilih. Cetak seluruh ${filteredUsers.length} user yang ditampilkan saat ini?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Ya, Cetak Semua',
            cancelButtonText: 'Batal'
        }).then(res => {
            if(res.isConfirmed) {
                printCards(filteredUsers);
            }
        });
    }
}

// =========================================================================
// LOAD DATA USER (UPDATED SECURITY)
// =========================================================================

function loadUserTable() {
    const wrapper = document.getElementById('user-table-wrapper');
    
    if (!currentUser || !currentUser.userID || !currentUser.token) {
        Swal.fire('Error', 'Sesi Anda tidak valid. Silakan login ulang.', 'error')
        .then(() => location.reload()); 
        return;
    }

    wrapper.innerHTML = `
        <div class="flex flex-col items-center justify-center h-64 text-slate-400">
           <i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-blue-500"></i> 
           <p>Memverifikasi akses & mengambil data...</p>
        </div>`;

    database.ref('Users').once('value').then(snapshot => {
      const users = [];
      snapshot.forEach(child => {
        const raw = child.val();
        const u = {
          _key: child.key,
          id: raw.UserID || raw.userId || raw.id || '',
          username: raw.Username || raw.username || '',
          password: raw.Password || raw.password || '',
          role: raw.Role || raw.role || 'Siswa',
          class: raw.Class || raw.class || '-',
          photo: raw.Photo || raw.photo || '', // Add Photo property
          isActive: raw.Status ? (raw.Status === 'Aktif' ? 'TRUE' : 'FALSE') : (raw.isActive || 'TRUE')
        };
        users.push(u);
      });
      allUsersData = users;
      filteredUsers = users;
      currentUserPage = 1;
      const searchInput = document.getElementById('user-search-input');
      if(searchInput) searchInput.value = '';
      renderUserTableInternal();
    }).catch(error => {
      console.error('Gagal memuat user:', error);
      wrapper.innerHTML = `
        <div class="flex flex-col items-center justify-center h-64 text-red-500 p-4 text-center">
           <i class="fas fa-shield-alt text-4xl mb-3"></i>
           <h3 class="font-bold text-lg">Akses Ditolak</h3>
           <p class="text-sm text-slate-500 mt-1">${error.message}</p>
           <button onclick="loadUserTable()" class="mt-4 px-4 py-2 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 text-sm font-bold">Coba Lagi</button>
        </div>`;
      Swal.fire({ icon: 'error', title: 'Keamanan', text: 'Gagal memuat data: ' + error.message });
    });
}

// --- HELPER FILTER & PAGINATION USER ---

    function handleUserSearch(keyword) {
        applyUserFilters();
    }

    function onRoleFilterChange() {
        const role = document.getElementById('user-role-filter').value;
        const classFilter = document.getElementById('user-class-filter');
        
        if (role === 'Siswa') {
            // Populate kelas dari data yang ada
            const classes = [...new Set(allUsersData.filter(u => u.role === 'Siswa' && u.class && u.class !== '-').map(u => u.class))].sort();
            classFilter.innerHTML = '<option value="">Semua Kelas</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
            classFilter.classList.remove('hidden');
        } else {
            classFilter.classList.add('hidden');
            classFilter.value = '';
        }
        applyUserFilters();
    }

    function applyUserFilters() {
        const searchTerm = (document.getElementById('user-search-input')?.value || '').toLowerCase().trim();
        const roleFilter = document.getElementById('user-role-filter')?.value || '';
        const classFilter = document.getElementById('user-class-filter')?.value || '';

        filteredUsers = allUsersData.filter(u => {
            // 1. Filter Role
            if (roleFilter && u.role !== roleFilter) return false;
            // 2. Filter Kelas (hanya jika role = Siswa)
            if (classFilter && String(u.class) !== classFilter) return false;
            // 3. Filter Search
            if (searchTerm) {
                const match = u.username.toLowerCase().includes(searchTerm) ||
                              String(u.id).toLowerCase().includes(searchTerm) ||
                              String(u.class).toLowerCase().includes(searchTerm) ||
                              u.role.toLowerCase().includes(searchTerm);
                if (!match) return false;
            }
            return true;
        });

        currentUserPage = 1;
        renderUserTableInternal();
    }

    function changeUserRowsPerPage(val) {
        if (val === 'all') {
            userRowsPerPage = filteredUsers.length > 0 ? filteredUsers.length : 10;
        } else {
            userRowsPerPage = parseInt(val);
        }
        currentUserPage = 1; 
        renderUserTableInternal();
    }

    function changeUserPage(direction) {
        const maxPage = Math.ceil(filteredUsers.length / userRowsPerPage);
        
        if (direction === 'prev') {
            if (currentUserPage > 1) currentUserPage--;
        } else if (direction === 'next') {
            if (currentUserPage < maxPage) currentUserPage++;
        }
        renderUserTableInternal();
    }
    
    function renderUserTableInternal() {
        const wrapper = document.getElementById('user-table-wrapper');
        const paginationControls = document.getElementById('user-pagination-controls');
        const infoDisplay = document.getElementById('user-pagination-info');
        const btnPrev = document.getElementById('btn-user-prev');
        const btnNext = document.getElementById('btn-user-next');

        // A. Cek Jika Data Kosong
        if (filteredUsers.length === 0) {
            wrapper.innerHTML = `
                <div class="flex flex-col items-center justify-center py-16 text-slate-400">
                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-user-slash text-2xl text-slate-300"></i>
                    </div>
                    <p>Tidak ada data user ditemukan.</p>
                </div>`;
            paginationControls.classList.add('hidden');
            return;
        }

        paginationControls.classList.remove('hidden');

        // B. Hitung Pagination
        const totalData = filteredUsers.length;
        const maxPage = Math.ceil(totalData / userRowsPerPage);
        
        if (currentUserPage > maxPage) currentUserPage = maxPage;
        if (currentUserPage < 1) currentUserPage = 1;

        const startIndex = (currentUserPage - 1) * userRowsPerPage;
        const endIndex = Math.min(startIndex + userRowsPerPage, totalData);
        
        const pageData = filteredUsers.slice(startIndex, endIndex);

         // C. Generate HTML Baris
        let rowsHtml = pageData.map((u, i) => {
            const realIndex = startIndex + i + 1;
            const isActive = String(u.isActive).toUpperCase().trim() === 'TRUE';
            
            const statusBadge = isActive 
                ? `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-emerald-50 text-emerald-700 border border-emerald-100 uppercase tracking-wide"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>Aktif</span>`
                : `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-red-50 text-red-700 border border-red-100 uppercase tracking-wide"><i class="fas fa-ban text-[9px]"></i> Non-Aktif</span>`;
            
            const roleColor = u.role === 'Admin' ? 'text-purple-600 bg-purple-50 border-purple-100' : (u.role === 'Guru' ? 'text-orange-600 bg-orange-50 border-orange-100' : 'text-blue-600 bg-blue-50 border-blue-100');

            return `
            <tr class="user-row hover:bg-slate-50 transition border-b border-slate-50 last:border-0 group">
                <td class="p-4 text-center w-12">
                    <input type="checkbox" class="user-checkbox w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer" data-user-key="${u._key}" data-user-id="${u.id}" onchange="updateBulkBar()">
                </td>
                <td class="p-4 text-center text-slate-400 text-xs font-bold w-16">${realIndex}</td>
                <td class="p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-slate-500 font-bold text-xs border border-slate-200 shadow-sm uppercase">
                            ${u.username.charAt(0)}
                        </div>
                        <div>
                            <div class="font-bold text-slate-700 text-sm group-hover:text-blue-600 transition">${u.username}</div>
                            <div class="text-[10px] font-mono text-slate-400 bg-slate-100 px-1.5 rounded inline-block mt-0.5">${u.id}</div>
                        </div>
                    </div>
                </td>
                <td class="p-4">
                    <div class="flex flex-col items-start gap-1">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold border uppercase tracking-wider ${roleColor}">${u.role}</span>
                        ${u.role === 'Siswa' ? `<span class="text-xs text-slate-500 font-medium ml-1"><i class="fas fa-layer-group text-slate-300 mr-1"></i>${u.class}</span>` : ''}
                    </div>
                </td>
                <td class="p-4">
                    <div class="group/pass relative w-fit cursor-help">
                        <span class="text-slate-300 text-xs font-mono tracking-widest">••••••</span>
                        <span class="absolute left-0 -top-6 bg-slate-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover/pass:opacity-100 transition pointer-events-none font-mono z-20 shadow-xl whitespace-nowrap">
                            ${u.password}
                            <div class="absolute -bottom-1 left-2 w-2 h-2 bg-slate-800 rotate-45"></div>
                        </span>
                    </div>
                </td>
                <td class="p-4 text-center cursor-pointer hover:opacity-80 transition" onclick="handleToggleUser('${u.id}', '${u.isActive === 'TRUE' ? 'FALSE' : 'TRUE'}')" title="Klik untuk Ubah Status">
                    ${statusBadge}
                </td>
                <td class="p-4 pr-6 text-right">
                    <div class="flex justify-end gap-2 opacity-60 group-hover:opacity-100 transition">
                        <button onclick='printStudentCard("${u.id}")' class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-500 hover:text-white hover:bg-indigo-500 border border-transparent hover:shadow-lg transition transform hover:scale-105" title="Cetak Kartu">
                            <i class="fas fa-print"></i>
                        </button>
                        <button onclick='openUserModal(${JSON.stringify(u)})' class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-500 hover:text-white hover:bg-blue-500 border border-transparent hover:shadow-lg transition transform hover:scale-105" title="Edit">
                            <i class="fas fa-pen-to-square"></i>
                        </button>
                        <button onclick="handleDeleteUser('${u.id}')" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-500 hover:text-white hover:bg-red-500 border border-transparent hover:shadow-lg transition transform hover:scale-105" title="Hapus">
                            <i class="fas fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
        }).join('');

        // D. Update HTML Tabel
        wrapper.innerHTML = `
        <div class="overflow-x-auto w-full">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-50/80 border-b border-slate-200 text-slate-500 text-[11px] font-bold uppercase tracking-widest backdrop-blur-sm"> 
                        <th class="w-12 text-center pl-4 py-4"><input type="checkbox" id="user-select-all" class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer" onchange="toggleSelectAllUsers()"></th>
                        <th class="w-16 text-center py-4">No</th> 
                        <th class="py-4 px-4">Identitas</th>
                        <th class="py-4 px-4">Role & Kelas</th>
                        <th class="py-4 px-4">Password</th>
                        <th class="text-center py-4 px-4">Status</th>
                        <th class="text-right pr-6 py-4 px-4">Aksi</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 bg-white">${rowsHtml}</tbody>
            </table>
        </div>`;

        // E. Update Info Pagination
        infoDisplay.innerText = `Menampilkan ${startIndex + 1} - ${endIndex} dari ${totalData} data`;
        
        btnPrev.disabled = (currentUserPage === 1);
        btnNext.disabled = (currentUserPage === maxPage || maxPage === 0);
        
        // Styling button disabled
        [btnPrev, btnNext].forEach(btn => {
            if(btn.disabled) btn.classList.add('opacity-50', 'cursor-not-allowed');
            else btn.classList.remove('opacity-50', 'cursor-not-allowed');
        });
    }

    // --- BULK DELETE & DATABASE CLEAR FUNCTIONS ---

    function updateBulkBar() {
        const checked = document.querySelectorAll('.user-checkbox:checked');
        const bar = document.getElementById('user-bulk-bar');
        const countEl = document.getElementById('user-selected-count');
        if (checked.length > 0) {
            bar.classList.remove('hidden');
            countEl.innerText = checked.length;
        } else {
            bar.classList.add('hidden');
        }
        // Update select-all checkbox state
        const allCheckboxes = document.querySelectorAll('.user-checkbox');
        const selectAll = document.getElementById('user-select-all');
        if (selectAll) selectAll.checked = allCheckboxes.length > 0 && checked.length === allCheckboxes.length;
    }

    function toggleSelectAllUsers() {
        const selectAll = document.getElementById('user-select-all');
        const allCheckboxes = document.querySelectorAll('.user-checkbox');
        const isChecked = selectAll ? selectAll.checked : true;
        allCheckboxes.forEach(cb => cb.checked = isChecked);
        updateBulkBar();
    }

    function clearUserSelection() {
        const allCheckboxes = document.querySelectorAll('.user-checkbox');
        allCheckboxes.forEach(cb => cb.checked = false);
        const selectAll = document.getElementById('user-select-all');
        if (selectAll) selectAll.checked = false;
        updateBulkBar();
    }

    function handleBulkDeleteUsers() {
        const checked = document.querySelectorAll('.user-checkbox:checked');
        if (checked.length === 0) return;

        const keys = [];
        checked.forEach(cb => keys.push(cb.getAttribute('data-user-key')));

        Swal.fire({
            title: `Hapus ${keys.length} User?`,
            html: `<p class="text-sm text-slate-600">Anda akan menghapus <b class="text-red-600">${keys.length}</b> user sekaligus.</p><p class="text-xs text-red-500 mt-2"><i class="fas fa-exclamation-triangle mr-1"></i>Tindakan ini tidak bisa dibatalkan!</p>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc2626',
            cancelButtonColor: '#64748b',
            confirmButtonText: '<i class="fas fa-trash-alt mr-1"></i> Ya, Hapus Semua',
            cancelButtonText: 'Batal'
        }).then(result => {
            if (result.isConfirmed) {
                document.getElementById('global-loading').classList.remove('hidden');
                const updates = {};
                keys.forEach(key => { updates['Users/' + key] = null; });
                database.ref().update(updates).then(() => {
                    document.getElementById('global-loading').classList.add('hidden');
                    Swal.fire({ icon: 'success', title: 'Berhasil', text: `${keys.length} user berhasil dihapus.`, timer: 2000, showConfirmButton: false });
                    loadUserTable();
                }).catch(err => {
                    document.getElementById('global-loading').classList.add('hidden');
                    Swal.fire('Gagal', err.message, 'error');
                });
            }
        });
    }

    function handleClearDatabase() {
        Swal.fire({
            title: '<i class="fas fa-radiation text-red-500"></i> HAPUS DATA DATABASE',
            html: `
              <div class="text-sm text-slate-600 space-y-3">
                <p>Pilih data yang ingin dihapus dari Firebase:</p>
                <div class="text-left space-y-2 bg-red-50 p-3 rounded-lg border border-red-200">
                  <label class="flex items-center gap-2 cursor-pointer hover:bg-red-100 p-1 rounded"><input type="checkbox" value="Users" class="db-clear-cb w-4 h-4"> <i class="fas fa-users text-blue-500 w-5"></i> <b>Users</b> (Siswa & Guru — <span class="text-green-600">akun Admin Anda tetap aman</span>)</label>
                  <label class="flex items-center gap-2 cursor-pointer hover:bg-red-100 p-1 rounded"><input type="checkbox" value="Exams" class="db-clear-cb w-4 h-4"> <i class="fas fa-file-alt text-green-500 w-5"></i> <b>Exams</b> (Semua ujian)</label>
                  <label class="flex items-center gap-2 cursor-pointer hover:bg-red-100 p-1 rounded"><input type="checkbox" value="Questions" class="db-clear-cb w-4 h-4"> <i class="fas fa-question-circle text-yellow-500 w-5"></i> <b>Questions</b> (Semua soal)</label>
                  <label class="flex items-center gap-2 cursor-pointer hover:bg-red-100 p-1 rounded"><input type="checkbox" value="Responses" class="db-clear-cb w-4 h-4"> <i class="fas fa-clipboard-check text-purple-500 w-5"></i> <b>Responses</b> (Semua jawaban & nilai)</label>
                  <label class="flex items-center gap-2 cursor-pointer hover:bg-red-100 p-1 rounded"><input type="checkbox" value="Logs" class="db-clear-cb w-4 h-4"> <i class="fas fa-history text-orange-500 w-5"></i> <b>Logs</b> (Log pelanggaran)</label>
                  <label class="flex items-center gap-2 cursor-pointer hover:bg-red-100 p-1 rounded"><input type="checkbox" value="Gambar" class="db-clear-cb w-4 h-4"> <i class="fas fa-image text-pink-500 w-5"></i> <b>Gambar</b> (Data galeri)</label>
                  <label class="flex items-center gap-2 cursor-pointer hover:bg-red-100 p-1 rounded"><input type="checkbox" value="Master_Data" class="db-clear-cb w-4 h-4"> <i class="fas fa-cogs text-slate-500 w-5"></i> <b>Master Data</b> (Kelas & Mapel)</label>
                </div>
                <p class="text-xs text-red-600 font-bold"><i class="fas fa-exclamation-triangle mr-1"></i> Data yang dihapus TIDAK BISA dikembalikan!</p>
              </div>`,
            showCancelButton: true,
            confirmButtonColor: '#dc2626',
            confirmButtonText: '<i class="fas fa-trash-alt mr-1"></i> Hapus Data Terpilih',
            cancelButtonText: 'Batal',
            preConfirm: () => {
                const selected = [];
                document.querySelectorAll('.db-clear-cb:checked').forEach(cb => selected.push(cb.value));
                if (selected.length === 0) { Swal.showValidationMessage('Pilih minimal 1 data untuk dihapus!'); return false; }
                return selected;
            }
        }).then(result => {
            if (result.isConfirmed && result.value) {
                const nodes = result.value;
                // Double confirmation
                Swal.fire({
                    title: 'KONFIRMASI AKHIR',
                    html: `<p class="text-sm">Anda akan menghapus: <b class="text-red-600">${nodes.join(', ')}</b></p>${nodes.includes('Users') ? '<p class="text-xs text-green-600 mt-1"><i class="fas fa-shield-alt mr-1"></i>Akun Admin Anda akan tetap dipertahankan.</p>' : ''}<p class="text-xs text-slate-500 mt-2">Ketik <b>HAPUS</b> untuk konfirmasi.</p>`,
                    input: 'text',
                    inputPlaceholder: 'Ketik HAPUS',
                    showCancelButton: true,
                    confirmButtonColor: '#dc2626',
                    confirmButtonText: 'Hapus Permanen',
                    preConfirm: (val) => {
                        if (val !== 'HAPUS') { Swal.showValidationMessage('Ketik HAPUS dengan benar!'); return false; }
                        return true;
                    }
                }).then(final => {
                    if (final.isConfirmed) {
                        document.getElementById('global-loading').classList.remove('hidden');

                        // Pisahkan: jika Users dipilih, hapus user non-Admin saja
                        const hasUsers = nodes.includes('Users');
                        const otherNodes = nodes.filter(n => n !== 'Users');

                        // Hapus node selain Users langsung
                        const updates = {};
                        otherNodes.forEach(node => { updates[node] = null; });

                        let deletePromise;
                        if (hasUsers) {
                            // Hapus user non-Admin: ambil dulu semua user, lalu hapus yang bukan Admin
                            deletePromise = database.ref('Users').once('value').then(snap => {
                                snap.forEach(child => {
                                    const u = child.val();
                                    const role = u.Role || u.role || '';
                                    // Pertahankan semua akun Admin
                                    if (role !== 'Admin') {
                                        updates['Users/' + child.key] = null;
                                    }
                                });
                                return database.ref().update(updates);
                            });
                        } else {
                            deletePromise = database.ref().update(updates);
                        }

                        deletePromise.then(() => {
                            document.getElementById('global-loading').classList.add('hidden');
                            const msg = hasUsers
                                ? `<b>${nodes.join(', ')}</b> berhasil dihapus.<br><span class="text-green-600 text-xs"><i class="fas fa-shield-alt mr-1"></i>Akun Admin tetap aman.</span>`
                                : `<b>${nodes.join(', ')}</b> berhasil dihapus dari database.`;
                            Swal.fire({ icon: 'success', title: 'Data Dihapus', html: msg });
                            if (hasUsers) loadUserTable();
                        }).catch(err => {
                            document.getElementById('global-loading').classList.add('hidden');
                            Swal.fire('Gagal', err.message, 'error');
                        });
                    }
                });
            }
        });
    }

    // --- MODAL & FORM LOGIC ---
function createUserModalHTML() {
    const modalHtml = `
    <div id="modal-user" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeUserModal()"></div>
        
        <div class="relative w-full max-w-lg bg-white rounded-2xl shadow-2xl flex flex-col animate-[fadeIn_0.3s_ease-out] z-[101]">
    
            <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <h3 class="font-bold text-lg text-slate-800" id="modal-user-title">Tambah User</h3>
                <button onclick="closeUserModal()" class="text-slate-400 hover:text-red-500 transition w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form onsubmit="handleUserSubmit(event)" class="p-6 space-y-4 max-h-[80vh] overflow-y-auto custom-scrollbar">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">User ID (NIS / NIP)</label>
                        <input type="text" name="userId" id="input-userId" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm font-mono font-bold text-slate-600" placeholder="12345678" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Role / Peran</label>
                        <select name="role" id="input-role" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm bg-slate-50 cursor-pointer" onchange="toggleUserClassInput(this.value)">
                            <option value="Siswa">Siswa</option>
                            <option value="Guru">Guru</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Lengkap</label>
                    <input type="text" name="username" id="input-username" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm" placeholder="Contoh: Budi Santoso" required>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                    <input type="text" name="password" id="input-password" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm" placeholder="Minimal 6 karakter" required>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">URL Foto (Opsional)</label>
                    <input type="text" name="photoUrl" id="input-photo" oninput="updatePhotoPreview(this.value)" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm" placeholder="Paste Link Google Drive...">
                    
                    <div id="photo-preview-container" class="hidden mt-2 p-2 bg-slate-100 rounded border border-slate-200 flex flex-col items-center">
                        <span class="text-xs text-slate-500 mb-1">Preview Foto:</span>
                        <img id="photo-preview" src="" alt="Preview" class="h-32 object-contain rounded border border-slate-300 bg-white" onerror="this.style.display='none'">
                    </div>

                    <p class="text-[10px] text-slate-400 mt-1">*Pastikan akses file di Google Drive adalah "Anyone with the link".</p>
                </div>

              <div id="field-class-student" class="hidden">
                  <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kelas Siswa</label>
                  <select id="input-student-class" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm bg-white cursor-pointer">
                      <option value="">-- Pilih Kelas --</option>
                      <option value="">Memuat data...</option>
                  </select>
                  <p class="text-[10px] text-slate-400 mt-1">*Data diambil dari Sheet Master_Data (Kolom A).</p>
              </div>

                <div id="field-class-teacher" class="hidden bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase">Tugas Mengajar</label>
                        <button type="button" onclick="addTeacherAssignmentRow()" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold hover:bg-blue-200 transition">
                            <i class="fas fa-plus"></i> Tambah Mapel
                        </button>
                    </div>
                    
                    <div id="teacher-assignments-container" class="space-y-2">
                        </div>
                    <p class="text-[10px] text-slate-400 mt-2">*Pilih Mata Pelajaran dan Kelas yang diajar.</p>
                </div>

                <input type="hidden" name="class" id="final-class-value">

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-lg transition active:scale-95 mt-2 flex justify-center items-center gap-2">
                    <i class="fas fa-save"></i> Simpan Data
                </button>
            </form>

        </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function toggleUserClassInput(role) {
    const divStudent = document.getElementById('field-class-student');
    const inputStudent = document.getElementById('input-student-class');
    const divTeacher = document.getElementById('field-class-teacher');
    
    // 1. Reset Tampilan (Sembunyikan Semua)
    divStudent.classList.add('hidden');
    divTeacher.classList.add('hidden');
    
    // Hapus required agar validasi HTML5 tidak error saat disembunyikan
    if(inputStudent) inputStudent.removeAttribute('required');

    // 2. Logika Berdasarkan Role
    if (role === 'Siswa') {
        // Tampilkan Input Siswa
        divStudent.classList.remove('hidden');
        if(inputStudent) inputStudent.setAttribute('required', 'true');
    } 
    else if (role === 'Guru') {
        // Tampilkan Container Guru
        divTeacher.classList.remove('hidden');
        
        // Panggil Data Master (Mapel & Kelas) untuk Dropdown
        loadMasterDataForUser();
        
        // Cek jika container baris mapel masih kosong, tambahkan 1 baris default
        const container = document.getElementById('teacher-assignments-container');
        if (container && container.children.length === 0) {
            addTeacherAssignmentRow();
        }
    }    
}

function openUserModal(data = null) {
    const modal = document.getElementById('modal-user');
    const title = document.getElementById('modal-user-title');
    const idInput = document.getElementById('input-userId');
    const teacherContainer = document.getElementById('teacher-assignments-container');
    const photoInput = document.getElementById('input-photo');

    // 1. Reset Form & Bersihkan Container
    document.querySelector('form[onsubmit="handleUserSubmit(event)"]').reset();
    if(teacherContainer) teacherContainer.innerHTML = ''; 
    idInput.value = '';
    document.getElementById('final-class-value').value = '';
    if(photoInput) {
        photoInput.value = '';
        if(typeof updatePhotoPreview === 'function') updatePhotoPreview('');
    }
    
    // 2. Set Default State (Siswa)
    document.getElementById('input-role').value = 'Siswa';
    toggleUserClassInput('Siswa'); // Ini akan menampilkan div siswa

    if (data) {
        // --- MODE EDIT ---
        title.innerText = 'Edit User';
        idInput.value = data.id;
        idInput.readOnly = true; 
        idInput.classList.add('bg-slate-100', 'cursor-not-allowed');
        
        document.getElementById('input-username').value = data.username;
        document.getElementById('input-password').value = data.password;
        document.getElementById('input-role').value = data.role;
        if(photoInput) {
            photoInput.value = data.photo || '';
            if(typeof updatePhotoPreview === 'function') updatePhotoPreview(photoInput.value);
        }

        // Ubah tampilan input berdasarkan Role user yang diedit
        toggleUserClassInput(data.role);

        // --- PENGISIAN DATA KELAS ---
        // Jika Siswa, load master data LALU set value-nya
        if (data.role === 'Siswa') {
            // Kita kirim data.class sebagai parameter agar dipilih setelah dropdown ter-render
            loadMasterDataForUser(data.class); 
        } 
        else if (data.role === 'Guru') {
            // Jika Guru, load master data biasa (tanpa select siswa)
            loadMasterDataForUser();

            // Parsing data tugas guru
            const rawAssignments = data.class;
            if (rawAssignments && rawAssignments !== '-' && rawAssignments.trim() !== '') {
                const items = rawAssignments.split(',');
                items.forEach(item => {
                    const parts = item.trim().split(':');
                    if(parts.length >= 2) {
                        addTeacherAssignmentRow(parts[0].trim(), parts[1].trim());
                    }
                });
            } else {
                addTeacherAssignmentRow();
            }
        } else {
            // Jika Admin, tetap pancing load data master untuk jaga-jaga
            loadMasterDataForUser();
        }

    } else {
        // --- MODE TAMBAH BARU ---
        title.innerText = 'Tambah User Baru';
        idInput.readOnly = false;
        idInput.classList.remove('bg-slate-100', 'cursor-not-allowed');
        
        // Load data master kosong (untuk persiapan dropdown)
        loadMasterDataForUser();
    }
    
    // Tampilkan Modal
    modal.classList.remove('hidden');
}

    function closeUserModal() {
        document.getElementById('modal-user').classList.add('hidden');
    }

function handleUserSubmit(e) {
    e.preventDefault();
    
    // --- 1. LOGIKA PERSIAPAN DATA (ROLE & KELAS) ---
    const role = document.getElementById('input-role').value;
    const finalClassInput = document.getElementById('final-class-value');
    
    if (role === 'Siswa') {
        // Jika Siswa, ambil dari dropdown kelas siswa
        finalClassInput.value = document.getElementById('input-student-class').value;
    } 
    else if (role === 'Guru') {
        // Jika Guru, ambil dari baris tugas mengajar
        const rows = document.querySelectorAll('.assignment-row');
        let assignments = [];
        
        rows.forEach(row => {
            const sub = row.querySelector('.assign-subject').value.trim();
            const cls = row.querySelector('.assign-class').value.trim();
            
            if(sub && cls) {
                // Hapus karakter titik dua (:) agar format data bersih
                const cleanSub = sub.replace(/:/g, '');
                const cleanCls = cls.replace(/:/g, '');
                assignments.push(`${cleanSub}:${cleanCls}`);
            }
        });
        
        // Validasi: Guru wajib punya minimal 1 tugas
        if(assignments.length === 0) {
            Swal.fire('Data Tidak Lengkap', 'Guru wajib memiliki minimal satu tugas mengajar.', 'warning');
            return;
        }
        
        finalClassInput.value = assignments.join(', ');
    } 
    else {
        // Jika Admin, kelas diisi strip
        finalClassInput.value = '-'; 
    }

    // --- 2. AMBIL DATA FORM ---
    const fd = new FormData(e.target);
    const data = Object.fromEntries(fd.entries());
    
    // Tutup modal & Tampilkan Loading
    closeUserModal();
    document.getElementById('global-loading').classList.remove('hidden');

    // --- 3. LOGIKA PENGIRIMAN KE SERVER (SECURE) ---
    
    // Cek apakah input ID terkunci (ReadOnly). 
    // Jika YA = Mode Edit. Jika TIDAK = Mode Tambah Baru.
    const isEditMode = document.getElementById('input-userId').readOnly;

    if (isEditMode) {
        // --- PROSES UPDATE / EDIT via Firebase ---
        const userId = data.userId || data.UserID;
        const updateData = {
          UserID: userId,
          Username: data.username || data.Username || '',
          Password: data.password || data.Password || '',
          Role: data.role || data.Role || 'Siswa',
          Class: data.class || data.Class || '-',
          Photo: data.photoUrl || ''
        };
        database.ref('Users').orderByChild('UserID').equalTo(userId).once('value').then(snap => {
          let uKey = null;
          snap.forEach(c => { uKey = c.key; });
          if (!uKey) throw new Error('User tidak ditemukan.');
          return database.ref('Users/' + uKey).update(updateData);
        }).then(() => {
          document.getElementById('global-loading').classList.add('hidden');
          Swal.fire('Berhasil', 'Data user diperbarui.', 'success');
          loadUserTable();
        }).catch(err => {
          document.getElementById('global-loading').classList.add('hidden');
          Swal.fire('Gagal', err.message, 'error');
        });

    } else {
        // --- PROSES CREATE / BARU via Firebase ---
        const newUser = {
          UserID: data.userId || data.UserID || '',
          Username: data.username || data.Username || '',
          Password: data.password || data.Password || '',
          Role: data.role || data.Role || 'Siswa',
          Role: data.role || data.Role || 'Siswa',
          Class: data.class || data.Class || '-',
          Photo: data.photoUrl || '',
          Status: 'Aktif'
        };
        database.ref('Users').push(newUser).then(() => {
          document.getElementById('global-loading').classList.add('hidden');
          Swal.fire('Berhasil', 'User baru ditambahkan.', 'success');
          loadUserTable();
        }).catch(err => {
          document.getElementById('global-loading').classList.add('hidden');
          Swal.fire('Gagal', err.message, 'error');
        });
    }
}
// KODE BARU (AMAN - SUDAH MENGIRIM KREDENSIAL ADMIN)
function handleDeleteUser(uid) {
    Swal.fire({
        title: 'Hapus User?', 
        text: "Data tidak bisa dikembalikan!", 
        icon: 'warning',
        showCancelButton: true, 
        confirmButtonColor: '#d33', 
        confirmButtonText: 'Ya, Hapus'
    }).then(res => {
        if (res.isConfirmed) {
            document.getElementById('global-loading').classList.remove('hidden');
            
            database.ref('Users').orderByChild('UserID').equalTo(uid).once('value').then(snap => {
              let uKey = null;
              snap.forEach(c => { uKey = c.key; });
              if (!uKey) throw new Error('User tidak ditemukan.');
              return database.ref('Users/' + uKey).remove();
            }).then(() => {
              document.getElementById('global-loading').classList.add('hidden');
              Swal.fire('Terhapus', '', 'success');
              loadUserTable();
            }).catch(err => {
              document.getElementById('global-loading').classList.add('hidden');
              Swal.fire('Gagal', err.message, 'error');
            });
        }
    });
}

    function handleToggleUser(uid, status) {
        document.getElementById('global-loading').classList.remove('hidden');
        database.ref('Users').orderByChild('UserID').equalTo(uid).once('value').then(snap => {
          let uKey = null;
          snap.forEach(c => { uKey = c.key; });
          if (!uKey) throw new Error('User tidak ditemukan.');
          return database.ref('Users/' + uKey).update({ Status: status === 'TRUE' ? 'Aktif' : 'Non-Aktif' });
        }).then(() => {
          document.getElementById('global-loading').classList.add('hidden');
          loadUserTable();
        }).catch(() => {
          document.getElementById('global-loading').classList.add('hidden');
        });
    }


// ==========================================
    // LOGIKA IMPORT USER EXCEL
    // ==========================================

    function createImportUserModalHTML() {
        const html = `
        <div id="modal-import-user" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeImportUserModal()"></div>
            
            <div class="relative w-full max-w-lg bg-white rounded-2xl shadow-2xl flex flex-col animate-[fadeIn_0.3s_ease-out] z-[101]">
                
                <div class="px-6 py-4 border-b flex justify-between items-center bg-emerald-50 rounded-t-2xl">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center"><i class="fas fa-file-excel"></i></div>
                        <h3 class="font-bold text-lg text-emerald-900">Import User dari Excel</h3>
                    </div>
                    <button onclick="closeImportUserModal()" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
                </div>

                <div class="p-6 space-y-6">
                    
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm text-slate-600">
                        <p class="font-bold text-slate-800 mb-2"><i class="fas fa-info-circle text-blue-500"></i> Aturan Format Excel (Update Baru):</p>
                        <ul class="list-disc list-inside space-y-1 text-xs ml-1">
                            <li><b>Kolom A (ID User):</b> NIS/NIP/ID Unik (Wajib & Harus Unik).</li>
                            <li><b>Kolom B (Username):</b> Nama Lengkap.</li>
                            <li><b>Kolom C (Password):</b> Password Akun.</li>
                            <li><b>Kolom D (Role):</b> Siswa / Guru / Admin.</li>
                            <li><b>Kolom E (Kelas):</b> Kelas (Siswa) atau kosongkan.</li>
                            <li><b>Kolom F (Mapel):</b> Mapel (Guru) atau kosongkan.</li>
                        </ul>
                        <button onclick="downloadUserTemplate()" class="mt-3 text-emerald-600 font-bold hover:underline text-xs flex items-center gap-1">
                            <i class="fas fa-download"></i> Download Template Excel
                        </button>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Upload File (.xlsx)</label>
                        <input type="file" id="input-user-excel" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500
                          file:mr-4 file:py-2.5 file:px-4
                          file:rounded-xl file:border-0
                          file:text-xs file:font-bold
                          file:bg-emerald-50 file:text-emerald-700
                          hover:file:bg-emerald-100
                          cursor-pointer border border-slate-300 rounded-xl p-2 bg-white transition
                        "/>
                    </div>

                    <button onclick="processUserImport()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-bold shadow-lg transition active:scale-95 flex justify-center items-center gap-2">
                        <i class="fas fa-upload"></i> Proses Import
                    </button>
                </div>
            </div>
        </div>`;
        
        document.body.insertAdjacentHTML('beforeend', html);
    }

    function openImportUserModal() {
        if (!document.getElementById('modal-import-user')) {
            createImportUserModalHTML();
        }
        document.getElementById('input-user-excel').value = ''; // Reset file
        document.getElementById('modal-import-user').classList.remove('hidden');
    }

    function closeImportUserModal() {
        document.getElementById('modal-import-user').classList.add('hidden');
    }

    // --- FUNGSI DOWNLOAD TEMPLATE OTOMATIS (MENGGUNAKAN SHEETJS) ---
    function downloadUserTemplate() {
        // Data Dummy untuk Template dengan kolom Mapel dan Kelas terpisah
        const data = [
            ["ID User (Wajib)", "Username", "Password", "Role", "Kelas (Siswa)", "Mapel (Guru)"], // Header Baru
            ["1001", "Ahmad Siswa", "123456", "Siswa", "XII-RPL", "-"], // Contoh Siswa
            ["1002", "Budi Santoso", "123456", "Siswa", "XII-TKJ", "-"],
            ["GURU-01", "Pak Guru", "guru123", "Guru", "XII-IPA 1", "Matematika"], // Contoh Guru
            ["GURU-02", "Bu Guru", "guru456", "Guru", "XII-IPA 2", "Fisika"]
        ];
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // Atur lebar kolom agar rapi
        ws['!cols'] = [{wch:15}, {wch:25}, {wch:15}, {wch:10}, {wch:15}, {wch:15}];
        XLSX.utils.book_append_sheet(wb, ws, "TemplateUser");
        XLSX.writeFile(wb, "Template_Import_User_SIPADU_V3.xlsx"); // Versi 3
    }

    // --- FUNGSI PROSES IMPORT ---
    function processUserImport() {
        const fileInput = document.getElementById('input-user-excel');
        const file = fileInput.files[0];

        if (!file) {
            Swal.fire('Peringatan', 'Silakan pilih file Excel terlebih dahulu.', 'warning');
            return;
        }

        // Tampilkan Loading
        closeImportUserModal();
        document.getElementById('global-loading').classList.remove('hidden');

        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                // Ambil sheet pertama
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Ubah ke JSON (Array of Arrays)
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                // Format Data agar sesuai dengan Server (Skip Header Baris 0)
                const updates = {};
                let count = 0;
                
                // Mulai dari baris ke-1 (indeks 1) karena indeks 0 adalah Header
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row.length === 0) continue; // Skip baris kosong

                    // Mapping kolom Excel ke Object (SESUAI TEMPLATE BARU)
                    // A=0:ID, B=1:Username, C=2:Password, D=3:Role, E=4:Kelas, F=5:Mapel
                    
                    const userId = row[0] ? String(row[0]).trim() : '';
                    if (!userId) continue; // Skip jika ID kosong

                    const username = row[1] ? String(row[1]).trim() : '';
                    const password = row[2] ? String(row[2]).trim() : '123456';
                    const role = row[3] ? String(row[3]).trim() : 'Siswa';
                    const rawKelas = row[4] ? String(row[4]).trim() : '';
                    const rawMapel = row[5] ? String(row[5]).trim() : '';
                    const photo = row[6] ? String(row[6]).trim() : ''; // NEW: Foto Parsing

                    let finalClass = '-';
                    if (role.toLowerCase() === 'guru') {
                        // Jika Guru, format tugas mengajar: "Mapel:Kelas"
                        // Jika ada mapel dan kelas, gabung.
                        if (rawMapel && rawMapel !== '-' && rawKelas && rawKelas !== '-') {
                            finalClass = `${rawMapel}:${rawKelas}`;
                        } else {
                            finalClass = '-'; 
                        }
                    } else {
                        // Jika Siswa, ambil kolom Kelas saja
                        finalClass = rawKelas || '-';
                    }

                    // Gunakan UserID sebagai Key di Firebase (agar tidak duplikat generate ID random)
                    // Struktur: Users/USER_ID = { Data }
                    updates['Users/' + userId] = {
                        UserID: userId,
                        Username: username,
                        Password: password,
                        Role: role,
                        Class: finalClass,
                        Photo: photo, // SAVE PHOTO
                        Status: 'Aktif'
                    };
                    count++;
                }

                if (count === 0) {
                    document.getElementById('global-loading').classList.add('hidden');
                    Swal.fire('Data Kosong / Format Salah', 'Pastikan kolom A (ID User) terisi.', 'warning');
                    return;
                }

                // KIRIM KE SERVER (Batch Update)
                database.ref().update(updates).then(() => {
                  document.getElementById('global-loading').classList.add('hidden');
                  Swal.fire({ 
                      title: 'Selesai', 
                      html: `Berhasil import/update <b>${count}</b> user.<br><small class="text-slate-500">Duplikasi ID akan menimpa data lama.</small>`, 
                      icon: 'success' 
                  }).then(() => {
                    loadUserTable();
                  });
                }).catch(err => {
                  document.getElementById('global-loading').classList.add('hidden');
                  Swal.fire('Gagal menyimpan Import', err.message, 'error');
                });

            } catch (err) {
                document.getElementById('global-loading').classList.add('hidden');
                Swal.fire('Error File', 'Gagal memproses file Excel: ' + err.message, 'error');
            }
        };
        
        reader.readAsArrayBuffer(file);
    }
    
/* ==========================================
   HALAMAN FOLDER GAMBAR (BARU)
   ========================================== */

let allImagesData = [];
let filteredImages = [];
let currentImgPage = 1;
let imgRowsPerPage = 10;

function renderImageFolder(container) {
    container.innerHTML = `
    <div class="fade-in w-full space-y-4">
        
        <div class="dash-card p-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                <div>
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i class="fas fa-images text-pink-600"></i> Generator Link Gambar
                    </h2>
                    <p class="text-sm text-slate-500 mt-1">Ubah Folder Google Drive menjadi direct link siap pakai untuk ujian.</p>
                </div>
            </div>

            <div class="bg-pink-50 border border-pink-100 rounded-xl p-4 mb-6">
                <div class="flex gap-4 flex-col md:flex-row">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-pink-700 uppercase mb-2">URL Folder Google Drive</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-pink-400"><i class="fab fa-google-drive"></i></span>
                            <input type="text" id="input-folder-url" placeholder="Paste Link Folder di sini (Pastikan akses folder: Anyone with the link)..." 
                                class="pl-10 w-full border border-pink-200 p-3 rounded-lg focus:ring-2 focus:ring-pink-500 outline-none bg-white transition shadow-sm text-sm">
                        </div>
                    </div>
                    <div class="flex items-end">
                        <button onclick="handleGenerateImages()" class="w-full md:w-auto bg-pink-600 hover:bg-pink-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg transition flex items-center justify-center gap-2 transform active:scale-95">
                            <i class="fas fa-magic"></i> Hasilkan Link
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="dash-card border border-slate-200 overflow-hidden">
             
             <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-700">Riwayat Gambar Tersimpan</h3>
                <button onclick="loadImageTable()" class="text-xs font-bold text-blue-600 hover:underline"><i class="fas fa-sync"></i> Refresh</button>
             </div>

             <div class="p-4 bg-white border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                 
                 <div class="flex items-center gap-2 text-sm text-slate-600">
                      <span>Show</span>
                      <select onchange="changeImgRowsPerPage(this.value)" class="border border-slate-300 rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-pink-500 outline-none font-bold text-slate-700 bg-slate-50 cursor-pointer">
                          <option value="10">10</option>
                          <option value="25">25</option>
                          <option value="50">50</option>
                          <option value="100">100</option>
                          <option value="all">Semua</option>
                      </select>
                      <span>entries</span>
                 </div>

                 <div class="relative w-full md:w-64 group">
                     <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                        <i class="fas fa-search"></i>
                     </div>
                     <input type="text" placeholder="Cari Nama Gambar..." onkeyup="handleImageSearch(this.value)" 
                            class="pl-10 pr-4 py-2 w-full border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 outline-none transition shadow-sm bg-white">
                 </div>
             </div>
             
             <div id="img-table-container">
                 <div class="flex flex-col items-center justify-center py-12 text-slate-400">
                    <i class="fas fa-circle-notch fa-spin text-3xl mb-2 text-pink-500"></i> Memuat galeri...
                 </div>
             </div>

             <div id="img-pagination-controls" class="p-4 bg-slate-50 border-t border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4 text-sm hidden">
                <div class="text-slate-500 font-medium" id="img-pagination-info">Menampilkan 0 - 0 dari 0 data</div>
                <div class="flex gap-2">
                    <button onclick="changeImgPage('prev')" id="btn-img-prev" class="px-4 py-2 border border-slate-300 rounded-lg bg-white hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed transition font-bold text-slate-600">Sebelumnya</button>
                    <button onclick="changeImgPage('next')" id="btn-img-next" class="px-4 py-2 border border-slate-300 rounded-lg bg-white hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed transition font-bold text-slate-600">Selanjutnya</button>
                </div>
           </div>
        </div>
    </div>
    `;

    // Load data awal
    loadImageTable();
}

function handleGenerateImages() {
    const url = document.getElementById('input-folder-url').value.trim();
    if (!url) {
        Swal.fire('Peringatan', 'Masukkan Link Folder Google Drive dulu!', 'warning');
        return;
    }

    const btn = document.querySelector('button[onclick="handleGenerateImages()"]');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

    // Fitur processFolderImages tidak tersedia di client-side Firebase
    btn.disabled = false;
    btn.innerHTML = originalText;
    Swal.fire('Fitur Tidak Tersedia', 'Fitur scan folder Google Drive tidak tersedia dalam mode Firebase. Upload gambar secara manual.', 'warning');
}

function loadImageTable() {
    // Tampilkan loading saat refresh manual
    const container = document.getElementById('img-table-container');
    container.innerHTML = `<div class="flex flex-col items-center justify-center py-12 text-slate-400"><i class="fas fa-circle-notch fa-spin text-3xl mb-2 text-pink-500"></i> Memuat galeri...</div>`;
    document.getElementById('img-pagination-controls').classList.add('hidden');

    database.ref('Gambar').once('value').then(snapshot => {
        const data = [];
        snapshot.forEach(child => {
          const img = child.val();
          img._key = child.key;
          img.id = img.ImageID || child.key;
          data.push(img);
        });
        allImagesData = data;
        filteredImages = data;
        currentImgPage = 1;
        const searchInput = document.querySelector('input[placeholder="Cari Nama Gambar..."]');
        if(searchInput) searchInput.value = '';
        renderImageTableInternal();
    });
}

// --- LOGIKA FILTER & PAGINATION ---

function handleImageSearch(keyword) {
    const term = keyword.toLowerCase().trim();
    // Filter data global
    filteredImages = allImagesData.filter(img => {
        return img.name.toLowerCase().includes(term);
    });
    currentImgPage = 1; // Reset ke halaman 1
    renderImageTableInternal();
}

function changeImgRowsPerPage(val) {
    if (val === 'all') {
        imgRowsPerPage = filteredImages.length > 0 ? filteredImages.length : 10;
    } else {
        imgRowsPerPage = parseInt(val);
    }
    currentImgPage = 1; 
    renderImageTableInternal();
}

function changeImgPage(direction) {
    const maxPage = Math.ceil(filteredImages.length / imgRowsPerPage);
    if (direction === 'prev') {
        if (currentImgPage > 1) currentImgPage--;
    } else if (direction === 'next') {
        if (currentImgPage < maxPage) currentImgPage++;
    }
    renderImageTableInternal();
}

function renderImageTableInternal() {
    const container = document.getElementById('img-table-container');
    const paginationControls = document.getElementById('img-pagination-controls');
    const infoDisplay = document.getElementById('img-pagination-info');
    const btnPrev = document.getElementById('btn-img-prev');
    const btnNext = document.getElementById('btn-img-next');

    // Cek Data Kosong
    if (filteredImages.length === 0) {
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center py-16 text-slate-400">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3">
                    <i class="far fa-images text-2xl text-slate-300"></i>
                </div>
                <p>Data tidak ditemukan.</p>
            </div>`;
        paginationControls.classList.add('hidden');
        return;
    }

    paginationControls.classList.remove('hidden');

    // Hitung Pagination
    const totalData = filteredImages.length;
    const maxPage = Math.ceil(totalData / imgRowsPerPage);
    
    // Validasi Halaman
    if (currentImgPage > maxPage) currentImgPage = maxPage;
    if (currentImgPage < 1) currentImgPage = 1;

    // Slice Data
    const startIndex = (currentImgPage - 1) * imgRowsPerPage;
    const endIndex = Math.min(startIndex + imgRowsPerPage, totalData);
    const pageData = filteredImages.slice(startIndex, endIndex);

    // Generate HTML Baris
    let rowsHtml = pageData.map((img, i) => {
        const realIndex = startIndex + i + 1;
        return `
        <tr class="hover:bg-slate-50 transition border-b border-slate-50 last:border-0 group">
            <td class="p-4 text-center text-slate-400 text-xs w-12">${realIndex}</td>
            <td class="p-4 w-20">
                <div class="w-12 h-12 rounded-lg bg-slate-100 border border-slate-200 overflow-hidden relative group-hover:scale-110 transition cursor-pointer" onclick="window.open('${img.link}', '_blank')">
                    <img src="${img.link}" referrerpolicy="no-referrer" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/50?text=Error'">
                </div>
            </td>
            <td class="p-4">
                <div class="font-bold text-slate-700 text-sm truncate max-w-[250px]" title="${img.name}">${img.name}</div>
                <div class="text-[10px] text-slate-400 mt-1"><i class="far fa-clock"></i> ${img.date}</div>
            </td>
            <td class="p-4">
                <div class="flex items-center gap-2 bg-slate-100 p-2 rounded border border-slate-200 relative group/link">
                    <input type="text" value="${img.link}" readonly class="bg-transparent text-xs text-slate-600 font-mono w-full outline-none select-all" id="link-${realIndex}">
                    <button onclick="copyLink('link-${realIndex}')" class="text-blue-600 hover:text-blue-800 font-bold text-xs px-2 py-1 rounded hover:bg-blue-100 transition" title="Copy Link">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </td>
            <td class="p-4 text-right">
                <button onclick="deleteImage('${img.id}')" class="text-slate-400 hover:text-red-600 hover:bg-red-50 p-2 rounded transition" title="Hapus dari list">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        </tr>`;
    }).join('');

    // Render Tabel Lengkap
    container.innerHTML = `
    <div class="overflow-x-auto w-full">
        <table class="w-full text-left border-collapse">
            <thead class="sticky top-0 z-10">
                <tr class="bg-slate-50/90 border-b border-slate-200 text-slate-500 text-[11px] font-bold uppercase tracking-widest backdrop-blur-sm shadow-sm">
                    <th class="py-3 px-4 text-center">No</th>
                    <th class="py-3 px-4">Preview</th>
                    <th class="py-3 px-4">Nama File</th>
                    <th class="py-3 px-4 w-1/2">Direct Link (Copy Ini)</th>
                    <th class="py-3 px-4 text-right">Aksi</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 bg-white text-sm">
                ${rowsHtml}
            </tbody>
        </table>
    </div>`;

    // Update Info Pagination & Tombol
    infoDisplay.innerText = `Menampilkan ${startIndex + 1} - ${endIndex} dari ${totalData} data`;

    btnPrev.disabled = (currentImgPage === 1);
    if(currentImgPage === 1) btnPrev.classList.add('opacity-50', 'cursor-not-allowed');
    else btnPrev.classList.remove('opacity-50', 'cursor-not-allowed');

    btnNext.disabled = (currentImgPage === maxPage || maxPage === 0);
    if(currentImgPage === maxPage || maxPage === 0) btnNext.classList.add('opacity-50', 'cursor-not-allowed');
    else btnNext.classList.remove('opacity-50', 'cursor-not-allowed');
}

function copyLink(elementId) {
    const copyText = document.getElementById(elementId);
    copyText.select();
    copyText.setSelectionRange(0, 99999); 
    navigator.clipboard.writeText(copyText.value).then(() => {
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
        Toast.fire({ icon: 'success', title: 'Link disalin!' });
    });
}

function deleteImage(id) {
    Swal.fire({
        title: 'Hapus?', text: "Hanya menghapus dari list database, file di Google Drive tetap aman.", icon: 'warning',
        showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
    }).then(res => {
        if(res.isConfirmed) {
            database.ref('Gambar').orderByChild('ImageID').equalTo(id).once('value').then(snap => {
              let iKey = null;
              snap.forEach(c => { iKey = c.key; });
              if (iKey) return database.ref('Gambar/' + iKey).remove();
            }).then(() => loadImageTable()).catch(err => Swal.fire('Gagal', err.message, 'error'));
        }
    });
}

/* --- FUNGSI TOGGLE PASSWORD VISIBILITY --- */
function togglePasswordVisibility() {
    const passInput = document.getElementById('password');
    const icon = document.getElementById('icon-toggle-pass');

    if (passInput.type === 'password') {
        // Ubah menjadi text (Tampilkan)
        passInput.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash'); // Ikon mata dicoret
    } else {
        // Kembalikan ke password (Sembunyikan)
        passInput.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye'); // Ikon mata biasa
    }
}

/* --- HALAMAN KONFIGURASI --- */
/* --- HALAMAN KONFIGURASI (LENGKAP) --- */
function renderConfigPage(container) {
    container.innerHTML = `
    <div class="fade-in w-full space-y-6">
        <div class="dash-card p-6">
            <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2 mb-4">
                <i class="fas fa-sliders-h text-slate-600"></i> Konfigurasi Aplikasi
            </h2>
            <p class="text-sm text-slate-500 mb-6">Ubah tampilan halaman login aplikasi (Logo, Judul, & Background).</p>

            <form onsubmit="handleSaveConfig(event)" class="space-y-6 max-w-3xl">
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Nama Aplikasi (Judul Login)</label>
                    <input type="text" name="appName" id="cfg-app-name" placeholder="Contoh: Ujian Sekolah" 
                        class="w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition font-bold text-slate-700">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Deskripsi / Sub-Judul</label>
                    <input type="text" name="appSubtitle" id="cfg-app-subtitle" placeholder="Contoh: Tahun Ajaran 2024/2025" 
                        class="w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition text-sm">
                </div>

                <div class="border-t border-slate-100 my-4"></div>

                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-1 relative group">
                         <label class="block text-xs font-bold text-slate-500 uppercase mb-2">URL Logo Aplikasi (Auto-Search)</label>
                         
                         <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400 pointer-events-none">
                                <i class="fas fa-search"></i>
                            </span>
                            
                            <input type="text" name="appLogo" id="cfg-app-logo" 
                                placeholder="Ketik nama file gambar..." 
                                autocomplete="off"
                                onkeyup="handleConfigLogoSearch(this)"
                                onfocus="handleConfigLogoSearch(this)"
                                onblur="setTimeout(() => document.getElementById('cfg-logo-results').classList.add('hidden'), 200)"
                                oninput="updateLogoPreview(this.value)"
                                class="pl-10 w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition text-sm font-mono">
                            
                            <div id="cfg-logo-results" class="hidden absolute z-50 left-0 right-0 mt-1 bg-white border border-slate-200 rounded-xl shadow-xl max-h-56 overflow-y-auto custom-scrollbar"></div>
                         </div>
                         <p class="text-[10px] text-slate-400 mt-2">*Ketik nama file untuk mencari gambar dari Folder Gambar.</p>
                    </div>
                    
                    <div class="w-24 h-24 bg-slate-100 rounded-xl border border-slate-200 flex items-center justify-center p-2 shrink-0 relative">
                        <img id="cfg-logo-preview" src="" class="max-w-full max-h-full object-contain" onerror="this.style.display='none'">
                        <span class="text-[10px] text-slate-400 absolute z-0">Preview</span>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-6 pt-2">
                    <div class="flex-1 relative group">
                         <label class="block text-xs font-bold text-slate-500 uppercase mb-2">URL Background Login (Auto-Search)</label>
                         
                         <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400 pointer-events-none">
                                <i class="fas fa-image"></i>
                            </span>
                            
                            <input type="text" name="appBackground" id="cfg-app-bg" 
                                placeholder="Ketik nama file gambar..." 
                                autocomplete="off"
                                onkeyup="handleConfigBgSearch(this)"
                                onfocus="handleConfigBgSearch(this)"
                                onblur="setTimeout(() => document.getElementById('cfg-bg-results').classList.add('hidden'), 200)"
                                oninput="updateBgPreview(this.value)"
                                class="pl-10 w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition text-sm font-mono">
                            
                            <div id="cfg-bg-results" class="hidden absolute z-50 left-0 right-0 mt-1 bg-white border border-slate-200 rounded-xl shadow-xl max-h-56 overflow-y-auto custom-scrollbar"></div>
                         </div>
                         <p class="text-[10px] text-slate-400 mt-2">*Disarankan gambar orientasi Landscape.</p>
                    </div>
                    
                    <div class="w-32 h-24 bg-slate-100 rounded-xl border border-slate-200 flex items-center justify-center overflow-hidden shrink-0 relative">
                        <img id="cfg-bg-preview" src="" class="w-full h-full object-cover" onerror="this.style.display='none'">
                        <span class="text-[10px] text-slate-400 absolute z-0">Preview</span>
                    </div>
                </div>

                <div class="pt-6 border-t border-slate-100">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center gap-2">
                        <i class="fas fa-save"></i> Simpan Perubahan
                    </button>
                </div>
            </form>
        </div>
    </div>`;

    // Panggil fungsi load data saat form selesai dirender
    loadConfigToForm();
}

function updateLogoPreview(url) {
    const img = document.getElementById('cfg-logo-preview');
    img.style.display = 'block';
    img.src = url;
}

/* ==========================================
   LOGIKA KONFIGURASI
   ========================================== */

// 1. Load Data ke Form Konfigurasi (Saat Menu Diklik)
function loadConfigToForm() {
    // Panggil fungsi di Code.gs
    database.ref('AppConfig').once('value').then(snapshot => {
      const data = snapshot.val() || {};
      document.getElementById('cfg-app-name').value = data.app_name || '';
      document.getElementById('cfg-app-subtitle').value = data.app_subtitle || '';
      document.getElementById('cfg-app-logo').value = data.app_logo || '';
      updateLogoPreview(data.app_logo || '');
      document.getElementById('cfg-app-bg').value = data.app_background || '';
      updateBgPreview(data.app_background || '');
    });
}

// 2. Simpan Data dari Form
function handleSaveConfig(e) {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

    const fd = new FormData(e.target);
    const formObj = Object.fromEntries(fd.entries());

    database.ref('AppConfig').set({
      app_name: formObj.appName || '', app_subtitle: formObj.appSubtitle || '',
      app_logo: formObj.appLogo || '', app_background: formObj.appBg || ''
    }).then(() => {
      btn.disabled = false;
      btn.innerHTML = originalText;
      Swal.fire('Berhasil', 'Konfigurasi berhasil disimpan.', 'success');
      applyConfigToLogin(formObj.appName, formObj.appSubtitle, formObj.appLogo);
    }).catch(err => {
      btn.disabled = false;
      btn.innerHTML = originalText;
      Swal.fire('Gagal', err.message, 'error');
    });
}

// 3. Terapkan Konfigurasi ke Halaman Login (Dipanggil saat awal Load & setelah Save)
/* =========================================
   1. KONFIGURASI LOGIN & UI DASAR
   ========================================= */

function applyConfigToLogin(title, subtitle, logo) {
    if (title) {
        document.getElementById('login-title').innerText = title;
        // Juga ubah Title Header Admin
        const adminHeader = document.querySelector('.sidebar-header-text h1');
        if (adminHeader) adminHeader.innerText = title;
        // Ubah Title Browser Tab
        document.title = title;
    }
    if (subtitle) {
        document.getElementById('login-subtitle').innerText = subtitle;
    }
    if (logo) {
        document.getElementById('login-logo-img').src = logo;
    }
}

function switchPage(pid) {
    document.querySelectorAll('#app > div').forEach(d => {
        if (!d.id.includes('overlay')) d.classList.add('hidden');
    });
    document.getElementById(pid).classList.remove('hidden');
}


/* =========================================
   2. MANAJEMEN MODAL UJIAN (UPDATED FOR MULTI-CLASS)
   ========================================= */

// [NEW] Helper function to populate class checkboxes
function populateClassCheckboxes(classArray, selectedClasses = []) {
    const container = document.getElementById('input-class-container');
    if (!container) return;

    if (!classArray || classArray.length === 0) {
        container.innerHTML = '<p class="text-xs text-slate-400">Tidak ada data kelas ditemukan.</p>';
        return;
    }

    container.innerHTML = classArray.map(cls => {
        const className = typeof cls === 'object' ? cls.value : cls;
        const isChecked = selectedClasses.includes(className);
        return `
            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-md hover:bg-slate-100 transition">
                <input type="checkbox" value="${className}" ${isChecked ? 'checked' : ''}
                       class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                <span class="text-sm font-medium text-slate-700">${className}</span>
            </label>
        `;
    }).join('');
}

// [NEW] Helper to populate standard dropdowns, to avoid breaking other parts of the code
function populateSelect(selectEl, options, keepOld = false) {
    if (!selectEl) return;
    if (!keepOld) {
        selectEl.innerHTML = '<option value="">-- Pilih --</option>';
    }
    options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        selectEl.appendChild(option);
    });
}

function openExamModal(data = null) {
    const modal = document.getElementById('examModal');

    // Safety check: Init jika modal belum ada
    if (!modal) {
        initExamModalComponent();
        return setTimeout(() => openExamModal(data), 100);
    }

    const title = document.getElementById('examModalTitle');
    const btn = document.getElementById('btnSaveExam');

    // 1. Reset Form
    document.getElementById('examForm').reset();
    document.getElementById('input-examId').value = '';

    // 2. Helper Format Tanggal
    const toLocalISO = (dateStr) => {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        const local = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
        return local.toISOString().slice(0, 16);
    };

    // 3. Isi Data Input Standar (Non-Dropdown)
    if (data) {
        title.innerText = 'Edit Jadwal Ujian';
        btn.innerHTML = '<i class="fas fa-sync-alt"></i> Update Data';
        document.getElementById('input-examId').value = data.id;
        document.getElementById('input-date').value = toLocalISO(data.date);
        document.getElementById('input-endDate').value = toLocalISO(data.endDate);
        document.getElementById('input-duration').value = data.duration;
        document.getElementById('input-pin').value = data.pin;
    } else {
        title.innerText = 'Buat Jadwal Baru';
        btn.innerHTML = '<i class="fas fa-save"></i> Simpan Jadwal';
        const now = new Date();
        const next = new Date(now.getTime() + 2 * 60 * 60 * 1000);
        document.getElementById('input-date').value = toLocalISO(now);
        document.getElementById('input-endDate').value = toLocalISO(next);
        document.getElementById('input-duration').value = '60';
        document.getElementById('input-pin').value = Math.floor(10000 + Math.random() * 90000);
    }

    // 4. LOGIKA DROPDOWN (SUBJECT) & CHECKBOXES (CLASS)
    const subjSelect = document.getElementById('input-subject');
    
    // Fungsi untuk memilih value setelah data terisi
    const applySelection = (allClasses) => {
        const selectedClasses = data ? String(data.class || '').split(',').map(c => c.trim()) : [];
        populateClassCheckboxes(allClasses, selectedClasses);
        if (data) {
            subjSelect.value = data.subject || "";
        } else {
            subjSelect.value = "";
        }
    };
    
    // Cek jika data master belum ada di cache
    if (!masterData.classes || masterData.classes.length === 0) {
        database.ref('Master_Data').once('value').then(snapshot => {
          const md = snapshot.val() || {};
          masterData = md;
          populateSelect(subjSelect, md.subjects || [], false);
          applySelection(md.classes || []);
        });
    } else {
        // Gunakan data dari cache
        populateSelect(subjSelect, masterData.subjects || [], false);
        applySelection(masterData.classes || []);
    }

    modal.classList.remove('hidden');
}


/* =========================================
   3. HELPER DROPDOWN & ASSIGNMENT
   ========================================= */

function renderAssignmentDropdown(items, editData, emptyLabel) {
    const wrapper = document.getElementById('assignment-wrapper');
    if (!wrapper) return;

    if (!items || items.length === 0) {
        wrapper.innerHTML = `<div class="text-red-500 text-xs p-2 font-bold bg-red-50 rounded border border-red-200">Belum ada data (${emptyLabel}) di Database Users.</div>`;
    } else {
        // Buat Opsi Dropdown
        let options = items.map(a => `<option value="${a.subject}|${a.classVal}">${a.label}</option>`).join('');

        // Render Select
        wrapper.outerHTML = `
            <select id="select-assignment" onchange="fillAssignmentInput(this)" class="w-full border border-blue-300 bg-blue-50 text-blue-900 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm font-bold cursor-pointer" required>
                <option value="">-- Pilih Mapel & Kelas --</option>
                ${options}
            </select>`;

        // Jika Mode Edit, pilih nilai yang sesuai
        if (editData) {
            const valToSelect = `${editData.subject}|${editData.class}`;
            const selectEl = document.getElementById('select-assignment');
            if (selectEl) {
                selectEl.value = valToSelect;
                fillAssignmentInput(selectEl); // Trigger manual agar hidden input terisi
            }
        }
    }
}

function fillAssignmentInput(selectElement) {
    const val = selectElement.value;
    const inputSub = document.getElementById('input-subject');
    const inputCls = document.getElementById('input-class');

    if (val && val.includes('|')) {
        const parts = val.split('|');
        inputSub.value = parts[0]; // Isi Mapel ke hidden
        inputCls.value = parts[1]; // Isi Kelas ke hidden
    } else {
        inputSub.value = '';
        inputCls.value = '';
    }
}


/* =========================================
   4. DATA MASTER (GURU/ADMIN)
   ========================================= */

function loadMasterDataForUser(selectedClass = null) {
    // Cek jika data belum ada, ambil dari server
    if (masterData.classes.length === 0) {
        database.ref('Master_Data').once('value').then(snapshot => {
          const res = snapshot.val() || {};
          masterData = res;
          renderStudentClassDropdown(selectedClass);
          const role = document.getElementById('input-role').value;
          if (role === 'Guru') renderTeacherRows();
        });
    } else {
        // Jika data sudah ada di cache, langsung render
        renderStudentClassDropdown(selectedClass);
    }
}

function renderStudentClassDropdown(selectedValue = null) {
    const select = document.getElementById('input-student-class');
    if (!select) return;

    // Reset opsi
    select.innerHTML = '<option value="">-- Pilih Kelas --</option>';

    // Loop data master kelas
    if (masterData && masterData.classes) {
        masterData.classes.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.innerText = c;

            // Pilih otomatis jika ada value yang dikirim (Mode Edit)
            if (selectedValue && String(c) === String(selectedValue)) {
                opt.selected = true;
            }
            select.appendChild(opt);
        });
    }
}

function addTeacherAssignmentRow(subjectVal = '', classVal = '') {
    const container = document.getElementById('teacher-assignments-container');

    // Siapkan Opsi Dropdown Mapel
    let subOpts = `<option value="">- Pilih Mapel -</option>`;
    masterData.subjects.forEach(s => {
        subOpts += `<option value="${s}" ${s === subjectVal ? 'selected' : ''}>${s}</option>`;
    });

    // Siapkan Opsi Dropdown Kelas
    let clsOpts = `<option value="">- Pilih Kelas -</option>`;
    masterData.classes.forEach(c => {
        clsOpts += `<option value="${c}" ${c === classVal ? 'selected' : ''}>${c}</option>`;
    });

    // Tambahkan Input Text Manual sebagai fallback jika opsi tidak ada
    const div = document.createElement('div');
    div.className = 'assignment-row flex gap-2 items-center animate-[fadeIn_0.2s_ease-out]';
    div.innerHTML = `
        <div class="flex-1 relative">
            <input type="text" list="dl-subjects" class="assign-subject w-full border border-slate-300 rounded px-2 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Mapel" value="${subjectVal}">
            <datalist id="dl-subjects">${subOpts}</datalist>
        </div>
        <div class="w-1/3 relative">
            <input type="text" list="dl-classes" class="assign-class w-full border border-slate-300 rounded px-2 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Kelas" value="${classVal}">
            <datalist id="dl-classes">${clsOpts}</datalist>
        </div>
        <button type="button" onclick="this.parentElement.remove()" class="text-slate-400 hover:text-red-500 px-1 transition"><i class="fas fa-trash"></i></button>
    `;
    container.appendChild(div);
}


/* =========================================
   5. PAGINATION & FILTER
   ========================================= */

function handleResultSearch(keyword) {
    const term = keyword.toLowerCase().trim();

    // Filter data mentah (allResultsData)
    filteredResults = allResultsData.filter(item => {
        return item.name.toLowerCase().includes(term) ||
            item.studentId.toLowerCase().includes(term);
    });

    currentPage = 1; // Reset ke halaman 1 setiap pencarian
    renderInternalTable(); // Render ulang
}

function changeRowsPerPage(val) {
    if (val === 'all') {
        rowsPerPage = filteredResults.length > 0 ? filteredResults.length : 10;
    } else {
        rowsPerPage = parseInt(val);
    }
    currentPage = 1; // Reset ke halaman 1
    renderInternalTable();
}

function changePage(direction) {
    if (direction === 'prev') {
        if (currentPage > 1) currentPage--;
    } else if (direction === 'next') {
        const maxPage = Math.ceil(filteredResults.length / rowsPerPage);
        if (currentPage < maxPage) currentPage++;
    }
    renderInternalTable();
}


/* =========================================
   6. PREVIEW SOAL (MODAL)
   ========================================= */

function closePreviewModal() {
    const modal = document.getElementById('modal-preview');
    if (modal) {
        modal.classList.add('hidden');
        // Reset modal size
        modal.querySelector('.relative.w-full').classList.replace('max-w-6xl', 'max-w-4xl');
    }
}

function _renderSingleQuestionForPreview(q, index) {
    let html = `<div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-4">`;

    // Header Soal (Nomor)
    html += `
        <div class="flex items-center gap-3 mb-4 border-b pb-3">
            <span class="w-8 h-8 flex-shrink-0 flex items-center justify-center bg-slate-100 text-slate-500 font-bold rounded-full text-sm">${index + 1}</span>
            <p class="text-xs font-bold text-slate-400 uppercase">Soal Tipe: ${q.type}</p>
        </div>`;

    // KONTEN
    html += `<div class="question-text text-base md:text-lg mb-6">${q.content}</div>`;

    // GAMBAR
    if (q.image) {
        html += `<div class="mb-6 border rounded-lg overflow-hidden flex justify-center bg-slate-50">
                    <img src="${q.image}?sz=w1000" class="max-w-full h-auto max-h-96" alt="Gambar Soal">
                 </div>`;
    }

    // OPSI JAWABAN
    const type = q.type;
    let options = [];
    if (Array.isArray(q.options)) {
        options = q.options;
    } else if (typeof q.options === 'string' && q.options.trim()) {
        try { options = JSON.parse(q.options); } catch (e) { options = []; }
    }

    if (type === 'PG' && Array.isArray(options)) {
        html += '<div class="space-y-3">';
        const optionChars = ['A', 'B', 'C', 'D', 'E'];
        options.forEach((opt, i) => {
            html += `
                <label class="option-label">
                    <div class="custom-radio !border-slate-300"></div>
                    <div class="flex-1">
                        <span class="font-bold text-slate-500 mr-2">${optionChars[i]}.</span>
                        <span>${opt}</span>
                    </div>
                </label>`;
        });
        html += '</div>';

    } else if (type === 'Esai') {
        html += `<textarea readonly class="w-full border border-slate-200 rounded-lg p-4 h-32 bg-slate-50" placeholder="Siswa akan mengetik jawaban di sini..."></textarea>`;

    } else if (type === 'BS' && Array.isArray(options)) {
        html += `
            <div class="border rounded-lg overflow-hidden">
                <table class="w-full">
                    <thead>
                        <tr class="bg-slate-100">
                            <th class="p-3 text-left text-sm font-bold text-slate-600">Pernyataan</th>
                            <th class="p-3 text-center text-sm font-bold text-slate-600 w-40">Jawaban</th>
                        </tr>
                    </thead>
                    <tbody>`;
        options.forEach((stmt) => {
            html += `
                <tr class="border-t">
                    <td class="p-4 text-sm text-slate-700">${stmt}</td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center gap-2">
                            <button class="font-medium text-sm py-1 px-4 rounded-full border border-slate-300 bg-white">Benar</button>
                            <button class="font-medium text-sm py-1 px-4 rounded-full border border-slate-300 bg-white">Salah</button>
                        </div>
                    </td>
                </tr>`;
        });
        html += '</tbody></table></div>';

    } else if (type === 'JODOH' && Array.isArray(options)) {
        html += '<p class="text-sm text-center text-slate-500 italic mb-4">Siswa akan memasangkan item di sisi kiri dengan opsi pasangan di sisi tengah.</p>';
        html += `
            <div class="grid grid-cols-3 gap-3">
                <div class="space-y-2">
                    <div class="text-[10px] font-bold text-slate-400 uppercase text-center mb-1">Kiri (Soal)</div>
                    ${options.map(p => `<div class="p-3 rounded-lg border bg-white text-sm text-center font-medium">${p.q}</div>`).join('')}
                </div>
                <div class="space-y-2">
                    <div class="text-[10px] font-bold text-slate-400 uppercase text-center mb-1">Tengah (Opsi)</div>
                    ${options.map(p => `<div class="p-3 rounded-lg border bg-teal-50 text-sm text-center font-medium border-teal-200 text-teal-700">${p.m || p.a}</div>`).join('')}
                </div>
                <div class="space-y-2">
                    <div class="text-[10px] font-bold text-slate-400 uppercase text-center mb-1">Kanan (Jawaban)</div>
                    ${options.map(p => `<div class="p-3 rounded-lg border bg-emerald-50 text-sm text-center font-medium border-emerald-200 text-emerald-700">${p.a}</div>`).join('')}
                </div>
            </div>`;
    }

    html += `</div>`; // Close wrapper div
    return html;
}

function showQuestionPreview(qStr) {
    const q = JSON.parse(decodeURIComponent(qStr));
    const container = document.getElementById('preview-content');
    const modal = document.getElementById('modal-preview');

    if (!container || !modal) return;

    // Gunakan helper function
    container.innerHTML = _renderSingleQuestionForPreview(q, 0);
    MathJax.typesetPromise([container]);
    modal.classList.remove('hidden');
}

function previewAllQuestions() {
    if (!filteredQuestions || filteredQuestions.length === 0) {
        Swal.fire('Info', 'Tidak ada soal untuk ditampilkan dalam pratinjau.', 'info');
        return;
    }

    const container = document.getElementById('preview-content');
    const modal = document.getElementById('modal-preview');
    const modalDialog = modal.querySelector('.relative.w-full');

    // Ubah ukuran modal untuk pratinjau mapel
    modalDialog.classList.replace('max-w-4xl', 'max-w-6xl');

    let allHtml = filteredQuestions.map((q, index) => {
        // Panggil helper untuk setiap soal
        return _renderSingleQuestionForPreview(q, index);
    }).join('');

    container.innerHTML = allHtml;
    MathJax.typesetPromise([container]);
    modal.classList.remove('hidden');
}


/* =========================================
   7. FITUR SALIN SOAL (COPY EXAM)
   ========================================= */

function initCopyForm() {
    const sourceSelect = document.getElementById('copy-source-exam');
    const destSelect = document.getElementById('copy-destination-exam');

    if (!sourceSelect || !destSelect) return;

    const optionsHtml = cachedExams.map(e => `<option value="${e.id}">${e.subject} (${e.class})</option>`).join('');

    sourceSelect.innerHTML = optionsHtml;
    destSelect.innerHTML = optionsHtml;
}

function handleCopyQuestions() {
    const sourceId = document.getElementById('copy-source-exam').value;
    const destId = document.getElementById('copy-destination-exam').value;

    if (!sourceId || !destId) {
        Swal.fire('Gagal', 'Harap pilih sumber dan tujuan.', 'error');
        return;
    }

    if (sourceId === destId) {
        Swal.fire('Gagal', 'Mapel sumber dan tujuan tidak boleh sama.', 'error');
        return;
    }

    const sourceText = document.getElementById('copy-source-exam').options[document.getElementById('copy-source-exam').selectedIndex].text;
    const destText = document.getElementById('copy-destination-exam').options[document.getElementById('copy-destination-exam').selectedIndex].text;

    Swal.fire({
        title: 'Konfirmasi Penyalinan',
        html: `Anda yakin ingin menyalin <b>semua soal</b> dari:<br><b>${sourceText}</b><br>ke:<br><b>${destText}</b>?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#0ea5e9',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Ya, Salin Sekarang!',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('global-loading').classList.remove('hidden');

            // Salin soal antar ujian via Firebase
            database.ref('Questions').orderByChild('ExamID').equalTo(sourceId).once('value').then(snap => {
              const copies = [];
              snap.forEach(c => {
                const q = c.val();
                copies.push(database.ref('Questions').push({
                  ExamID: destId,
                  QuestionID: 'Q_' + Date.now() + '_' + Math.random().toString(36).substr(2,5),
                  Type: q.Type, Content: q.Content, Options: q.Options || [],
                  Correct: q.Correct, IsRequired: q.IsRequired, Point: q.Point || 10, Image: q.Image || ''
                }));
              });
              return Promise.all(copies).then(() => copies.length);
            }).then(count => {
              document.getElementById('global-loading').classList.add('hidden');
              Swal.fire({ title: 'Berhasil!', text: `${count} soal berhasil disalin.`, icon: 'success' });
              if (document.getElementById('select-exam-q').value === destId) loadQuestionsTable(destId);
              document.getElementById('form-copy-q').classList.add('hidden');
            }).catch(err => {
              document.getElementById('global-loading').classList.add('hidden');
              Swal.fire('Error', err.message, 'error');
            });
        }
    });
}
   

function downloadResultsAsExcel() {
    if (!allResultsData || allResultsData.length === 0) {
        Swal.fire('Info', 'Tidak ada data hasil ujian untuk di-download.', 'info');
        return;
    }

    // 1. Dapatkan nama Ujian
    const examSelect = document.getElementById('select-result-exam');
    const examText = examSelect.options[examSelect.selectedIndex].text;
    const cleanFileName = examText.replace(/[^a-z0-9_-\s]/gi, '').replace(/[\s()]/g, '_');

    // 2. Siapkan Header
    const headers = [
        'ID Siswa',
        'Nama Lengkap',
        'Kelas',
        'Skor Akhir',
        'Status',
        'Waktu Mulai',
        'Waktu Submit'
    ];

    // 3. Map Data ke Array of Arrays
    const dataForSheet = allResultsData.map(result => [
        result.studentId,
        result.name,
        result.class,
        result.score,
        result.status,
        result.startTime,
        result.submitTime
    ]);

    // 4. Gabungkan Header dan Data
    const finalData = [headers, ...dataForSheet];

    // 5. Buat Worksheet dan Workbook menggunakan SheetJS
    const ws = XLSX.utils.aoa_to_sheet(finalData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Rekap Hasil');

    // 6. Trigger Download
    XLSX.writeFile(wb, `Rekap_Hasil_${cleanFileName}.xlsx`);
}

function downloadSingleStudentAnswers(responseId, studentName) {
    Swal.fire({
        title: 'Memproses...',
        text: 'Mengambil detail jawaban siswa...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    // Ambil data jawaban siswa dari Firebase (dengan fallback)
    const findRespDownload = () => {
      return database.ref('Responses').orderByChild('ResponseID').equalTo(responseId).once('value').then(rSnap => {
        let respData = null;
        rSnap.forEach(c => { respData = c.val(); respData._key = c.key; });
        if (respData) return respData;
        return database.ref('Responses').once('value').then(allSnap => {
          allSnap.forEach(c => { const v = c.val(); if (v.ResponseID === responseId || c.key === responseId) { respData = v; respData._key = c.key; } });
          return respData;
        });
      });
    };
    findRespDownload().then(respData => {
      if (!respData) throw new Error('Data tidak ditemukan.');
      const examId = respData.ExamID;
      const answers = respData.Answers || {};

      return database.ref('Questions').orderByChild('ExamID').equalTo(examId).once('value').then(qSnap => {
        const details = [];
        let idx = 0;
        qSnap.forEach(qc => {
          idx++;
          const q = qc.val();
          details.push({
            number: idx,
            content: q.Content || '',
            student_answer: answers[q.QuestionID || qc.key] || '',
            correct_key: q.Correct || ''
          });
        });

        return database.ref('Exams').orderByChild('ExamID').equalTo(examId).once('value').then(eSnap => {
          let examSubject = 'Ujian', examClass = '';
          eSnap.forEach(ec => {
            const e = ec.val();
            examSubject = e.Subject || 'Ujian';
            examClass = e.Class || '';
          });

          const headers = ['No.', 'Pertanyaan', 'Jawaban Siswa', 'Kunci Jawaban'];
          const dataForSheet = details.map(item => [item.number, item.content, item.student_answer, item.correct_key]);
          const finalData = [headers, ...dataForSheet];
          const ws = XLSX.utils.aoa_to_sheet(finalData);
          ws['!cols'] = [{wch:5}, {wch:60}, {wch:40}, {wch:40}];
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Detail Jawaban');
          const cleanStudentName = studentName.replace(/[^a-z0-9_-\s]/gi, '');
          const cleanSubject = (examSubject || 'Ujian').replace(/[^a-z0-9_-\s]/gi, '').replace(/[\s()]/g, '_');
          XLSX.writeFile(wb, `Jawaban_${cleanStudentName}_${cleanSubject}.xlsx`);
          Swal.close();
        });
      });
    }).catch(err => {
      Swal.fire('Error', err.message, 'error');
    });
}

// Fungsi untuk memuat Editor TinyMCE
function initRichEditor() {
    // 1. Editor Utama (Soal/Cerita) - Fitur Lengkap
    if (tinymce.get('editor-content')) tinymce.remove('#editor-content');
    
    tinymce.init({
        selector: '#editor-content',
        height: 300,
        menubar: false,
        plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table paste help wordcount',
        toolbar: 'undo redo | blocks | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | image',
        paste_data_images: true,
        smart_paste: true,
        images_upload_handler: (blobInfo, progress) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(blobInfo.blob());
            reader.onload = () => resolve(reader.result);
            reader.onerror = (error) => reject(error);
        })
    });

    // 2. Editor Mini (Untuk Opsi Jawaban A-E) - Fitur Minimalis
    // Kita loop 0-4 untuk menginisialisasi setiap kolom opsi
    for(let i=0; i<5; i++) {
        const id = 'opt-' + i;
        if (tinymce.get(id)) tinymce.remove('#' + id);
        
        tinymce.init({
            selector: '#' + id,
            height: 150, // Lebih kecil
            menubar: false,
            statusbar: false, // Hilangkan status bar bawah
            plugins: 'image paste charmap', // Hanya plugin penting
            toolbar: 'bold italic | image', // Toolbar sederhana
            paste_data_images: true,
            smart_paste: true,
            content_style: 'body { font-size: 12px; margin: 5px; }', // Font lebih kecil
            images_upload_handler: (blobInfo, progress) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(blobInfo.blob());
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
            })
        });
    }
}
/* ==========================================
   FITUR NOTIFIKASI ADMIN & PERBAIKAN FOTO (UPDATED)
   ========================================== */

// 1. Logic Notifikasi & UI (REFINED - GROUPED)
let notifications = [];
let isNotifOpen = false;

function initNotificationListener() {
    console.log('Initializing Notification Listener (Grouped - Fixed)...');
    
    // 1. Dengar status 'Selesai' (Realtime masuk query)
    database.ref('Responses').orderByChild('Status').equalTo('Selesai').limitToLast(20).on('child_added', handleNotifUpdate);
    
    // 2. Dengar status 'Curang' (Realtime masuk query)
    database.ref('Responses').orderByChild('Status').equalTo('Curang').limitToLast(20).on('child_added', handleNotifUpdate);

    // Note: Kita tidak pakai 'child_changed' global lagi karena berat. 
    // Saat status berubah jadi Selesai/Curang, dia akan otomatis masuk ke query 'child_added' di atas.
}

function handleNotifUpdate(snapshot) {
    const data = snapshot.val();
    if (!data || !data.Status) return;

    // Filter Status
    if (data.Status !== 'Selesai' && data.Status !== 'Curang') return;

    // Get Exam Info
    const examId = data.ExamID;
    const exam = cachedExams.find(e => e.id === examId);
    const subjectName = exam ? exam.subject : (data.ExamID || 'Ujian');
    
    // Check if we already have a notification group for this Exam & Status
    const existingIdx = notifications.findIndex(n => n.examId === examId && n.status === data.Status);
    
    const now = new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
    
    if (existingIdx > -1) {
        // Update Existing Group
        const item = notifications[existingIdx];
        item.count++;
        item.time = now;
        item.message = `<b>${item.count} Siswa</b> ${data.Status === 'Curang' ? 'terdeteksi curang' : 'selesai'} pada <b>${subjectName}</b>.`;
        
        // Move to top
        notifications.splice(existingIdx, 1);
        notifications.unshift(item);
    } else {
        // Create New Group
        const notifItem = {
            id: 'NOTIF_' + examId + '_' + data.Status,
            examId: examId,
            status: data.Status,
            count: 1,
            type: data.Status === 'Curang' ? 'danger' : 'success', // Hijau untuk Selesai
            title: data.Status === 'Curang' ? 'Indikasi Kecurangan' : 'Ujian Selesai',
            message: `<b>1 Siswa</b> ${data.Status === 'Curang' ? 'terdeteksi curang' : 'selesai'} pada <b>${subjectName}</b>.`,
            time: now
        };
        notifications.unshift(notifItem);
    }
    
    updateNotificationUI();
}

function updateNotificationUI() {
    const badge = document.getElementById('notification-badge');
    const countEl = document.getElementById('notif-count');
    const listEl = document.getElementById('notification-list');
    
    if (!badge || !listEl) return;

    // Hitung total notifikasi (bukan total siswa, tapi total item notifikasi)
    const totalItems = notifications.length;

    if (totalItems > 0) {
        badge.classList.remove('hidden');
        countEl.innerText = totalItems;
    } else {
        badge.classList.add('hidden');
        countEl.innerText = '0';
    }
    
    if (totalItems === 0) {
        listEl.innerHTML = '<div class="p-4 text-center text-slate-400 text-xs italic">Belum ada notifikasi baru.</div>';
        return;
    }
    
    listEl.innerHTML = notifications.map(n => `
        <div onclick="handleNotificationClick('${n.examId}')" class="px-4 py-3 border-b border-slate-50 hover:bg-slate-50 transition cursor-pointer flex gap-3 items-start group">
            <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 ${n.type === 'danger' ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}">
                <i class="fas ${n.type === 'danger' ? 'fa-exclamation-triangle' : 'fa-check'}"></i>
            </div>
            <div class="flex-1">
                <div class="flex justify-between items-start">
                     <h4 class="text-xs font-bold text-slate-700 group-hover:text-blue-600 transition">${n.title}</h4>
                     <span class="text-[10px] text-slate-400 font-normal">${n.time}</span>
                </div>
                <p class="text-xs text-slate-600 mt-1 leading-relaxed">${n.message}</p>
                <div class="mt-1 flex items-center gap-1 text-[10px] text-blue-500 font-bold opacity-0 group-hover:opacity-100 transition">
                    Lihat Hasil <i class="fas fa-arrow-right"></i>
                </div>
            </div>
        </div>
    `).join('');
}

function handleNotificationClick(examId) {
    if(!examId) return;
    // Tutup dropdown
    toggleNotifications();
    // Navigasi ke Hasil & Nilai dengan Filter ExamID
    showAdminTab('dash-results', null, examId);
}

function toggleNotifications() {
    const dropdown = document.getElementById('notification-dropdown');
    isNotifOpen = !isNotifOpen;
    if (isNotifOpen) {
        dropdown.classList.remove('hidden');
        // Tidak perlu init ulang listener, cukup toggle UI
    } else {
        dropdown.classList.add('hidden');
    }
}

function clearNotifications() {
    notifications = [];
    updateNotificationUI();
}

// 2. Perbaikan Foto (V2 - Thumbnail Link)
function convertDriveLink(url) {
    if (!url) return 'https://via.placeholder.com/150?text=No+Photo';
    let fileId = null;
    
    // 1. Mencari ID file dari format link biasa (contoh: /file/d/ID/view)
    const match1 = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
    
    // 2. Mencari ID file dari format link lain (contoh: /open?id=ID)
    const match2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    
    // 3. Menyimpan ID yang berhasil ditemukan
    if (match1 && match1[1]) fileId = match1[1];
    else if (match2 && match2[1]) fileId = match2[1];
    
    // 4. MENGUBAH URL MENGGUNAKAN ENDPOINT THUMBNAIL
    if (fileId) {
        return `https://drive.google.com/thumbnail?id=${fileId}&sz=w800`;
    }
    
    return url;
}

// 3. Override Fungsi Print Kartu
function printStudentCard(userId) {
    const loading = document.getElementById('global-loading');
    if(loading) loading.classList.remove('hidden');
    
    database.ref('Users/' + userId).once('value').then(snap => {
        const u = snap.val();
        if (!u) throw new Error('User data null');
        
        const photoUrl = convertDriveLink(u.Photo || u.photoUrl);
        const appName = document.getElementById('login-title') ? document.getElementById('login-title').innerText : 'UJIAN ONLINE';
        const logoSrc = document.getElementById('login-logo-img') ? document.getElementById('login-logo-img').src : '';

        const html = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Kartu Peserta - ${u.username || u.Username}</title>
            <style>
                body { font-family: 'Segoe UI', sans-serif; -webkit-print-color-adjust: exact; margin: 0; padding: 20px; }
                .card { width: 400px; border: 2px solid #333; border-radius: 12px; overflow: hidden; margin: auto; page-break-inside: avoid; }
                .header { background: #f8fafc; padding: 15px; border-bottom: 2px solid #333; display: flex; align-items: center; gap: 15px; }
                .logo { height: 50px; width: auto; object-fit: contain; }
                .header-text { flex: 1; }
                .header-text h2 { margin: 0; font-size: 16px; color: #1e293b; text-transform: uppercase; }
                .header-text p { margin: 2px 0 0; font-size: 10px; color: #64748b; font-weight: bold; letter-spacing: 1px; }
                .body { padding: 20px; display: flex; gap: 15px; }
                .info { flex: 1; font-size: 12px; line-height: 1.6; color: #334155; }
                .info strong { color: #0f172a; width: 70px; display: inline-block; }
                .photo-box { width: 90px; height: 110px; background: #e2e8f0; border: 1px solid #cbd5e1; border-radius: 6px; overflow: hidden; }
                .photo-box img { width: 100%; height: 100%; object-fit: cover; }
                .footer { background: #f1f5f9; padding: 8px; text-align: center; font-size: 9px; color: #64748b; border-top: 1px solid #e2e8f0; }
            </style>
        </head>
        <body onload="window.print(); window.close();">
            <div class="card">
                <div class="header">
                    <img src="${logoSrc}" class="logo" onerror="this.style.display='none'">
                    <div class="header-text">
                        <h2>${appName}</h2>
                        <p>KARTU PESERTA UJIAN</p>
                    </div>
                </div>
                <div class="body">
                    <div class="info">
                        <div><strong>NAMA</strong> : ${u.username || u.Username}</div>
                        <div><strong>ID USER</strong> : ${u.id || u.UserID || u.userId}</div>
                        <div><strong>KELAS</strong> : ${u.class || u.Class}</div>
                        <div><strong>PASSWORD</strong> : ${u.password || u.Password}</div>
                        <div style="margin-top: 8px; font-weight: bold;">SESI UJIAN: 2024</div>
                    </div>
                    <div class="photo-box">
                        <img src="${photoUrl}" onerror="this.src='https://ui-avatars.com/api/?name=${u.username}&background=random'">
                    </div>
                </div>
                <div class="footer">
                    Harap kartu ini dibawa dan digunakan saat ujian berlangsung.
                </div>
            </div>
        </body>
        </html>
        `;
        
        const win = window.open('', '_blank', 'width=450,height=400');
        win.document.write(html);
        win.document.close();
        if(loading) loading.classList.add('hidden');
    }).catch(err => {
        if(loading) loading.classList.add('hidden');
        Swal.fire('Error', 'Gagal cetak kartu: ' + err.message, 'error');
    });
}
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(initNotificationListener, 2000);
});

// --- FUNGSI BARU: BUKA AKSES (UNLOCK) SISWA CURANG ---
function unlockExamAttempt(responseId, studentName) {
    Swal.fire({
        title: 'Buka Akses Ujian?',
        html: `Apakah Anda yakin ingin membuka akses untuk siswa <b>${studentName}</b>?<br><br>Status akan diubah menjadi 'Mengerjakan' dan siswa dapat melanjutkan ujian dengan jawaban yang tersimpan.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#0d9488',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Ya, Buka Akses',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            // Ambil Key dari ResponseID
            database.ref('Responses').orderByChild('ResponseID').equalTo(responseId).once('value').then(snap => {
                let key = null;
                snap.forEach(c => { key = c.key; });
                
                if (key) {
                    // Update Status jadi 'Mengerjakan' & Reset Pelanggaran
                    // Jawaban (Answers) TIDAK DIHAPUS agar siswa bisa lanjut
                    return database.ref('Responses/' + key).update({
                        Status: 'Mengerjakan',
                        Violations: 0
                    });
                } else {
                    // Fallback scan manual jika index bermasalah
                    return database.ref('Responses').once('value').then(allSnap => {
                         let foundKey = null;
                         allSnap.forEach(c => {
                             if (c.val().ResponseID === responseId || c.key === responseId) foundKey = c.key;
                         });
                         if(foundKey) {
                             return database.ref('Responses/' + foundKey).update({
                                 Status: 'Mengerjakan',
                                 Violations: 0
                             });
                         } else {
                             throw new Error('Data respon tidak ditemukan.');
                         }
                    });
                }
            }).then(() => {
                Swal.fire('Berhasil!', `Akses ujian untuk ${studentName} telah dibuka.`, 'success');
                // Refresh Tabel
                const currentExamId = document.getElementById('select-result-exam').value;
                if(currentExamId) loadResultsTable(currentExamId);
            }).catch(err => {
                Swal.fire('Gagal', err.message, 'error');
            });
        }
    });
}

// --- FUNGSI TAMBAHAN: RESET UJIAN (JIKA BELUM ADA) ---
// Note: Ini hanya untuk memastikan fungsi reset tersedia jika sebelumnya tidak ketemu
if (typeof resetExamAttempt === 'undefined') {
    window.resetExamAttempt = function(responseId, studentName) {
        Swal.fire({
            title: 'Reset Ujian?',
            text: `Hapus data jawaban ${studentName}? Siswa harus ujian dari awal.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Ya, Hapus!',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                database.ref('Responses').orderByChild('ResponseID').equalTo(responseId).once('value').then(snap => {
                    const promises = [];
                    snap.forEach(c => { promises.push(c.ref.remove()); });
                    if(promises.length === 0) {
                         // Fallback scan
                         return database.ref('Responses').once('value').then(allSnap => {
                             allSnap.forEach(c => {
                                 if (c.val().ResponseID === responseId || c.key === responseId) c.ref.remove();
                             });
                         });
                    }
                    return Promise.all(promises);
                }).then(() => {
                    Swal.fire('Terhapus!', 'Data ujian telah direset.', 'success');
                     const currentExamId = document.getElementById('select-result-exam').value;
                     if(currentExamId) loadResultsTable(currentExamId);
                });
            }
        });
    };
}
</script>
<script>
// --- AUTO-LOAD KONFIGURASI DARI FIREBASE SAAT HALAMAN DIMUAT ---
document.addEventListener('DOMContentLoaded', function() {
  if (typeof database !== 'undefined') {
    database.ref('AppConfig').once('value').then(function(snapshot) {
      var cfg = snapshot.val() || {};
      if (cfg.app_name) {
        document.getElementById('login-title').innerText = cfg.app_name;
        var adminH = document.getElementById('admin-header-title');
        if (adminH) adminH.innerText = cfg.app_name;
        document.title = cfg.app_name;
      }
      if (cfg.app_subtitle) {
        document.getElementById('login-subtitle').innerText = cfg.app_subtitle;
      }
      if (cfg.app_logo) {
        document.getElementById('login-logo-img').src = cfg.app_logo;
      }
      if (cfg.app_background) {
        document.getElementById('page-login').style.backgroundImage = "url('" + cfg.app_background + "')";
      }
    });
  }
});
</script>
</body>
</html>
  
